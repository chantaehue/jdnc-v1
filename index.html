<!DOCTYPE html>
<html lang="ko">

<head>
    <script>
        // [Security] Auth Guard
        // Check local storage immediately. If no user, redirect to login.
        (function () {
            const user = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            if (!user) {
                window.location.replace('login.html');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GreenGuard - í†µí•© ì˜¨ì‹¤ ëª¨ë‹ˆí„°ë§ ì†”ë£¨ì…˜</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Leaflet Map (Free Alternative to Google Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css?v=fix4">
    <!-- [Critical Fix] Limit mobile.css to mobile devices only -->
    <link rel="stylesheet" href="mobile.css?v=fix4" media="(max-width: 768px)">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i data-lucide="leaf"></i>
                <span>GreenGuard</span>
            </div>
            <nav>
                <a href="#" class="nav-item active" data-page="dashboard" data-mode="basic"
                    onclick="openPage('dashboard'); return false;">
                    <i data-lucide="layout-dashboard"></i>
                    <span>Basic Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="dashboard" data-mode="premium"
                    onclick="openPage('dashboard'); return false;">
                    <i data-lucide="crown"></i>
                    <span>Premium Dashboard</span>
                </a>
                <a href="#" class="nav-item" data-page="control"
                    onclick="alert('ğŸš§ ì›ê²© ì œì–´ ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ ì¤‘ì…ë‹ˆë‹¤.'); return false;">
                    <i data-lucide="toggle-right"></i>
                    <span>ì›ê²© ì œì–´</span>
                </a>

                <a href="#" class="nav-item" data-page="ai-solution" onclick="openPage('ai-solution'); return false;">
                    <i data-lucide="sparkles"></i>
                    <span>AI ì‘ë¬¼ ë¶„ì„ ì†”ë£¨ì…˜</span>
                </a>
                <!-- [Security] Admin Only Menu - Hidden by default, shown via JS for admin users -->
                <a href="#" class="nav-item hidden" data-page="admin" id="admin-nav-item"
                    onclick="openAdminPage(); return false;">
                    <i data-lucide="map-pin"></i>
                    <span>ê´€ë¦¬ì ëª¨ë“œ</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="avatar"></div>
                    <div class="user-info">
                        <p class="name" id="user-name">ì‚¬ìš©ì</p>
                        <p class="role" id="user-farm">ë‚´ ìŠ¤ë§ˆíŠ¸íŒœ</p>
                        <p id="db-connection-status" style="font-size:0.7em; color:#94a3b8; margin-top:2px;">âšª Local
                            Mode</p>
                    </div>
                </div>
                <button class="logout-btn" id="logout-btn" title="ë¡œê·¸ì•„ì›ƒ">
                    <i data-lucide="log-out"></i>
                    <span>ë¡œê·¸ì•„ì›ƒ</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content-area">
            <header class="top-bar">
                <div class="search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                </div>
                <div class="top-actions">
                    <div class="weather-info">
                        <i data-lucide="sun"></i>
                        <span>24Â°C ë§‘ìŒ</span>
                    </div>
                    <button class="icon-btn">
                        <i data-lucide="bell"></i>
                        <span class="badge"></span>
                    </button>
                    <button class="icon-btn">
                        <i data-lucide="settings"></i>
                    </button>
                </div>
            </header>

            <div id="content-area" class="content-area">
                <!-- Dashboard Page -->
                <section id="dashboard-page" class="page active">
                    <div class="page-header">
                        <h1>ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</h1>
                        <p>í˜„ì¬ ì˜¨ì‹¤ì˜ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- [NEW] ê³µì§€ì‚¬í•­ í‘œì‹œ ì˜ì—­ -->
                    <div id="dashboard-notice" class="dashboard-notice glass hidden">
                        <div class="notice-header">
                            <i data-lucide="bell"></i>
                            <span class="notice-title-display">ê³µì§€ì‚¬í•­</span>
                            <button class="notice-close-btn" id="close-notice-btn">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="notice-body" id="notice-body-content">
                            <!-- ê³µì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <div class="grid-container">
                        <!-- Outdoor Status Card (NEW) -->
                        <div class="stat-card glass outdoor-card">
                            <div class="card-header">
                                <span class="badge-outdoor">EXTERNAL</span>
                                <h3>ì™¸ë¶€ í™˜ê²½ (ì‹¤ì‹œê°„)</h3>
                            </div>
                            <div class="outdoor-grid">
                                <div class="outdoor-item">
                                    <i data-lucide="thermometer-sun"></i>
                                    <div class="outdoor-info">
                                        <p>ì‹¤ì™¸ ì˜¨ë„</p>
                                        <span id="out-temp">--</span>Â°C
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="droplets"></i>
                                    <div class="outdoor-info">
                                        <p>ì‹¤ì™¸ ìŠµë„</p>
                                        <span id="out-hum">--</span>%
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="wind"></i>
                                    <div class="outdoor-info">
                                        <p>í’ì†</p>
                                        <span id="out-wind">--</span> km/h
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="cloud-rain"></i>
                                    <div class="outdoor-info">
                                        <p>ê°•ìˆ˜ í™•ë¥ </p>
                                        <span id="out-rain">--</span>%
                                    </div>
                                </div>
                            </div>
                            <div class="location-info">
                                <i data-lucide="map-pin"></i>
                                <span id="current-location">ì„œìš¸ (ê¸°ë³¸ê°’)</span>
                            </div>
                            <div class="outdoor-actions">
                                <button class="location-btn" id="get-my-location-btn">
                                    <i data-lucide="navigation"></i>
                                    ë‚´ ìœ„ì¹˜ ë‚ ì”¨
                                </button>
                                <!-- Data Analysis Button Removed as requested -->
                            </div>
                        </div>

                        <!-- Manual Data Entry Section (Moved to first position) -->
                        <div class="manual-entry glass">
                            <div class="entry-header">
                                <div>
                                    <h3>ì˜¨ì‹¤ ë‚´ë¶€ ì •ë³´ ì…ë ¥</h3>
                                    <p class="section-desc">í˜„ì¬ ì˜¨ì‹¤ì˜ ì‹¤ì¸¡ ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì‹œìŠ¤í…œì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</p>
                                </div>
                                <div class="crop-selector-group">
                                    <div class="selector-item">
                                        <label for="select-crop">ëŒ€ìƒ ì‘ë¬¼</label>
                                        <select id="select-crop">
                                            <option value="strawberry">ë”¸ê¸°</option>
                                            <option value="tomato">í† ë§ˆí† </option>
                                            <option value="lettuce">ìƒì¶”</option>
                                            <option value="cucumber">ì˜¤ì´</option>
                                            <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                                            <option value="eggplant">ê°€ì§€</option>
                                            <option value="leafy">ì—½ì±„ë¥˜</option>
                                            <option value="melon">ë©œë¡ </option>
                                        </select>
                                    </div>
                                    <div class="selector-item">
                                        <label for="select-standard">ì–‘ì•¡ í‘œì¤€ ê¸°ì¤€</label>
                                        <select id="select-standard">
                                            <option value="domestic">êµ­ë‚´ í‘œì¤€ (K-Farm)</option>
                                            <option value="international">êµ­ì œ í‘œì¤€ (Wageningen)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <form id="manual-data-form" class="entry-form-advanced">
                                <!-- Group 1: Environment -->
                                <div class="form-section">
                                    <h5>í™˜ê²½ ì •ë³´</h5>
                                    <div class="section-inputs">
                                        <div class="input-group">
                                            <label>ëŒ€ê¸° ì˜¨ë„ (Â°C)</label>
                                            <input type="number" id="input-temp" step="0.1" placeholder="25.4">
                                        </div>
                                        <div class="input-group">
                                            <label>ìŠµë„ (%)</label>
                                            <input type="number" id="input-hum" step="1" placeholder="60">
                                        </div>
                                        <div class="input-group">
                                            <label>ê´‘ë„ (lux)</label>
                                            <input type="number" id="input-light" step="100" placeholder="15000">
                                        </div>
                                        <div class="input-group">
                                            <label>CO2 (ppm)</label>
                                            <input type="number" id="input-co2" step="10" placeholder="400">
                                        </div>
                                        <div class="input-group">
                                            <label>ì—½ì˜¨ë„ (Â°C)</label>
                                            <input type="number" id="input-leaf-temp" step="0.1" placeholder="24.3">
                                        </div>
                                    </div>
                                </div>

                                <!-- Group 2: Nutrient (Premium) -->
                                <div class="form-section premium-only hidden">
                                    <div class="nutrient-header">
                                        <h5>ì–‘ì•¡ ì •ë³´ (ê³µê¸‰ / ê·¼ê¶Œ / ë°°ì•¡)</h5>
                                        <div class="nutrient-selectors">
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-crop-select">ì‘ë¬¼</label>
                                                <select id="nutrient-crop-select">
                                                    <option value="strawberry">ë”¸ê¸°</option>
                                                    <option value="tomato">í† ë§ˆí† </option>
                                                    <option value="lettuce">ìƒì¶”</option>
                                                    <option value="cucumber">ì˜¤ì´</option>
                                                    <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                                                    <option value="eggplant">ê°€ì§€</option>
                                                    <option value="leafy">ì—½ì±„ë¥˜</option>
                                                    <option value="melon">ë©œë¡ </option>
                                                </select>
                                            </div>
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-stage-select">ìƒìœ¡ ë‹¨ê³„</label>
                                                <select id="nutrient-stage-select">
                                                    <option value="planting">ì •ì‹ê¸° (Planting)</option>
                                                    <option value="vegetative">ì˜ì–‘ ìƒì¥ê¸° (Vegetative)</option>
                                                    <option value="flowering">ê°œí™”ê¸° (Flowering)</option>
                                                    <option value="fruiting">ê³¼ì‹¤ ë¹„ëŒ€ê¸° (Fruiting)</option>
                                                    <option value="harvest">ìˆ˜í™•ê¸° (Harvest)</option>
                                                    <option value="late">ìˆ˜í™• í›„ê¸° (Late)</option>
                                                </select>
                                            </div>
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-standard-select">í‘œì¤€</label>
                                                <select id="nutrient-standard-select">
                                                    <!-- Dynamic Options -->
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="section-inputs-nutrient">
                                        <div class="nutrient-sub-group">
                                            <p>ê³µê¸‰ (In)</p>
                                            <input type="number" id="input-in-ec" step="0.1" placeholder="EC 1.8">
                                            <input type="number" id="input-in-ph" step="0.1" placeholder="pH 5.8">
                                        </div>
                                        <div class="nutrient-sub-group">
                                            <p>ê·¼ê¶Œ (Root)</p>
                                            <input type="number" id="input-root-ec" step="0.1" placeholder="EC 2.2">
                                            <input type="number" id="input-root-ph" step="0.1" placeholder="pH 6.2">
                                            <input type="number" id="input-root-temp" step="0.1"
                                                placeholder="Temp 20.5">
                                            <input type="number" id="input-root-hum" step="1" placeholder="Hum 70">
                                        </div>
                                        <div class="nutrient-sub-group">
                                            <p>ë°°ì•¡ (Drain)</p>
                                            <input type="number" id="input-drain-ec" step="0.1" placeholder="EC 2.0">
                                            <input type="number" id="input-drain-ph" step="0.1" placeholder="pH 6.5">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="submit-btn full-width">í†µí•© ë¶„ì„ ë° ë°ì´í„° ë°˜ì˜</button>
                            </form>

                            <!-- Nutrient Solution Results -->
                            <div id="nutrient-solution-card" class="nutrient-solution-card glass hidden">
                                <div class="solution-header">
                                    <h4>ì–‘ì•¡ ë¶„ì„ ê²°ê³¼</h4>
                                    <div class="solution-status">
                                        <span class="status-badge" id="nutrient-status-badge">ë¶„ì„ ëŒ€ê¸°</span>
                                        <span class="target-info" id="nutrient-target-info">ëª©í‘œê°’ì„ í™•ì¸í•˜ì„¸ìš”</span>
                                    </div>
                                </div>
                                <ul class="solution-list" id="nutrient-solution-list">
                                    <li class="no-solution">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</li>
                                </ul>
                            </div>

                            <div id="premium-banner" class="premium-banner mt-4">
                                <div class="banner-content">
                                    <i data-lucide="sparkles"></i>
                                    <div>
                                        <h4>ì–‘ì•¡ ì •ë°€ ë¶„ì„ ì„œë¹„ìŠ¤ í™œì„±í™”</h4>
                                        <p>EC, pH ì •ë³´ë¥¼ ì¶”ê°€ ì…ë ¥í•˜ì—¬ ì˜ì–‘ ê· í˜• ì†”ë£¨ì…˜ì„ ë°›ì•„ë³´ì„¸ìš”.</p>
                                    </div>
                                </div>
                                <button id="unlock-premium-btn" class="unlock-btn">ìœ ë£Œ ì„œë¹„ìŠ¤ í™œì„±í™”</button>
                            </div>
                        </div>
                    </div>

                    <!-- Harvest Info Registration Section -->
                    <div class="yield-input-section glass full-width">
                        <div class="yield-header">
                            <div class="header-left">
                                <i data-lucide="map-pin" class="header-icon"></i>
                                <div>
                                    <h3>ìˆ˜í™•ëŸ‰ ë“±ë¡ ë° ì‹œì„¸ ì¡°íšŒ</h3>
                                    <p class="section-desc">ìˆ˜í™•ëŸ‰ì„ ì§€ë„ì— ë“±ë¡í•˜ê³  ì‹¤ì‹œê°„ ì˜ˆìƒ ìˆ˜ìµì„ í™•ì¸í•˜ì„¸ìš”.</p>
                                </div>
                            </div>
                        </div>

                        <div class="yield-input-container">
                            <div class="yield-input-group">
                                <label for="market-crop-select">
                                    <i data-lucide="sprout"></i>
                                    ì‘ë¬¼ ì„ íƒ
                                </label>
                                <select id="market-crop-select" class="yield-select">
                                    <option value="strawberry">ë”¸ê¸°</option>
                                    <option value="tomato">í† ë§ˆí† </option>
                                    <option value="lettuce">ìƒì¶”</option>
                                    <option value="cucumber">ì˜¤ì´</option>
                                    <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                                    <option value="eggplant">ê°€ì§€</option>
                                    <option value="leafy">ì—½ì±„ë¥˜</option>
                                    <option value="melon">ë©œë¡ </option>
                                </select>
                            </div>

                            <div class="yield-input-group">
                                <label for="yield-amount">
                                    <i data-lucide="package"></i>
                                    ì˜ˆìƒ ìˆ˜í™•ëŸ‰
                                </label>
                                <div class="input-with-unit">
                                    <input type="number" id="yield-amount" placeholder="100" min="0" step="1">
                                    <span class="unit">kg</span>
                                </div>
                            </div>

                            <!-- Register Button -->
                            <button id="register-map-btn" class="analyze-btn">
                                <i data-lucide="search"></i>
                                ì‹œì„¸ ì¡°íšŒ
                            </button>
                        </div>

                        <!-- Revenue Result (Initially Hidden or Updated via JS) -->
                        <div class="revenue-predictions hidden" id="revenue-predictions">
                            <div class="revenue-card wholesale-revenue">
                                <div class="revenue-label">
                                    <i data-lucide="store"></i>
                                    ë„ë§¤ ì˜ˆìƒ ìˆ˜ì…
                                </div>
                                <div class="revenue-value" id="wholesale-revenue">--</div>
                            </div>
                            <div class="revenue-card retail-revenue">
                                <div class="revenue-label">
                                    <i data-lucide="shopping-cart"></i>
                                    ì†Œë§¤ ì˜ˆìƒ ìˆ˜ì…
                                </div>
                                <div class="revenue-value" id="retail-revenue">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Price Analysis Section [NEW] -->
                    <div class="market-section glass full-width">
                        <div class="section-header">
                            <div class="header-left">
                                <i data-lucide="trending-up" class="header-icon"></i>
                                <div>
                                    <h3>ì‹¤ì‹œê°„ ì‹œì¥ ì‹œì„¸ ë¶„ì„</h3>
                                    <p class="section-desc">í˜„ì¬ ì‘ë¬¼ì˜ ë„/ì†Œë§¤ ê°€ê²© ë™í–¥ ë° ê¸°ê°„ë³„ ì‹œì„¸ ì¶”ì´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="market-controls">
                                <div class="period-tabs">
                                    <button class="active" data-period="week">1ì£¼ì¼</button>
                                    <button data-period="month">1ê°œì›”</button>
                                    <button data-period="year">1ë…„</button>
                                </div>
                            </div>
                        </div>

                        <div class="market-grid">
                            <div class="price-cards">
                                <div class="price-card wholesale">
                                    <div class="pc-header">ê°€ë½ì‹œì¥ (ë„ë§¤)</div>
                                    <div class="pc-body">
                                        <div class="price-item">
                                            <span>ìµœê³ ê°€</span>
                                            <b id="wholesale-max">--</b>
                                        </div>
                                        <div class="price-item main">
                                            <span>í‰ê· ê°€</span>
                                            <b id="wholesale-avg">--</b>
                                        </div>
                                        <div class="price-item">
                                            <span>ìµœì €ê°€</span>
                                            <b id="wholesale-min">--</b>
                                        </div>
                                    </div>
                                </div>
                                <div class="price-card retail">
                                    <div class="pc-header">ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ (ì†Œë§¤)</div>
                                    <div class="pc-body">
                                        <div class="price-item">
                                            <span>ìµœê³ ê°€</span>
                                            <b id="retail-max">--</b>
                                        </div>
                                        <div class="price-item main">
                                            <span>í‰ê· ê°€</span>
                                            <b id="retail-avg">--</b>
                                        </div>
                                        <div class="price-item">
                                            <span>ìµœì €ê°€</span>
                                            <b id="retail-min">--</b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="market-chart-container">
                                <canvas id="marketChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chart Area (External Environment Data) -->
                    <div class="chart-container glass hidden" id="outdoor-chart-container">
                        <div class="chart-header">
                            <h3>ì™¸ë¶€ í™˜ê²½ ë°ì´í„° ë¶„ì„ (ì˜¨ë„ ë° ìŠµë„ ì¶”ì´)</h3>
                            <div class="chart-actions">
                                <button class="active">24ì‹œê°„</button>
                                <button>7ì¼</button>
                                <button>30ì¼</button>
                            </div>
                        </div>
                        <canvas id="mainChart"></canvas>
                    </div>

                    <!-- Right Panel: Remote Controls Quick View -->
                    <div class="quick-control glass">
                        <h3>ê°„í¸ ì œì–´</h3>
                        <div class="control-list">
                            <div class="control-item">
                                <div class="info">
                                    <i data-lucide="fan"></i>
                                    <span>í™˜ê¸°íŒ¬</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="control-item">
                                <div class="info">
                                    <i data-lucide="droplet"></i>
                                    <span>ìë™ ê´€ìˆ˜</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox">
                                    <span class="slider round"></span>
                                </label>
                            </div>
                            <div class="control-item">
                                <div class="info">
                                    <i data-lucide="lightbulb"></i>
                                    <span>ì‹ë¬¼ ì„±ì¥ë“±</span>
                                </div>
                                <label class="switch">
                                    <input type="checkbox" checked>
                                    <span class="slider round"></span>
                                </label>
                            </div>
                        </div>
                        <button class="primary-btn mt-4 show-control-page">ëª¨ë“  ì œì–´ ë³´ê¸°</button>
                    </div>

            </div>
    </div>
    </section>

    <!-- AI Solution Page (Hidden by default) -->
    <section id="ai-solution-page" class="page">
        <div class="page-header">
            <h1>AI ì‘ë¬¼ ë¶„ì„ ì†”ë£¨ì…˜</h1>
            <p>ë”¥ëŸ¬ë‹ Vision AIê°€ ì‘ë¬¼ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë³‘í•´ì¶© ì§„ë‹¨ ë° ì²˜ë°©ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
        </div>

        <div class="ai-grid">
            <!-- [New] AI Image Diagnosis Section -->
            <div class="glass ai-diagnosis-container" style="grid-column: 1 / -1;">
                <div class="diagnosis-header">
                    <h2>ğŸ“¸ AI ë³‘í•´ì¶© ì´ë¯¸ì§€ ì§„ë‹¨</h2>
                    <span class="badge premium">PREMIUM</span>
                </div>

                <div class="upload-area" id="drop-zone">
                    <input type="file" id="crop-image-input" accept="image/*" hidden>
                    <div class="upload-placeholder" id="upload-placeholder">
                        <i data-lucide="camera" style="font-size: 48px; color: #10b981; margin-bottom: 15px;"></i>
                        <p>í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜<br>ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒí•˜ì„¸ìš”</p>
                        <button class="upload-btn">ì‚¬ì§„ ì—…ë¡œë“œ</button>
                    </div>
                    <div class="image-preview hidden" id="image-preview-area">
                        <img id="preview-img" src="" alt="Crop Preview">
                        <button class="remove-img-btn" id="remove-img-btn"><i data-lucide="x"></i></button>
                    </div>
                </div>

                <div class="analysis-controls hidden" id="analysis-controls">
                    <div class="crop-type-select">
                        <label>ì‘ë¬¼ ì¢…ë¥˜ (ìë™ ê°ì§€ë¨)</label>
                        <select id="diagnosis-crop-type">
                            <option value="strawberry">ë”¸ê¸°</option>
                            <option value="tomato">í† ë§ˆí† </option>
                            <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                            <option value="cucumber">ì˜¤ì´</option>
                            <option value="lettuce">ìƒì¶”</option>
                        </select>
                    </div>
                    <button class="primary-btn full-width" id="start-analysis-btn">
                        <i data-lucide="scan-line"></i> AI ì •ë°€ ì§„ë‹¨ ì‹œì‘
                    </button>
                </div>

                <!-- Analysis Loading -->
                <div class="analysis-loading hidden" id="analysis-loading">
                    <div class="scanner-animation"></div>
                    <p id="loading-text">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="analysis-progress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Analysis Result -->
                <div class="analysis-result hidden" id="analysis-result">
                    <div class="result-header">
                        <div class="diagnosis-score">
                            <span class="label">ì§„ë‹¨ ê²°ê³¼</span>
                            <h3 id="result-title">í°ê°€ë£¨ë³‘ (Powdery Mildew)</h3>
                        </div>
                        <div class="confidence-badge" id="result-confidence">
                            ì •í™•ë„ 98.2%
                        </div>
                    </div>

                    <div class="result-details">
                        <div class="detail-item">
                            <span class="icon">ğŸ”</span>
                            <div class="info">
                                <strong>ì¦ìƒ (Symptom)</strong>
                                <p id="result-symptom">ì í‘œë©´ì— ë°€ê°€ë£¨ë¥¼ ë¿Œë¦° ë“¯í•œ ë°±ìƒ‰ ë°˜ì ì´ ë°œìƒí•˜ë©° ê´‘í•©ì„±ì„ ì €í•´í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div class="detail-item danger">
                            <span class="icon">ğŸš¨</span>
                            <div class="info">
                                <strong>ìœ„í—˜ë„ (Severity)</strong>
                                <p id="result-severity">ì‹¬ê° (ì¡°ê¸° ë°©ì œ í•„ìš”)</p>
                            </div>
                        </div>
                    </div>

                    <div class="solution-box">
                        <h4>ğŸ’¡ AI ì¶”ì²œ í•´ê²° ë°©ì•ˆ (ê³µê³µë°ì´í„° ì—°ë™)</h4>
                        <ul class="solution-steps" id="result-solutions">
                            <!-- Dynamic Content -->
                        </ul>
                        <div class="chemical-recommendation">
                            <strong>ğŸ’Š ì¶”ì²œ ì•½ì œ (ë†ì´Œì§„í¥ì²­ ê¸°ì¤€)</strong>
                            <p id="result-chemicals">ì ìš© ì•½ì œ: í´ë¦¬ì˜¥ì‹ ë¹„, í˜ë‚˜ë¦¬ëª° ìœ ì œ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Existing Content (Moved down) -->
            <div class="glass ai-card">
                <div class="ai-status healthy">
                    <i data-lucide="check-circle-2"></i>
                    <span>í™˜ê²½ ì œì–´ ìƒíƒœ: ì•„ì£¼ ì¢‹ìŒ</span>
                </div>
                <h2>ì˜¤ëŠ˜ì˜ í™˜ê²½ ì œì–´ ê¶Œì¥ ì‚¬í•­</h2>
                <ul class="recommendation-list">
                    <li><i data-lucide="sun"></i> ì˜¤í›„ 2ì‹œê²½ ì¼ì‚¬ëŸ‰ ì¦ê°€ê°€ ì˜ˆìƒë˜ë¯€ë¡œ ì°¨ê´‘ë§‰ì„ 30% ê°€ë™í•˜ì‹­ì‹œì˜¤.</li>
                    <li><i data-lucide="droplet"></i> í† ì–‘ ìˆ˜ë¶„ ë°ì´í„° ë¶„ì„ ê²°ê³¼, ë‚´ì¼ ì˜¤ì „ 8ì‹œì— ê´€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>
                    <li><i data-lucide="zap"></i> ì—ë„ˆì§€ ì†Œë¹„ íš¨ìœ¨ì„ ìœ„í•´ ì•¼ê°„ ì¡°ëª… ë°ê¸°ë¥¼ 20% ë‚®ì¶”ëŠ” ê²ƒì„ ì œì•ˆí•©ë‹ˆë‹¤.</li>
                </ul>
            </div>
            <div class="glass ai-analysis">
                <h3>ì˜ˆìƒ ìˆ˜í™•ì‹œê¸° ë¶„ì„</h3>
                <div class="prediction-value">D-12 <span>(2026.01.23)</span></div>
                <p>í˜„ì¬ ì„±ì¥ ì†ë„ëŠ” í‰ë…„ ëŒ€ë¹„ 5% ë¹ ë¦…ë‹ˆë‹¤.</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 85%;"></div>
                </div>
                <span class="progress-text">í˜„ì¬ ì„±ì¥ë„: 85%</span>
            </div>
        </div>
    </section>

    <!-- Admin Page (Hidden by default) -->
    <section id="admin-page" class="page">
        <div class="page-header">
            <h1>ê´€ë¦¬ì ëª¨ë“œ</h1>
            <p>ì „ì²´ ë†ì¥ì˜ ìˆ˜í™•ëŸ‰ ì •ë³´ë¥¼ ì§€ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="admin-content">
            <div class="map-container glass">
                <div class="map-header">
                    <h3>ë†ì¥ ìœ„ì¹˜ ì§€ë„</h3>
                    <div class="map-legend">
                        <span class="legend-item">
                            <span class="legend-dot active"></span>
                            ìµœê·¼ ë“±ë¡ (3ì¼ ì´ë‚´)
                        </span>
                    </div>
                </div>
                <div id="google-map"></div>
            </div>

            <div class="farm-list glass">
                <h3>ë“±ë¡ëœ ë†ì¥ ëª©ë¡</h3>
                <div id="farm-cards-container">
                    <p class="no-data">ë“±ë¡ëœ ë†ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- [NEW] ê³µì§€ì‚¬í•­ ì‘ì„± ì„¹ì…˜ -->
            <div class="notice-admin glass">
                <h3><i data-lucide="megaphone"></i> ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                <div class="notice-form">
                    <input type="text" id="notice-title" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" maxlength="50">
                    <textarea id="notice-content" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 5ì¤„)" rows="5"
                        maxlength="500"></textarea>
                    <div class="notice-actions">
                        <button class="notice-save-btn" id="save-notice-btn">
                            <i data-lucide="save"></i> ê³µì§€ ë“±ë¡
                        </button>
                        <button class="notice-clear-btn" id="clear-notice-btn">
                            <i data-lucide="trash-2"></i> ê³µì§€ ì‚­ì œ
                        </button>
                    </div>
                </div>
                <div class="notice-preview">
                    <p class="preview-label">í˜„ì¬ ë“±ë¡ëœ ê³µì§€:</p>
                    <div id="notice-preview-content">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </section>

    <style>
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .ai-card h2 {
            margin: 1.5rem 0 1rem;
            font-size: 1.25rem;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-list li {
            display: flex;
            gap: 1rem;
            align-items: start;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            width: fit-content;
        }

        .ai-status.healthy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary-color);
        }

        .ai-status.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-color);
        }

        .ai-status.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .ai-analysis h3 {
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            height: 12px;
            border-radius: 6px;
            margin: 1.5rem 0 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0;
            transition: width 1s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
    </style>
    </div>
    </main>
    </div>
    <script src="firebase_config.js?v=fix3"></script>
    <script src="auth.js?v=fix3"></script>
    <script src="app.js?v=fix3"></script>
    <script>
        // Start Lucide
        lucide.createIcons();

        // [AUTO LOGIN] Enforce Premium Login as per User Request
        // ì´ ì½”ë“œëŠ” ì‚¬ìš©ìì˜ 'í”„ë¦¬ë¯¸ì—„ ë¡œê·¸ì¸' ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
        if (!localStorage.getItem('smartfarm_user') || JSON.parse(localStorage.getItem('smartfarm_user')).role !== 'premium') {
            const premiumUser = {
                id: 'premium_vip',
                name: 'VIP ë†ë¶€',
                role: 'premium',
                farmName: 'ê³¨ë“œ í´ë˜ìŠ¤ ë†ì¥'
            };
            localStorage.setItem('smartfarm_user', JSON.stringify(premiumUser));
            console.log('âœ… í”„ë¦¬ë¯¸ì—„ ê³„ì •ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì„¤ì •ë¨');
        }

        // [System] Guaranteed Analysis Engine (Embedded)
        document.addEventListener('DOMContentLoaded', () => {
            // [New] Dashboard Mode Switcher (Basic vs Premium)
            const navItems = document.querySelectorAll('.nav-item[data-page="dashboard"]');
            const premiumSection = document.querySelector('.premium-only');
            const mainTitle = document.querySelector('.monitor-header h2');
            const formTitle = document.querySelector('.form-section h5');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    // Check Mode
                    const mode = item.getAttribute('data-mode');

                    // [New] Premium Access Control
                    if (mode === 'premium') {
                        // Check if user is logged in (using localStorage from auth.js)
                        const user = JSON.parse(localStorage.getItem('smartfarm_user'));
                        const isPaidUser = user && (user.role === 'admin' || user.role === 'premium');

                        // If not paid user, block access and explain
                        if (!isPaidUser) {
                            e.preventDefault();
                            alert('ğŸš« í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤.\n\në¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œê±°ë‚˜ ìœ ë£Œ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                            // Optional: Redirect to login or open modal
                            // window.location.href = 'login.html'; 
                            return;
                        }
                    }

                    // [New] Reset Dashboard View on Menu Click
                    // ë©”ë‰´ ì´ë™ ì‹œ ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ 'ê¸°ë³¸ í™”ë©´' ìƒíƒœë¡œ ë¦¬ì…‹
                    const solutionList = document.querySelector('.solution-card-list');
                    const nutrientInfo = document.querySelector('.nutrient-target-info');
                    const nutrientBadge = document.querySelector('.nutrient-status-badge');

                    if (solutionList) {
                        solutionList.innerHTML = `
                            <li style="color: #94a3b8; text-align: center; padding: 30px 10px; font-size: 0.95em;">
                                <div style="margin-bottom: 10px; font-size: 2em; opacity: 0.5;">ğŸ“Š</div>
                                ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  
                                <span style="color:#10b981; font-weight:bold;">[í†µí•© ë¶„ì„ ë° ë°ì´í„° ë°˜ì˜]</span> 
                                ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                            </li>
                        `;
                    }
                    if (nutrientInfo) nutrientInfo.innerHTML = '';
                    if (nutrientBadge) nutrientBadge.style.display = 'none';

                    // [NEW] ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (í¼ ë¦¬ì…‹)
                    const form = document.getElementById('manual-data-form');
                    if (form) form.reset();

                    // [NEW] ì–‘ì•¡ ë¶„ì„ ê²°ê³¼ ì¹´ë“œë„ ì´ˆê¸°í™”
                    const nutrientCard = document.getElementById('nutrient-solution-card');
                    if (nutrientCard) {
                        nutrientCard.classList.add('hidden');
                        const nutrientList = document.getElementById('nutrient-solution-list');
                        if (nutrientList) {
                            nutrientList.innerHTML = '<li class="no-solution">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</li>';
                        }
                    }

                    // [NEW] ìˆ˜í™•ëŸ‰ ì˜ˆì¸¡ ì´ˆê¸°í™”
                    const yieldAmount = document.getElementById('yield-amount');
                    if (yieldAmount) yieldAmount.value = '';
                    const wholesaleRev = document.getElementById('wholesale-revenue');
                    const retailRev = document.getElementById('retail-revenue');
                    if (wholesaleRev) wholesaleRev.textContent = '--';
                    if (retailRev) retailRev.textContent = '--';

                    // 1. Activate Menu
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // 2. Switch Mode UI
                    const premiumSection = document.querySelector('.premium-only');
                    const premiumBanner = document.getElementById('premium-banner');
                    const basicSelectors = document.querySelector('.crop-selector-group'); // Basic selectors
                    const envSection = document.querySelector('.form-section'); // Environment section

                    if (mode === 'premium') {
                        // Premium Mode: Show Nutrient Section, Hide Basic Selectors (to match screenshot)
                        if (premiumSection) {
                            premiumSection.classList.remove('hidden');
                            premiumSection.style.display = 'block';
                        }
                        if (mainTitle) mainTitle.textContent = 'í”„ë¦¬ë¯¸ì—„ ì •ë°€ ê´€ì œ (Premium)';

                        // Hide Basic Selectors to avoid duplication (Premium uses its own crop selector)
                        if (basicSelectors) {
                            basicSelectors.style.display = 'none';
                        }

                        // Hide Banner
                        if (premiumBanner) {
                            premiumBanner.style.display = 'none';
                        }
                    } else {
                        // Basic Mode: Show Basic Selectors, Hide Nutrient Section
                        if (premiumSection) {
                            premiumSection.classList.add('hidden');
                            premiumSection.style.display = 'none';
                        }
                        if (mainTitle) mainTitle.textContent = 'ìŠ¤ë§ˆíŠ¸ íŒœ í†µí•© ê´€ì œ (Basic)';

                        // Show Basic Selectors
                        if (basicSelectors) {
                            basicSelectors.style.display = 'flex';
                        }

                        // Show Banner
                        if (premiumBanner) {
                            premiumBanner.style.display = 'flex';
                        }
                    }
                });
            });

            const form = document.getElementById('manual-data-form');
            if (!form) return;

            // Crop Data for Scientific Analysis
            const cropDB = {
                strawberry: { name: 'ë”¸ê¸°', tempOpt: [17, 23], humOpt: [60, 70], desc: 'ì €ì˜¨ì„± ì‘ë¬¼', ecBase: 1.0 },
                tomato: { name: 'í† ë§ˆí† ', tempOpt: [22, 27], humOpt: [65, 75], desc: 'ê´‘ ìš”êµ¬ë„ ë†’ìŒ', ecBase: 2.5 },
                paprika: { name: 'íŒŒí”„ë¦¬ì¹´', tempOpt: [21, 26], humOpt: [70, 80], desc: 'ì°©ê³¼ê¸° ì˜¨ë„ ê´€ë¦¬ ì¤‘ìš”', ecBase: 2.3 },
                cucumber: { name: 'ì˜¤ì´', tempOpt: [24, 28], humOpt: [75, 85], desc: 'ìˆ˜ë¶„ ìš”êµ¬ë„ ë†’ìŒ', ecBase: 2.2 },
                lettuce: { name: 'ìƒì¶”', tempOpt: [15, 20], humOpt: [60, 70], desc: 'í˜¸ëƒ‰ì„± ì—½ì±„ë¥˜', ecBase: 1.5 },
                eggplant: { name: 'ê°€ì§€', tempOpt: [23, 28], humOpt: [65, 75], desc: 'ê³ ì˜¨ì„± ì‘ë¬¼', ecBase: 2.0 },
                leafy: { name: 'ì—½ì±„ë¥˜', tempOpt: [15, 22], humOpt: [60, 70], desc: 'í˜¸ëƒ‰ì„± ì‘ë¬¼', ecBase: 1.4 },
                melon: { name: 'ë©œë¡ ', tempOpt: [25, 30], humOpt: [60, 70], desc: 'ê³ ì˜¨ ê±´ì¡° ì„ í˜¸', ecBase: 2.1 },
                default: { name: 'ì‘ë¬¼', tempOpt: [20, 25], humOpt: [60, 70], desc: 'í‘œì¤€ ê´€ë¦¬', ecBase: 2.0 }
            };

            form.addEventListener('submit', (e) => {
                e.preventDefault(); // [FIX] í¼ ì œì¶œë¡œ ì¸í•œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë°©ì§€

                console.log("ğŸ”¬ ë¶„ì„ ì‹œì‘...");

                // Wait briefly to allow UI updates, then forcing results
                setTimeout(() => {
                    try {
                        // 1. Acquire Integrated Data
                        const temp = parseFloat(document.getElementById('input-temp').value) || 0;
                        const hum = parseFloat(document.getElementById('input-hum').value) || 0;
                        const light = parseFloat(document.getElementById('input-light')?.value) || 0;
                        const co2 = parseFloat(document.getElementById('input-co2')?.value) || 0;

                        // Premium Nutrient Data
                        const inEC = parseFloat(document.getElementById('input-in-ec')?.value) || 0;
                        const inPH = parseFloat(document.getElementById('input-in-ph')?.value) || 0;
                        const rootEC = parseFloat(document.getElementById('input-root-ec')?.value) || 0;
                        const rootPH = parseFloat(document.getElementById('input-root-ph')?.value) || 0;
                        const drainEC = parseFloat(document.getElementById('input-drain-ec')?.value) || 0;

                        // [Fix] Check Active Mode (Basic vs Premium)
                        const activeNav = document.querySelector('.nav-item.active[data-page="dashboard"]');
                        const currentMode = activeNav ? activeNav.getAttribute('data-mode') : 'basic';

                        console.log("í˜„ì¬ ëª¨ë“œ:", currentMode);

                        // Force Premium if User is in Premium Dashboard (even if inputs are empty)
                        const isNutrientActive = (currentMode === 'premium') || (inEC > 0 || rootEC > 0);

                        console.log("í”„ë¦¬ë¯¸ì—„ ë¶„ì„ í™œì„±í™”:", isNutrientActive);

                        // [FIX] í”„ë¦¬ë¯¸ì—„ ëª¨ë“œì—ì„œëŠ” nutrient-crop-select ì‚¬ìš©
                        let cropSelect = document.getElementById('nutrient-crop-select');
                        if (!cropSelect || currentMode === 'basic') {
                            cropSelect = document.getElementById('select-crop');
                        }
                        const cropKey = cropSelect ? cropSelect.value : 'strawberry';
                        const cropInfo = cropDB[cropKey] || cropDB.default;

                        console.log("ì„ íƒëœ ì‘ë¬¼:", cropInfo.name);

                        // [New] Get Growth Stage
                        const stageSelect = document.getElementById('nutrient-stage-select');
                        const stageKey = stageSelect ? stageSelect.value : 'vegetative';

                        console.log("ìƒìœ¡ ë‹¨ê³„:", stageKey);

                        // [FIX] ë°ì´í„° ê²€ì¦ - ìµœì†Œí•œ ì˜¨ë„ì™€ ìŠµë„ëŠ” ì…ë ¥ë˜ì–´ì•¼ í•¨
                        if (temp === 0 || hum === 0) {
                            alert('âš ï¸ ìµœì†Œí•œ ì˜¨ë„ì™€ ìŠµë„ëŠ” ì…ë ¥í•´ì£¼ì„¸ìš”!');
                            return;
                        }

                        // 2. Scientific Integrated Algorithms
                        // A. VPD Calculation
                        const svp = 0.6108 * Math.exp((17.27 * temp) / (temp + 237.3));
                        const vpd = (svp * (1 - hum / 100)).toFixed(2);

                        // B. Dynamic EC Target with Growth Stage Logic
                        // Base EC by Crop (from DB)
                        let baseEC = cropInfo.ecBase || 2.0;

                        console.log("ì‘ë¬¼ë³„ ê¸°ë³¸ EC:", baseEC, "ì‘ë¬¼:", cropInfo.name);
                        let stageFactor = 0;
                        let stageDesc = '';

                        // Stage-specific Factor (Scientific Rationale)
                        switch (stageKey) {
                            case 'planting':
                                stageFactor = -0.4;
                                stageDesc = 'ì •ì‹ê¸° (í™œì°© ì´‰ì§„ì„ ìœ„í•´ ì €ë†ë„ ê´€ë¦¬)';
                                break;
                            case 'vegetative':
                                stageFactor = -0.2;
                                stageDesc = 'ì˜ì–‘ ìƒì¥ê¸° (ì/ì¤„ê¸° ì„±ì¥ ì¤‘ì‹¬)';
                                break;
                            case 'flowering':
                                stageFactor = 0.0;
                                stageDesc = 'ê°œí™”ê¸° (í™”ì•„ ë¶„í™” ë° ìƒì‹ ìƒì¥ ì „í™˜)';
                                break;
                            case 'fruiting':
                                stageFactor = +0.3;
                                stageDesc = 'ë¹„ëŒ€ê¸° (ê³¼ì‹¤ ë¹„ëŒ€ë¥¼ ìœ„í•œ ê³ ë†ë„ ì–‘ë¶„ ìš”êµ¬)';
                                break;
                            case 'harvest':
                                stageFactor = +0.1;
                                stageDesc = 'ìˆ˜í™•ê¸° (ê· í˜• ì¡íŒ ì–‘ë¶„ ê³µê¸‰)';
                                break;
                            case 'late':
                                stageFactor = -0.1;
                                stageDesc = 'ìˆ˜í™• í›„ê¸° (ì´ˆì„¸ ê´€ë¦¬)';
                                break;
                        }

                        let targetEC = baseEC + stageFactor;
                        let envCompMessage = [];

                        // Environmental Compensation
                        if (temp > 27 || light > 40000) {
                            targetEC -= 0.2;
                            envCompMessage.push('â˜€ï¸ ê³ ì˜¨/ê°•ê´‘ (ìˆ˜ë¶„ í¡ìˆ˜ ì´‰ì§„)');
                        } else if (light < 10000) {
                            targetEC += 0.2;
                            envCompMessage.push('â˜ï¸ ì €ê´‘ (ë„ì¥ ì–µì œ)');
                        }

                        targetEC = targetEC.toFixed(1);

                        // 3. Generate Integrated Report
                        let resultsHTML = '';

                        // [Header Section]
                        if (isNutrientActive) {
                            resultsHTML += `
                                <li style="background: linear-gradient(135deg, #1e1b4b, #312e81); padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #6366f1; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                                    <h4 style="color: #a5b4fc; margin: 0 0 5px 0; font-size: 1.1em;">ğŸ”¬ RTS í†µí•© ì •ë°€ ë¶„ì„ (ìƒìœ¡ ë‹¨ê³„ë³„ ìµœì í™”)</h4>
                                    <div style="font-size: 0.9em; color: #e0e7ff; line-height: 1.4;">
                                        í˜„ì¬ <strong>[${stageDesc.split('(')[0].trim()}]</strong> ë‹¨ê³„ì™€ ì˜¨ì‹¤ í™˜ê²½ì— ë§ì¶° ìµœì  ì œì–´ê°’ì„ ì‚°ì¶œí–ˆìŠµë‹ˆë‹¤.<br>
                                        <div style="margin-top: 8px; display: flex; gap: 10px; flex-wrap: wrap;">
                                            <span style="padding: 5px 10px; background: rgba(99, 102, 241, 0.2); border-radius: 4px; border: 1px solid rgba(99, 102, 241, 0.5);">
                                                ğŸ¯ ëª©í‘œ EC: <strong>${targetEC}dS/m</strong>
                                            </span>
                                            <span style="padding: 5px 10px; background: rgba(16, 185, 129, 0.2); border-radius: 4px; border: 1px solid rgba(16, 185, 129, 0.5);">
                                                ğŸŒ± ë‹¨ê³„ ìš”ì¸: ${stageFactor > 0 ? '+' : ''}${stageFactor}
                                            </span>
                                            <span style="padding: 5px 10px; background: rgba(245, 158, 11, 0.2); border-radius: 4px; border: 1px solid rgba(245, 158, 11, 0.5);">
                                                ğŸŒ¦ï¸ í™˜ê²½ ìš”ì¸: ${envCompMessage.length > 0 ? envCompMessage.join(', ') : 'ë³´ì • ì—†ìŒ'}
                                            </span>
                                        </div>
                                    </div>
                                </li>
                            `;
                        } else {
                            resultsHTML += `<li style="padding:10px; border-bottom:1px solid #333; margin-bottom:10px; color:#adfa1d;"><strong>ğŸŒ¿ BASIC ì˜¨ì‹¤ ì§„ë‹¨</strong> (Premium ëª¨ë“œì—ì„œ ì •ë°€ ë¶„ì„ ê°€ëŠ¥)</li>`;
                        }

                        // [Analysis Content]
                        // 1. Nutrient Interaction (Only Premium)
                        if (isNutrientActive) {
                            console.log("ğŸ’Š ì–‘ì•¡ ë¶„ì„ ì‹œì‘...", { inEC, inPH, rootEC, drainEC });

                            // Check if inputs are strictly empty
                            if (inEC === 0 && rootEC === 0 && drainEC === 0) {
                                resultsHTML += `
                                    <li style="border-left: 4px solid #6366f1; background: rgba(99, 102, 241, 0.1); padding: 12px; border-radius: 4px; margin-bottom: 8px; color: #c4b5fd;">
                                        <strong>â„¹ï¸ ì–‘ì•¡ ë°ì´í„° ì…ë ¥ ëŒ€ê¸°ì¤‘</strong><br>
                                        ê³µê¸‰(In), ê·¼ê¶Œ(Root), ë°°ì•¡(Drain)ì˜ EC/pH ë°ì´í„°ë¥¼ ì…ë ¥í•˜ì‹œë©´<br>
                                        <strong>${stageDesc.split('(')[0]}</strong> ë‹¨ê³„ì— ë§ëŠ” ì •ë°€ ì²˜ë°©ì „ì„ ì œê³µí•©ë‹ˆë‹¤.<br>
                                        <span style="color:#fbbf24;">ğŸ’¡ ìƒë‹¨ ëª©í‘œê°’: EC ${targetEC}dS/m (í˜„ì¬ ì„¤ì •í•´ì•¼ í•  ì ì • ê°€ì´ë“œ)</span>
                                    </li>
                                `;
                            } else {
                                // EC ë¶„ì„
                                if (inEC > 0) {
                                    const ecGap = (inEC - targetEC).toFixed(1);

                                    // Diagnosis based on Integrated Target
                                    if (Math.abs(ecGap) > 0.3) {
                                        const status = ecGap > 0 ? 'ê³¼ë‹¤' : 'ë¶€ì¡±';
                                        const action = ecGap > 0 ? 'ë‚®ì¶”ì„¸ìš”' : 'ë†’ì´ì„¸ìš”';
                                        const color = ecGap > 0 ? '#f59e0b' : '#ef4444';
                                        resultsHTML += `<li style="border-left: 4px solid ${color}; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 4px; margin-bottom: 8px;"><strong style="color: ${color}">âš ï¸ ê¸‰ì•¡ ë†ë„ ${status}</strong><br>ì„¤ì •: <strong>${inEC}</strong> dS/m â†’ ëª©í‘œ: <strong>${targetEC}</strong> dS/m (ì°¨ì´: ${ecGap > 0 ? '+' : ''}${ecGap})<br>í˜„ì¬ [${stageDesc.split('(')[0].trim()}] ë‹¨ê³„ì—ëŠ” EC <strong>${targetEC}</strong> dS/mê°€ ì´ìƒì ì…ë‹ˆë‹¤.<br>ğŸ“ ì¡°ì¹˜: ê¸‰ì•¡ ë†ë„ë¥¼ <strong>${action}</strong></li>`;
                                    } else {
                                        resultsHTML += `<li style="border-left: 4px solid #10b981; background: rgba(0,0,0,0.2); padding: 12px; border-radius: 4px; margin-bottom: 8px;"><strong style="color: #34d399;">âœ… ìƒìœ¡ ë‹¨ê³„ ì í•© ê´€ë¦¬ ì¤‘</strong><br>í˜„ì¬ ê¸‰ì•¡ EC: <strong>${inEC}</strong> dS/m<br>[${stageDesc.split('(')[0].trim()}] ë‹¨ê³„ì— ë§ëŠ” ì ì ˆí•œ EC ë†ë„ë¥¼ ìœ ì§€í•˜ê³  ìˆìŠµë‹ˆë‹¤.</li>`;
                                    }
                                }

                                // Salt Accumulation Check (ê·¼ê¶Œ vs ê¸‰ì•¡)
                                if (rootEC > 0 && inEC > 0) {
                                    const drainDiff = (rootEC - inEC).toFixed(2);
                                    if (drainDiff > 0.5) {
                                        resultsHTML += `<li style="border-left: 4px solid #f43f5e; background: rgba(244, 63, 94, 0.1); padding: 12px; margin-bottom: 8px; border-radius: 4px;"><strong style="color:#f43f5e;">ğŸš¨ ë¿Œë¦¬ ì—¼ë¥˜ ì§‘ì  ê²½ê³ </strong><br>ê·¼ê¶Œ EC(<strong>${rootEC}</strong>) - ê¸‰ì•¡ EC(<strong>${inEC}</strong>) = <strong>+${drainDiff}</strong> dS/m<br>ë¹„ëŒ€ê¸°ë‚˜ ìˆ˜í™•ê¸°ì— í”íˆ ë°œìƒí•˜ëŠ” ì—¼ë¥˜ ì§‘ì ì…ë‹ˆë‹¤.<br>ğŸ“ ì¡°ì¹˜: <strong>ë°°ì•¡ë¥ ì„ 30% ì´ìƒ</strong>ìœ¼ë¡œ ë†’ì—¬ ì—¼ë¥˜ë¥¼ ì”»ì–´ë‚´ì„¸ìš”.</li>`;
                                    } else if (drainDiff < -0.3) {
                                        resultsHTML += `<li style="border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); padding: 12px; margin-bottom: 8px; border-radius: 4px;"><strong style="color:#60a5fa;">â„¹ï¸ ê·¼ê¶Œ ë†ë„ ë‚®ìŒ</strong><br>ê·¼ê¶Œ ECê°€ ê¸‰ì•¡ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤ (${drainDiff} dS/m)<br>ë°°ì§€ê°€ ê³¼ìŠµí•˜ê±°ë‚˜ ì‘ë¬¼ í¡ìˆ˜ê°€ ê³¼ë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>`;
                                    }
                                }

                                // ë°°ì•¡ EC ì²´í¬
                                if (drainEC > 0 && inEC > 0) {
                                    const drainGap = (drainEC - inEC).toFixed(2);
                                    if (drainGap > 0.8) {
                                        resultsHTML += `<li style="border-left: 4px solid #fb923c; background: rgba(251, 146, 60, 0.1); padding: 12px; margin-bottom: 8px; border-radius: 4px;"><strong style="color:#fb923c;">âš ï¸ ë°°ì•¡ EC ë†’ìŒ</strong><br>ë°°ì•¡ EC(<strong>${drainEC}</strong>) - ê¸‰ì•¡ EC(<strong>${inEC}</strong>) = <strong>+${drainGap}</strong><br>ë°°ì§€ì— ì—¼ë¥˜ê°€ ì¶•ì ë˜ê³  ìˆìŠµë‹ˆë‹¤. ë°°ì•¡ë¥  ì¦ê°€ê°€ í•„ìš”í•©ë‹ˆë‹¤.</li>`;
                                    }
                                }

                                // pH check (ê¸‰ì•¡)
                                if (inPH > 0) {
                                    if (inPH > 6.3) {
                                        resultsHTML += `<li style="border-left: 4px solid #f59e0b; padding:12px; margin-bottom:8px; border-radius:4px; background: rgba(245, 158, 11, 0.1);"><strong style="color:#fbbf24;">âš ï¸ pH ë†’ìŒ (${inPH})</strong><br>ì² (Fe), ë§ê°„(Mn) ë“± ë¯¸ëŸ‰ì›ì†Œ í¡ìˆ˜ê°€ ì €í•´ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ğŸ“ ì¡°ì¹˜: pHë¥¼ <strong>5.8~6.0</strong>ìœ¼ë¡œ ë‚®ì¶”ì„¸ìš” (í™©ì‚° ë˜ëŠ” ì§ˆì‚° ì²¨ê°€)</li>`;
                                    } else if (inPH < 5.5) {
                                        resultsHTML += `<li style="border-left: 4px solid #f59e0b; padding:12px; margin-bottom:8px; border-radius:4px; background: rgba(245, 158, 11, 0.1);"><strong style="color:#fbbf24;">âš ï¸ pH ë‚®ìŒ (${inPH})</strong><br>ì¹¼ìŠ˜(Ca), ë§ˆê·¸ë„¤ìŠ˜(Mg) í¡ìˆ˜ê°€ ì €í•´ë˜ê³  ë…ì„±ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ğŸ“ ì¡°ì¹˜: pHë¥¼ <strong>5.8~6.0</strong>ìœ¼ë¡œ ë†’ì´ì„¸ìš” (ìˆ˜ì‚°í™”ì¹¼ë¥¨ ì²¨ê°€)</li>`;
                                    } else {
                                        resultsHTML += `<li style="border-left: 4px solid #10b981; padding:12px; margin-bottom:8px; border-radius:4px; background: rgba(16, 185, 129, 0.1);"><strong style="color:#34d399;">âœ… pH ì ì •</strong><br>í˜„ì¬ pH: <strong>${inPH}</strong> (ìµœì  ë²”ìœ„ ë‚´)</li>`;
                                    }
                                }

                                // ê·¼ê¶Œ pH ì²´í¬
                                if (rootPH > 0) {
                                    if (rootPH > 6.5 || rootPH < 5.3) {
                                        resultsHTML += `<li style="border-left: 4px solid #ef4444; padding:12px; margin-bottom:8px; border-radius:4px; background: rgba(239, 68, 68, 0.1);"><strong style="color:#f87171;">ğŸš¨ ê·¼ê¶Œ pH ì´íƒˆ (${rootPH})</strong><br>ë¿Œë¦¬ í™˜ê²½ì˜ pHê°€ ì ì • ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.<br>ğŸ“ ì¡°ì¹˜: ê¸‰ì•¡ pHë¥¼ ì¡°ì •í•˜ì—¬ ê·¼ê¶Œ pHë¥¼ <strong>5.8~6.2</strong> ë²”ìœ„ë¡œ ìœ ë„í•˜ì„¸ìš”.</li>`;
                                    }
                                }
                            }

                            console.log("âœ… ì–‘ì•¡ ë¶„ì„ ì™„ë£Œ");
                        }

                        // 2. Environmental Diagnosis (Common)
                        console.log("ğŸŒ¡ï¸ í™˜ê²½ ì§„ë‹¨ ì‹œì‘...", { temp, hum, light, co2, vpd });

                        resultsHTML += `<div style="margin: 15px 0 10px 0; border-top: 2px solid #374151; padding-top: 15px; color: #e2e8f0; font-size: 1em; font-weight: 600;">ğŸŒ¡ï¸ ì˜¨ì‹¤ í™˜ê²½ ì§„ë‹¨ (${cropInfo.name} ê¸°ì¤€)</div>`;

                        // Temperature
                        if (temp > cropInfo.tempOpt[1]) {
                            const overTemp = (temp - cropInfo.tempOpt[1]).toFixed(1);
                            resultsHTML += `<li style="color:#fca5a5; margin-bottom: 8px; padding: 8px; background: rgba(252, 165, 165, 0.1); border-radius: 6px;">â€¢ ğŸŒ¡ï¸ <strong>ê³ ì˜¨ ê²½ê³  (${temp}Â°C)</strong><br>ì ì • ì˜¨ë„ë³´ë‹¤ <strong>+${overTemp}Â°C</strong> ë†’ìŠµë‹ˆë‹¤. (ê¶Œì¥: ${cropInfo.tempOpt[0]}~${cropInfo.tempOpt[1]}Â°C)<br>ğŸ“ ì¡°ì¹˜: í™˜ê¸°ì°½ ê°œë°©, ìœ ë™íŒ¬ ê°€ë™, ì°¨ê´‘ë§‰ ì‚¬ìš©</li>`;
                        } else if (temp < cropInfo.tempOpt[0]) {
                            const underTemp = (cropInfo.tempOpt[0] - temp).toFixed(1);
                            resultsHTML += `<li style="color:#93c5fd; margin-bottom: 8px; padding: 8px; background: rgba(147, 197, 253, 0.1); border-radius: 6px;">â€¢ ğŸŒ¡ï¸ <strong>ì €ì˜¨ ê²½ê³  (${temp}Â°C)</strong><br>ì ì • ì˜¨ë„ë³´ë‹¤ <strong>-${underTemp}Â°C</strong> ë‚®ìŠµë‹ˆë‹¤. (ê¶Œì¥: ${cropInfo.tempOpt[0]}~${cropInfo.tempOpt[1]}Â°C)<br>ğŸ“ ì¡°ì¹˜: ë‚œë°©ê¸° ê°€ë™, ë³´ì˜¨ ì»¤íŠ¼ ë‹«ê¸°, ì´ì¤‘ í”¼ë³µ ì ê²€</li>`;
                        } else {
                            resultsHTML += `<li style="color:#86efac; margin-bottom: 8px; padding: 8px; background: rgba(134, 239, 172, 0.1); border-radius: 6px;">â€¢ ğŸŒ¡ï¸ <strong>ì˜¨ë„ ìµœì  (${temp}Â°C)</strong><br>${cropInfo.name} ìƒìœ¡ì— ì´ìƒì ì¸ ì˜¨ë„ì…ë‹ˆë‹¤. (ê¶Œì¥: ${cropInfo.tempOpt[0]}~${cropInfo.tempOpt[1]}Â°C)</li>`;
                        }

                        // Humidity
                        if (hum > cropInfo.humOpt[1]) {
                            resultsHTML += `<li style="color:#fca5a5; margin-bottom: 8px; padding: 8px; background: rgba(252, 165, 165, 0.1); border-radius: 6px;">â€¢ ğŸ’§ <strong>ë‹¤ìŠµ (${hum}%)</strong><br>ì ì • ìŠµë„ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤. (ê¶Œì¥: ${cropInfo.humOpt[0]}~${cropInfo.humOpt[1]}%)<br>ğŸ“ ì¡°ì¹˜: í™˜ê¸°, ì œìŠµ, ë³‘í•´ ì˜ˆë°© ê´€ë¦¬</li>`;
                        } else if (hum < cropInfo.humOpt[0]) {
                            resultsHTML += `<li style="color:#fcd34d; margin-bottom: 8px; padding: 8px; background: rgba(252, 211, 77, 0.1); border-radius: 6px;">â€¢ ğŸ’§ <strong>ê±´ì¡° (${hum}%)</strong><br>ì ì • ìŠµë„ë³´ë‹¤ ë‚®ìŠµë‹ˆë‹¤. (ê¶Œì¥: ${cropInfo.humOpt[0]}~${cropInfo.humOpt[1]}%)<br>ğŸ“ ì¡°ì¹˜: ê°€ìŠµ, ì—½ë©´ì‚´ìˆ˜, ì°¨ê´‘</li>`;
                        } else {
                            resultsHTML += `<li style="color:#86efac; margin-bottom: 8px; padding: 8px; background: rgba(134, 239, 172, 0.1); border-radius: 6px;">â€¢ ğŸ’§ <strong>ìŠµë„ ìµœì  (${hum}%)</strong><br>${cropInfo.name}ì— ì í•©í•œ ìŠµë„ì…ë‹ˆë‹¤. (ê¶Œì¥: ${cropInfo.humOpt[0]}~${cropInfo.humOpt[1]}%)</li>`;
                        }

                        // VPD (Vapor Pressure Deficit)
                        if (vpd > 1.6) {
                            resultsHTML += `<li style="color:#fcd34d; margin-bottom: 8px; padding: 8px; background: rgba(252, 211, 77, 0.1); border-radius: 6px;">â€¢ â˜€ï¸ <strong>VPD ë†’ìŒ (${vpd} kPa)</strong><br>ì¦ì‚°ì´ ê³¼ë„í•˜ì—¬ ìˆ˜ë¶„ ìŠ¤íŠ¸ë ˆìŠ¤ ìœ„í—˜<br>ğŸ“ ì¡°ì¹˜: ê°€ìŠµ, ì°¨ê´‘, ì—½ë©´ ì‚´ìˆ˜ë¡œ VPDë¥¼ 0.8~1.2 ë²”ìœ„ë¡œ ì¡°ì ˆ</li>`;
                        } else if (vpd < 0.5) {
                            resultsHTML += `<li style="color:#fca5a5; margin-bottom: 8px; padding: 8px; background: rgba(252, 165, 165, 0.1); border-radius: 6px;">â€¢ ğŸ’§ <strong>VPD ë‚®ìŒ (${vpd} kPa)</strong><br>ì¦ì‚° ë¶€ì¡±, ê³°íŒ¡ì´ë³‘ ë°œìƒ ìœ„í—˜<br>ğŸ“ ì¡°ì¹˜: ì œìŠµ ë‚œë°©, í™˜ê¸°ë¡œ VPDë¥¼ 0.8~1.2 ë²”ìœ„ë¡œ ì¡°ì ˆ</li>`;
                        } else {
                            resultsHTML += `<li style="color:#86efac; margin-bottom: 8px; padding: 8px; background: rgba(134, 239, 172, 0.1); border-radius: 6px;">â€¢ ğŸ’§ <strong>VPD ìµœì  (${vpd} kPa)</strong><br>ê´‘í•©ì„±ê³¼ ì¦ì‚°ì´ ê· í˜•ì„ ì´ë£¨ëŠ” ìµœì  ìƒíƒœì…ë‹ˆë‹¤.</li>`;
                        }

                        // Light (if user inputs)
                        if (light > 0) {
                            if (light < 15000) {
                                resultsHTML += `<li style="color:#fbbf24; margin-bottom: 8px; padding: 8px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">â€¢ â˜ï¸ <strong>ì¼ì¡° ë¶€ì¡± (${light} lux)</strong><br>ê´‘í•©ì„± íš¨ìœ¨ì´ ì €í•˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>ğŸ“ ì¡°ì¹˜: ë³´ê´‘ë“± ì‚¬ìš© (20,000 lux ì´ìƒ ê¶Œì¥)</li>`;
                            } else if (light > 60000) {
                                resultsHTML += `<li style="color:#f87171; margin-bottom: 8px; padding: 8px; background: rgba(248, 113, 113, 0.1); border-radius: 6px;">â€¢ â˜€ï¸ <strong>ê´‘ëŸ‰ ê³¼ë‹¤ (${light} lux)</strong><br>ê´‘ ìŠ¤íŠ¸ë ˆìŠ¤ ë° ì—½ì†Œ í˜„ìƒ ìœ„í—˜<br>ğŸ“ ì¡°ì¹˜: ì°¨ê´‘ë§‰ ê°€ë™ (50,000 lux ì´í•˜ë¡œ ì¡°ì ˆ)</li>`;
                            } else {
                                resultsHTML += `<li style="color:#86efac; margin-bottom: 8px; padding: 8px; background: rgba(134, 239, 172, 0.1); border-radius: 6px;">â€¢ â˜€ï¸ <strong>ê´‘ëŸ‰ ì ì • (${light} lux)</strong><br>ê´‘í•©ì„±ì— ìµœì í™”ëœ ê´‘ë„ì…ë‹ˆë‹¤.</li>`;
                            }
                        }

                        // CO2 (if user inputs)
                        if (co2 > 0) {
                            if (co2 < 400) {
                                resultsHTML += `<li style="color:#fbbf24; margin-bottom: 8px; padding: 8px; background: rgba(251, 191, 36, 0.1); border-radius: 6px;">â€¢ ğŸŒ«ï¸ <strong>CO2 ë¶€ì¡± (${co2} ppm)</strong><br>ê´‘í•©ì„± íš¨ìœ¨ ì €í•˜<br>ğŸ“ ì¡°ì¹˜: CO2 ì‹œë¹„ (1000~1500 ppm ê¶Œì¥)</li>`;
                            } else if (co2 > 2000) {
                                resultsHTML += `<li style="color:#f87171; margin-bottom: 8px; padding: 8px; background: rgba(248, 113, 113, 0.1); border-radius: 6px;">â€¢ ğŸŒ«ï¸ <strong>CO2 ê³¼ë‹¤ (${co2} ppm)</strong><br>ìƒë¦¬ì¥í•´ ìœ„í—˜<br>ğŸ“ ì¡°ì¹˜: í™˜ê¸°í•˜ì—¬ 1500 ppm ì´í•˜ë¡œ ì¡°ì ˆ</li>`;
                            } else {
                                resultsHTML += `<li style="color:#86efac; margin-bottom: 8px; padding: 8px; background: rgba(134, 239, 172, 0.1); border-radius: 6px;">â€¢ ğŸŒ«ï¸ <strong>CO2 ì ì • (${co2} ppm)</strong><br>ê´‘í•©ì„± ì´‰ì§„ì— ìœ ë¦¬í•œ ë†ë„ì…ë‹ˆë‹¤.</li>`;
                            }
                        }

                        console.log("âœ… í™˜ê²½ ì§„ë‹¨ ì™„ë£Œ");

                        // Force Render
                        console.log("ğŸ“Š ê²°ê³¼ ë Œë”ë§ ì‹œì‘...");

                        const card = document.getElementById('nutrient-solution-card');
                        const list = document.getElementById('nutrient-solution-list');
                        const targetInfo = document.getElementById('nutrient-target-info');
                        const badge = document.getElementById('nutrient-status-badge');

                        console.log("ë Œë”ë§ ìš”ì†Œ í™•ì¸:", {
                            card: !!card,
                            list: !!list,
                            targetInfo: !!targetInfo,
                            badge: !!badge
                        });

                        if (card && list) {
                            // ìˆ¨ê¹€ í´ë˜ìŠ¤ ì œê±°
                            card.classList.remove('hidden');

                            // Dynamic Style based on mode
                            const borderColor = isNutrientActive ? '#6366f1' : '#10b981';
                            const bgGradient = isNutrientActive
                                ? 'linear-gradient(135deg, rgba(30, 27, 75, 0.98), rgba(15, 23, 42, 0.98))'
                                : 'linear-gradient(135deg, rgba(15, 23, 42, 0.98), rgba(6, 78, 59, 0.98))';

                            card.style.cssText = `
                                display: block !important; 
                                visibility: visible !important; 
                                opacity: 1 !important; 
                                background: ${bgGradient} !important; 
                                color: white !important; 
                                min-height: 200px; 
                                padding: 25px; 
                                border-radius: 16px; 
                                margin-top: 20px; 
                                border: 2px solid ${borderColor}; 
                                box-shadow: 0 20px 40px rgba(0,0,0,0.6), 0 0 20px ${borderColor}40;
                            `;

                            // ê²°ê³¼ HTML ì‚½ì…
                            list.innerHTML = resultsHTML;
                            console.log("ê²°ê³¼ HTML ê¸¸ì´:", resultsHTML.length);

                            // íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
                            const analysisType = isNutrientActive ? 'RTS í†µí•© ì •ë°€ ë¶„ì„' : 'ê¸°ë³¸ í™˜ê²½ ë¶„ì„';
                            const title = `<strong>${cropInfo.name} ${analysisType} ë¦¬í¬íŠ¸</strong>`;
                            if (targetInfo) {
                                targetInfo.innerHTML = title;
                                targetInfo.style.cssText = 'font-size: 1.2em; color: #e2e8f0;';
                            }

                            // ë±ƒì§€ ì—…ë°ì´íŠ¸
                            if (badge) {
                                badge.textContent = isNutrientActive ? 'ğŸ”¬ AI PREMIUM' : 'ğŸŒ¿ BASIC';
                                badge.className = 'status-badge ' + (isNutrientActive ? 'premium' : 'success');
                                badge.style.cssText = `
                                    display: inline-block !important;
                                    background-color: ${isNutrientActive ? '#4f46e5' : '#10b981'} !important;
                                    color: white !important;
                                    padding: 6px 14px;
                                    border-radius: 20px;
                                    font-size: 0.85em;
                                    font-weight: 700;
                                    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
                                `;
                            }

                            // ìŠ¤í¬ë¡¤ ì• ë‹ˆë©”ì´ì…˜
                            setTimeout(() => {
                                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }, 100);

                            console.log("âœ… ê²°ê³¼ ë Œë”ë§ ì™„ë£Œ!");

                            // ì„±ê³µ ì•Œë¦¼
                            const analysisMsg = isNutrientActive
                                ? `${cropInfo.name} í”„ë¦¬ë¯¸ì—„ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ”¬`
                                : `${cropInfo.name} ê¸°ë³¸ ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸŒ¿`;

                            // ì½˜ì†”ì—ë§Œ í‘œì‹œ (ì‚¬ìš©ì ë°©í•´ ìµœì†Œí™”)
                            console.log("ğŸ“¢", analysisMsg);
                        } else {
                            console.error("âŒ ê²°ê³¼ ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!", { card, list });
                            // alert('âš ï¸ ê²°ê³¼ í‘œì‹œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                        }
                    } catch (e) {
                        console.error("âŒ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ì‚¬ìš©ì ì•Œë¦¼ ì°¨ë‹¨ë¨):", e);
                        // alert('ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + e.message);
                    }
                }, 300);
            });

            // [New] Unlock Premium Membership Feature
            const unlockBtn = document.getElementById('unlock-premium-btn');
            if (unlockBtn) {
                unlockBtn.addEventListener('click', () => {
                    // 1. Check Login
                    const userStr = localStorage.getItem('smartfarm_user');

                    if (!userStr) {
                        // If not logged in, simulate login or ask to login
                        const doLogin = confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ì¦‰ì‹œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                        if (doLogin) {
                            const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                            localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                            alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ Premium Dashboardì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            window.location.reload();
                        }
                        return;
                    }

                    // 2. Process Payment (Simulation)
                    const user = JSON.parse(userStr);
                    if (user.role === 'premium' || user.role === 'admin') {
                        alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš© ì¤‘ì…ë‹ˆë‹¤.');
                        return;
                    }

                    const confirmed = confirm('ğŸ’ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ (ì›” 9,900ì›)\n\nì •ë°€ í™˜ê²½ ì œì–´, ì–‘ì•¡ í†µí•© ë¶„ì„, RTS ì•Œê³ ë¦¬ì¦˜ ë“± ëª¨ë“  ê³ ê¸‰ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');

                    if (confirmed) {
                        // 3. Update Role
                        user.role = 'premium';
                        localStorage.setItem('smartfarm_user', JSON.stringify(user));

                        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’³\n\nì´ì œ [Premium Dashboard]ì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì œí•œ ì—†ì´ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        window.location.reload(); // Reload to reflect changes
                    }
                });
            }
        });
        // [Hotfix] Override Premium Unlock Logic & Auto Redirect
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œìš´ ë¡œì§ì„ ì ìš©í•˜ê¸° ìœ„í•´ ìš”ì†Œ ë³µì œ ë° êµì²´
        const oldUnlockBtn = document.getElementById('unlock-premium-btn');
        if (oldUnlockBtn) {
            const newUnlockBtn = oldUnlockBtn.cloneNode(true);
            oldUnlockBtn.parentNode.replaceChild(newUnlockBtn, oldUnlockBtn);

            newUnlockBtn.addEventListener('click', () => {
                const userStr = localStorage.getItem('smartfarm_user');

                // 1. Not Logged In
                if (!userStr) {
                    const doLogin = confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ì¦‰ì‹œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                    if (doLogin) {
                        const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                        localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                        localStorage.setItem('auto_redirect_premium', 'true');
                        alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤. ğŸš€');
                        window.location.reload();
                    }
                    return;
                }

                // 2. Already Premium
                const user = JSON.parse(userStr);
                if (user.role === 'premium' || user.role === 'admin') {
                    const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                    if (premiumNav) {
                        alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš© ì¤‘ì´ì‹­ë‹ˆë‹¤.\n\n[Premium Dashboard]ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤! ğŸš€');
                        premiumNav.click();
                    }
                    return;
                }

                // 3. Upgrade Payment
                const confirmed = confirm('ğŸ’ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ (ì›” 9,900ì›)\n\nì •ë°€ í™˜ê²½ ì œì–´, ì–‘ì•¡ í†µí•© ë¶„ì„, RTS ì•Œê³ ë¦¬ì¦˜ ë“± ëª¨ë“  ê³ ê¸‰ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (confirmed) {
                    user.role = 'premium';
                    localStorage.setItem('smartfarm_user', JSON.stringify(user));
                    localStorage.setItem('auto_redirect_premium', 'true');
                    alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’³\n\nëª¨ë“  ì œí•œì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.reload();
                }
            });
        }

        // [Auto Redirect System]
        if (localStorage.getItem('auto_redirect_premium') === 'true') {
            localStorage.removeItem('auto_redirect_premium'); // Clear flag
            setTimeout(() => {
                const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                if (premiumNav) {
                    console.log('ğŸš€ Auto Redirecting to Premium Dashboard...');
                    premiumNav.click();
                }
            }, 500);
        }
    </script>
    <!-- [Payment Modal System] -->
    <style>
        /* Payment Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .payment-modal {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            padding: 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: modalFadeIn 0.3s ease-out;
            color: white;
            font-family: 'Pretendard', sans-serif;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-header {
            padding: 25px;
            background: linear-gradient(to right, #6366f1, #4f46e5);
            text-align: center;
        }

        .payment-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-body {
            padding: 30px 25px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-card:hover,
        .plan-card.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        .plan-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #a5b4fc;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .feature-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .payment-footer {
            padding: 20px 25px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .pay-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.6);
        }

        .processing-view {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- PortOne SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <div id="paymentModalOverlay" class="modal-overlay">
        <div class="payment-modal">
            <!-- Step 1: Selection -->
            <div id="paymentStep1">
                <div class="payment-header">
                    <h3>ğŸ’ Premium ë©¤ë²„ì‹­</h3>
                    <p style="margin:5px 0 0 0; opacity:0.8; font-size:0.9em;">ì •ë°€ ë†ì—…ì„ ìœ„í•œ ìµœê³ ì˜ ì„ íƒ</p>
                </div>
                <div class="payment-body">
                    <div class="plan-card selected">
                        <div>
                            <div style="font-weight:bold; font-size:1.1em; color:white;">Month Plan</div>
                            <div style="font-size:0.85em; color:#94a3b8; margin-top:4px;">ë§¤ì›” ìë™ ê²°ì œ</div>
                        </div>
                        <div class="plan-price" style="color:#fcd34d;">â‚©4,900 /ì›” <span
                                style="font-size:0.6em; text-decoration:line-through; color:#64748b;">(â‚©9,900)</span>
                        </div>
                    </div>
                    <ul class="feature-list">
                        <li>âœ… <strong>RTS ê¸°ë°˜</strong> í†µí•© ì •ë°€ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜</li>
                        <li>âœ… ì‘ë¬¼ë³„/ìƒìœ¡ë‹¨ê³„ë³„ <strong>ë§ì¶¤ ì²˜ë°©</strong></li>
                        <li>âœ… <strong>ë¬´ì œí•œ</strong> ë°ì´í„° ì €ì¥ ë° ë¦¬í¬íŠ¸</li>
                        <li>âœ… ìš°ì„  ê¸°ìˆ  ì§€ì› (VIP Support)</li>
                    </ul>
                </div>
                <div class="payment-footer">
                    <button class="pay-btn" id="confirmPaymentBtn">êµ¬ë… ì‹œì‘í•˜ê¸°</button>
                    <button style="background:none; border:none; color:#64748b; margin-top:10px; cursor:pointer;"
                        onclick="document.getElementById('paymentModalOverlay').style.display='none'; const basicNav = document.querySelector('.nav-item[data-mode=\'basic\']'); if(basicNav) basicNav.click();">ë‹«ê¸°</button>
                </div>
            </div>

            <!-- Step 2: Processing -->
            <div id="paymentStep2" class="processing-view">
                <div class="spinner"></div>
                <h4 style="margin:0; font-size:1.2em;">ê²°ì œ ì²˜ë¦¬ ì¤‘...</h4>
                <p style="color:#94a3b8; font-size:0.9em;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>

            <!-- Step 3: Success -->
            <div id="paymentStep3" class="processing-view">
                <div style="font-size:3em; margin-bottom:15px;">ğŸ‰</div>
                <h4 style="margin:0; font-size:1.2em; color:#10b981;">êµ¬ë… ì™„ë£Œ!</h4>
                <p style="color:#94a3b8; font-size:0.9em; text-align:center;">í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    <script>
        // [Final Override] Payment Modal Logic
        // ì´ì „ì˜ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¬´ì‹œí•˜ê³  ëª¨ë‹¬ ë¡œì§ì„ ìµœìš°ì„ ìœ¼ë¡œ ì ìš©í•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                if (btn) {
                    // Remove previous listeners by cloning one last time
                    const finalBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalBtn, btn);

                    finalBtn.addEventListener('click', () => {
                        const userStr = localStorage.getItem('smartfarm_user');

                        // 1. Login Check
                        if (!userStr) {
                            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                                localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                                localStorage.setItem('auto_redirect_premium', 'true');
                                alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            }
                            return;
                        }

                        // 2. Already Premium Check
                        const user = JSON.parse(userStr);
                        if (user.role === 'premium' || user.role === 'admin') {
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) {
                                alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ğŸ’\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                                premiumNav.click();
                            }
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset UI state
                            document.getElementById('paymentStep1').style.display = 'block';
                            document.getElementById('paymentStep2').style.display = 'none';
                            document.getElementById('paymentStep3').style.display = 'none';

                            // Payment Action
                            const payBtn = document.getElementById('confirmPaymentBtn');
                            payBtn.onclick = () => {
                                // Switch to Processing
                                document.getElementById('paymentStep1').style.display = 'none';
                                document.getElementById('paymentStep2').style.display = 'flex';

                                // Simulate API Call (2s)
                                setTimeout(() => {
                                    // Success Layout
                                    document.getElementById('paymentStep2').style.display = 'none';
                                    document.getElementById('paymentStep3').style.display = 'flex';

                                    // Execute Upgrade
                                    user.role = 'premium';
                                    localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                    localStorage.setItem('auto_redirect_premium', 'true');

                                    // Redirect
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                }, 2000);
                            };
                        } else {
                            // Modal not found fallback
                            if (confirm('ê²°ì œ ëª¨ë“ˆ ì˜¤ë¥˜. ê°•ì œ ì—…ê·¸ë ˆì´ë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                user.role = 'premium';
                                localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                window.location.reload();
                            }
                        }
                    });
                }
            }, 200); // Delay to ensure DOM is ready and previous scripts ran
        });
    </script>
    <script>
        // [Real Payment Override] PortOne Integration (Test Mode)
        // ì‹¤ì œ ê²°ì œ ëª¨ë“ˆ(ì•„ì„í¬íŠ¸)ì„ ì—°ë™í•˜ì—¬ PGì‚¬ ê²°ì œì°½ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                const paymentBtn = document.getElementById('confirmPaymentBtn');

                // 4,900ì› ê°€ê²© ë°˜ì˜ í™•ì¸ ë° ê°•ì œ ìˆ˜ì • (í˜¹ì‹œ ì‹¤íŒ¨í–ˆì„ ê²½ìš° ëŒ€ë¹„)
                const priceEls = document.querySelectorAll('.plan-price');
                priceEls.forEach(el => {
                    if (!el.innerHTML.includes('4,900')) {
                        el.innerHTML = 'â‚©4,900 /ì›” <span style="font-size:0.6em; text-decoration:line-through; color:#64748b;">(â‚©9,900)</span>';
                    }
                });
                if (paymentBtn && !paymentBtn.innerText.includes('4,900')) {
                    paymentBtn.innerText = 'êµ¬ë… ì‹œì‘í•˜ê¸° (4,900ì›)';
                }

                if (btn) {
                    // Remove previous listeners (Clone & Replace)
                    const finalRealBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalRealBtn, btn);

                    finalRealBtn.addEventListener('click', () => {
                        const userStr = localStorage.getItem('smartfarm_user');

                        // 1. Login Check
                        if (!userStr) {
                            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                                localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                                localStorage.setItem('auto_redirect_premium', 'true');
                                alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            }
                            return;
                        }

                        // 2. Already Premium Check
                        const user = JSON.parse(userStr);
                        if (user.role === 'premium' || user.role === 'admin') {
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) {
                                alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ğŸ’\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                                premiumNav.click();
                            }
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset UI
                            document.getElementById('paymentStep1').style.display = 'block';
                            document.getElementById('paymentStep2').style.display = 'none';
                            document.getElementById('paymentStep3').style.display = 'none';

                            // 4. Real Payment Action (PortOne)
                            const realPayBtn = document.getElementById('confirmPaymentBtn');
                            realPayBtn.onclick = () => {
                                // Hide Plan
                                document.getElementById('paymentStep1').style.display = 'none';

                                // Check SDK
                                if (!window.IMP) {
                                    alert('ê²°ì œ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                                    window.location.reload();
                                    return;
                                }

                                // Init PortOne
                                const IMP = window.IMP;
                                IMP.init('imp14397622'); // Public Test Code for KG, Kakao

                                // Request Pay
                                IMP.request_pay({
                                    pg: 'html5_inicis', // KG Inicis
                                    pay_method: 'card',
                                    merchant_uid: 'mid_' + new Date().getTime(),
                                    name: 'ìŠ¤ë§ˆíŠ¸íŒœ Premium ì›”ê°„ êµ¬ë… (4,900ì›)',
                                    amount: 4900,
                                    buyer_email: 'test@farm.com',
                                    buyer_name: user.name,
                                    buyer_tel: '010-1234-5678',
                                }, function (rsp) {
                                    if (rsp.success) {
                                        // Success Layout
                                        document.getElementById('paymentStep2').style.display = 'flex';

                                        setTimeout(() => {
                                            // Upgrade
                                            user.role = 'premium';
                                            localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                            localStorage.setItem('auto_redirect_premium', 'true');

                                            // Final Success View
                                            document.getElementById('paymentStep2').style.display = 'none';
                                            document.getElementById('paymentStep3').style.display = 'flex';

                                            // Redirect
                                            setTimeout(() => { window.location.reload(); }, 1500);
                                        }, 1000);
                                    } else {
                                        // Fail
                                        alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
                                        document.getElementById('paymentStep1').style.display = 'block';
                                    }
                                });
                            };
                        }
                    });
                }
            }, 500); // Override all previous logic
        });
    </script>
    <script>
        // [Hotfix] Force Logout Handler
        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ë¥¼ ê°•ì œë¡œ ì¬í• ë‹¹í•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    console.log("Found logout button, attaching force handler.");

                    // Remove existing listeners by cloning
                    const newLogoutBtn = logoutBtn.cloneNode(true);
                    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

                    newLogoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log("Logout clicked.");

                        // 1. Firebase SignOut
                        if (typeof firebase !== 'undefined' && firebase.auth) {
                            firebase.auth().signOut().then(() => {
                                console.log("Firebase signed out successfully.");
                                clearLocalAndRedirect();
                            }).catch((err) => {
                                console.error("Firebase signout failed:", err);
                                clearLocalAndRedirect();
                            });
                        } else {
                            // 2. Local Only
                            clearLocalAndRedirect();
                        }
                    });
                }
            }, 800); // Wait for other scripts to initialize
        });

        function clearLocalAndRedirect() {
            sessionStorage.clear();
            localStorage.removeItem('currentUser');
            // 'users'ëŠ” ì§€ìš°ì§€ ì•ŠìŒ (ë¡œì»¬ ê°€ì… ë°ì´í„° ìœ ì§€)
            window.location.href = 'login.html';
        }
    </script>
    <script>
        // [Final Payment Logic] 
        // ì´ì „ì˜ ê²°ì œ ìŠ¤í¬ë¦½íŠ¸ë“¤ì´ ì˜ëª»ëœ í‚¤(smartfarm_user)ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
        // ê°€ì¥ ë§ˆì§€ë§‰ì— ì‹¤í–‰ë˜ì–´ ì˜¬ë°”ë¥¸ ë¡œì§(currentUser, Firestore ì—°ë™)ìœ¼ë¡œ ë®ì–´ì”Œì›ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                if (btn) {
                    console.log("Applying Final Payment Logic...");
                    const finalBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalBtn, btn);

                    finalBtn.addEventListener('click', () => {
                        // 1. Get User (Standard Key from auth.js)
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');

                        if (!userStr) {
                            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                window.location.href = 'login.html';
                            }
                            return;
                        }

                        const user = JSON.parse(userStr);

                        // 2. Already Premium Check
                        if (user.role === 'premium' || user.role === 'admin') {
                            alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ğŸ’');
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) premiumNav.click();
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset Steps
                            const step1 = document.getElementById('paymentStep1');
                            const step2 = document.getElementById('paymentStep2');
                            const step3 = document.getElementById('paymentStep3');
                            if (step1) step1.style.display = 'block';
                            if (step2) step2.style.display = 'none';
                            if (step3) step3.style.display = 'none';

                            // 4. Handle Payment
                            const payBtn = document.getElementById('confirmPaymentBtn');
                            if (payBtn) {
                                // Ensure price text
                                if (!payBtn.innerText.includes('4,900')) payBtn.innerText = 'êµ¬ë… ì‹œì‘í•˜ê¸° (4,900ì›)';

                                payBtn.onclick = () => {
                                    if (step1) step1.style.display = 'none';

                                    if (!window.IMP) {
                                        alert('ê²°ì œ ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                                        return;
                                    }

                                    const IMP = window.IMP;
                                    IMP.init('imp14397622');

                                    IMP.request_pay({
                                        pg: 'html5_inicis',
                                        pay_method: 'card',
                                        merchant_uid: 'mid_' + new Date().getTime(),
                                        name: 'ìŠ¤ë§ˆíŠ¸íŒœ Premium (4,900ì›)',
                                        amount: 4900,
                                        buyer_email: user.email,
                                        buyer_name: user.name,
                                    }, function (rsp) {
                                        if (rsp.success) {
                                            if (step2) step2.style.display = 'flex'; // Processing...

                                            // Upgrade Logic
                                            setTimeout(() => {
                                                user.role = 'premium';
                                                localStorage.setItem('currentUser', JSON.stringify(user));
                                                if (sessionStorage.getItem('currentUser')) {
                                                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                                                }
                                                // Auto Redirect Flag
                                                localStorage.setItem('auto_redirect_premium', 'true');

                                                // â˜… Firestore Update â˜…
                                                if (typeof firebase !== 'undefined' && firebase.firestore && user.uid) {
                                                    firebase.firestore().collection('users').doc(user.uid).update({
                                                        role: 'premium'
                                                    }).then(() => console.log("DB Updated"));
                                                }

                                                if (step2) step2.style.display = 'none';
                                                if (step3) step3.style.display = 'flex'; // Success

                                                setTimeout(() => { window.location.reload(); }, 1500);
                                            }, 1000);
                                        } else {
                                            alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
                                            if (step1) step1.style.display = 'block';
                                        }
                                    });
                                };
                            }
                        }
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <script>
        // [New] Premium Nav Click -> Auto Trigger Payment
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                const unlockBtn = document.getElementById('unlock-premium-btn');

                if (premiumNav && unlockBtn) {
                    console.log("Attaching Premium Nav Auto-Trigger");
                    premiumNav.addEventListener('click', (e) => {
                        // Check User Role
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                        if (userStr) {
                            const user = JSON.parse(userStr);
                            // If Basic user clicks Premium, trigger the payment modal
                            if (user.role !== 'premium' && user.role !== 'admin') {
                                console.log("Basic User detected on Premium Tab -> Triggering Payment Modal");
                                setTimeout(() => {
                                    unlockBtn.click();
                                }, 300); // Small delay to let tab switch visually update first
                            }
                        }
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <script>
        // [New] Basic Nav Click -> Reset View
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const basicNav = document.querySelector('.nav-item[data-mode="basic"]');
                if (basicNav) {
                    console.log("Attaching Basic Nav View Reset Listener");
                    basicNav.addEventListener('click', (e) => {
                        console.log("Resetting to Basic View...");
                        // Hide Premium Fields
                        document.querySelectorAll('.premium-only').forEach(el => el.classList.add('hidden'));
                        // Relock Cards
                        document.querySelectorAll('.premium-locked').forEach(el => el.classList.remove('unlocked'));
                        // Reset Form Styles
                        document.querySelectorAll('.entry-form').forEach(el => el.classList.remove('premium-active'));

                        // Show Banner if user is Basic
                        const premiumBanner = document.getElementById('premium-banner');
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                        let isPremium = false;
                        if (userStr) {
                            const user = JSON.parse(userStr);
                            if (user.role === 'premium' || user.role === 'admin') isPremium = true;
                        }

                        if (premiumBanner && !isPremium) {
                            premiumBanner.classList.remove('hidden');
                        }

                        // Scroll to Top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item active nav-item" data-page="dashboard" data-mode="basic">
            <i data-lucide="layout-dashboard"></i>
            <span>Basic</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item" data-page="dashboard" data-mode="premium">
            <i data-lucide="crown"></i>
            <span>Premium</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item" data-page="ai-solution">
            <i data-lucide="brain-circuit"></i>
            <span>AI</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item hidden" data-page="admin" id="admin-nav-mobile">
            <i data-lucide="map"></i>
            <span>Map</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="logout()">
            <i data-lucide="log-out"></i>
            <span>Logout</span>
        </a>
    </nav>
</body>

</html>