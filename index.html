<!DOCTYPE html>
<html lang="ko">

<head>
    <script>
        // [Security] Auth Guard
        // Check local storage immediately. If no user, redirect to login.
        (function () {
            const user = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            if (!user) {
                window.location.replace('login.html');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Latest Deployment: 2026-01-13 23:31:00 -->
    <title>JDNC Farm Tech - 통합 온실 모니터링 솔루션</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Leaflet Map (Free Alternative to Google Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css?v=fix4">
    <!-- [Critical Fix] Limit mobile.css to mobile devices only -->
    <link rel="stylesheet" href="mobile.css?v=fix4" media="(max-width: 768px)">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i data-lucide="leaf"></i>
                <span>JDNC<br>Farm Tech</span>
            </div>
            <nav>
                <a href="#" class="nav-item active" data-page="dashboard" data-mode="basic"
                    onclick="openPage('dashboard'); return false;">
                    <i data-lucide="layout-dashboard"></i>
                    <span>베이직 온실</span>
                </a>
                <a href="#" class="nav-item" data-page="dashboard" data-mode="premium"
                    onclick="openPage('dashboard'); return false;">
                    <i data-lucide="crown"></i>
                    <span>양액 재배 온실<br>(스마트팜)</span>
                </a>
                <a href="#" class="nav-item" data-page="control"
                    onclick="alert('🚧 원격 제어 시스템 업그레이드 중입니다.'); return false;">
                    <i data-lucide="toggle-right"></i>
                    <span>원격 제어</span>
                </a>

                <!-- [Security] Admin Only Menu - Hidden by default, shown via JS for admin users -->
                <a href="#" class="nav-item hidden" data-page="admin" id="admin-nav-item"
                    onclick="openAdminPage(); return false;">
                    <i data-lucide="map-pin"></i>
                    <span>관리자 모드</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="avatar"></div>
                    <div class="user-info">
                        <p class="name" id="user-name">사용자</p>
                        <p class="role" id="user-farm">내 스마트팜</p>
                        <p id="db-connection-status" style="font-size:0.7em; color:#94a3b8; margin-top:2px;">⚪ Local
                            Mode</p>
                    </div>
                </div>
                <button class="logout-btn" id="logout-btn" title="로그아웃">
                    <i data-lucide="log-out"></i>
                    <span>로그아웃</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content-area">
            <header class="top-bar">
                <div class="search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" placeholder="검색어를 입력하세요...">
                </div>
                <div class="top-actions">
                    <div class="weather-info">
                        <i data-lucide="sun"></i>
                        <span>24°C 맑음</span>
                    </div>
                    <button class="icon-btn">
                        <i data-lucide="bell"></i>
                        <span class="badge"></span>
                    </button>
                    <button class="icon-btn">
                        <i data-lucide="settings"></i>
                    </button>
                </div>
            </header>

            <div id="content-area" class="content-area">
                <!-- Dashboard Page -->
                <section id="dashboard-page" class="page active">
                    <div class="page-header">
                        <h1>실시간 대시보드</h1>
                        <p>현재 온실의 상태를 실시간으로 모니터링합니다.</p>
                    </div>

                    <!-- [NEW] 공지사항 표시 영역 -->
                    <div id="dashboard-notice" class="dashboard-notice glass hidden">
                        <div class="notice-header">
                            <i data-lucide="bell"></i>
                            <span class="notice-title-display">공지사항</span>
                            <button class="notice-close-btn" id="close-notice-btn">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="notice-body" id="notice-body-content">
                            <!-- 공지 내용이 여기에 표시됩니다 -->
                        </div>
                    </div>

                    <div class="grid-container">
                        <!-- Outdoor Status Card (NEW) -->
                        <div class="stat-card glass outdoor-card">
                            <div class="card-header">
                                <span class="badge-outdoor">EXTERNAL</span>
                                <h3>외부 환경 (실시간)</h3>
                            </div>
                            <div class="outdoor-grid">
                                <div class="outdoor-item">
                                    <i data-lucide="thermometer-sun"></i>
                                    <div class="outdoor-info">
                                        <p>실외 온도</p>
                                        <span id="out-temp">15</span>°C
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="droplets"></i>
                                    <div class="outdoor-info">
                                        <p>실외 습도</p>
                                        <span id="out-hum">65</span>%
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="wind"></i>
                                    <div class="outdoor-info">
                                        <p>풍속</p>
                                        <span id="out-wind">2.5</span> km/h
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="cloud-rain"></i>
                                    <div class="outdoor-info">
                                        <p>강수 확률</p>
                                        <span id="out-rain">20</span>%
                                    </div>
                                </div>
                            </div>
                            <div class="location-info">
                                <i data-lucide="map-pin"></i>
                                <span id="current-location">서울 (기본값)</span>
                            </div>
                            <div class="outdoor-actions">
                                <button 
                                    class="location-btn" 
                                    id="get-my-location-btn" 
                                    type="button"
                                    onclick="console.log('🔘 [HTML onclick] 버튼 클릭 감지!');"
                                    style="cursor: pointer !important; pointer-events: auto !important;">
                                    <i data-lucide="navigation"></i>
                                    내 위치 날씨
                                </button>
                                <!-- Data Analysis Button Removed as requested -->
                            </div>
                        </div>

                        <!-- Manual Data Entry Section (Moved to first position) -->
                        <div class="manual-entry glass">
                            <div class="entry-header">
                                <div>
                                    <h3>온실 내부 정보 입력</h3>
                                    <p class="section-desc">현재 온실의 실측 데이터를 직접 입력하여 시스템을 업데이트합니다.</p>
                                </div>
                                <div class="crop-selector-group">
                                    <div class="selector-item">
                                        <label for="select-crop">대상 작물</label>
                                        <select id="select-crop">
                                            <option value="strawberry">딸기</option>
                                            <option value="tomato">토마토</option>
                                            <option value="lettuce">상추</option>
                                            <option value="cucumber">오이</option>
                                            <option value="paprika">파프리카</option>
                                            <option value="eggplant">가지</option>
                                            <option value="leafy">엽채류</option>
                                            <option value="melon">멜론</option>
                                        </select>
                                    </div>
                                    <div class="selector-item">
                                        <label for="select-standard">양액 표준 기준</label>
                                        <select id="select-standard">
                                            <option value="domestic">국내 표준 (K-Farm)</option>
                                            <option value="international">국제 표준 (Wageningen)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <form id="manual-data-form" class="entry-form-advanced" onsubmit="return false;">
                                <!-- Group 1: Environment -->
                                <div class="form-section">
                                    <h5>환경 정보</h5>
                                    <div class="section-inputs">
                                        <div class="input-group">
                                            <label>대기 온도 (°C)</label>
                                            <input type="number" id="input-temp" step="0.1" placeholder="25.4">
                                        </div>
                                        <div class="input-group">
                                            <label>습도 (%)</label>
                                            <input type="number" id="input-hum" step="1" placeholder="60">
                                        </div>
                                        <div class="input-group">
                                            <label>광도 (lux)</label>
                                            <input type="number" id="input-light" step="100" placeholder="15000">
                                        </div>
                                        <div class="input-group">
                                            <label>CO2 (ppm)</label>
                                            <input type="number" id="input-co2" step="10" placeholder="400">
                                        </div>
                                        <div class="input-group">
                                            <label>엽온도 (°C)</label>
                                            <input type="number" id="input-leaf-temp" step="0.1" placeholder="24.3">
                                        </div>
                                    </div>
                                </div>

                                <!-- 베이직 전용 버튼 (환경 정보만 분석) -->
                                <button 
                                    type="button" 
                                    id="basic-analysis-btn" 
                                    class="submit-btn full-width basic-only"
                                    onclick="showBasicAnalysisResult(); return false;"
                                    style="cursor: pointer !important; pointer-events: auto !important; background: linear-gradient(135deg, #059669 0%, #10b981 100%);">
                                    🌿 온실 데이터 분석 및 작물생육분석
                                </button>

                                <!-- Group 2: Nutrient (Premium) -->
                                <div class="form-section premium-only hidden">
                                    <div class="nutrient-header">
                                        <h5>양액 정보 (공급 / 근권 / 배액)</h5>
                                        <div class="nutrient-selectors">
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-crop-select">작물</label>
                                                <select id="nutrient-crop-select">
                                                    <option value="strawberry">딸기</option>
                                                    <option value="tomato">토마토</option>
                                                    <option value="lettuce">상추</option>
                                                    <option value="cucumber">오이</option>
                                                    <option value="paprika">파프리카</option>
                                                    <option value="eggplant">가지</option>
                                                    <option value="leafy">엽채류</option>
                                                    <option value="melon">멜론</option>
                                                </select>
                                            </div>
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-stage-select">생육 단계</label>
                                                <select id="nutrient-stage-select">
                                                    <option value="planting">정식기 (Planting)</option>
                                                    <option value="vegetative">영양 생장기 (Vegetative)</option>
                                                    <option value="flowering">개화기 (Flowering)</option>
                                                    <option value="fruiting">과실 비대기 (Fruiting)</option>
                                                    <option value="harvest">수확기 (Harvest)</option>
                                                    <option value="late">수확 후기 (Late)</option>
                                                </select>
                                            </div>
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-standard-select">표준</label>
                                                <select id="nutrient-standard-select">
                                                    <option value="yamazaki">야마자키 (Yamazaki)</option>
                                                    <option value="japan_enshi">일본원시 (Japan Enshi)</option>
                                                    <option value="netherlands">네덜란드 (PBG)</option>
                                                    <option value="korea_rda">농진청 (Korea RDA)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="section-inputs-nutrient">
                                        <div class="nutrient-sub-group">
                                            <p>공급 (In)</p>
                                            <input type="number" id="input-in-ec" step="0.1" placeholder="EC 1.8">
                                            <input type="number" id="input-in-ph" step="0.1" placeholder="pH 5.8">
                                        </div>
                                        <div class="nutrient-sub-group">
                                            <p>근권 (Root)</p>
                                            <input type="number" id="input-root-ec" step="0.1" placeholder="EC 2.2">
                                            <input type="number" id="input-root-ph" step="0.1" placeholder="pH 6.2">
                                            <input type="number" id="input-root-temp" step="0.1"
                                                placeholder="Temp 20.5">
                                            <input type="number" id="input-root-hum" step="1" placeholder="Hum 70">
                                        </div>
                                        <div class="nutrient-sub-group">
                                            <p>배액 (Drain)</p>
                                            <input type="number" id="input-drain-ec" step="0.1" placeholder="EC 2.0">
                                            <input type="number" id="input-drain-ph" step="0.1" placeholder="pH 6.5">
                                        </div>
                                    </div>
                                    
                                    <!-- 프리미엄 전용 버튼 (양액 정보 섹션 안에 배치) -->
                                    <button 
                                        type="button" 
                                        id="analysis-submit-btn" 
                                        class="submit-btn full-width"
                                        onclick="showAnalysisResult(); return false;"
                                        style="cursor: pointer !important; pointer-events: auto !important; margin-top: 20px;">
                                        💎 통합 분석 및 데이터 반영 (양액 포함)
                                    </button>
                                </div>
                                
                                <script>
                                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                // 전문가 수준 무토양 수경재배 진단 알고리즘
                                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                
                                // [1] 표준 처방 DB
                                const SUBSTRATE_DB = {
                                    strawberry: {
                                        sensitive: true, max_feed_ec_step: 0.15,
                                        transplant: { feed_ec:[0.8,1.0], feed_ph:[5.5,5.9], root_ec:[0.7,1.0], root_ph:[5.6,6.3], drain_ec:[0.7,1.1], drain_ph:[5.9,6.5], drain_ratio:[20,35] },
                                        early_growth: { feed_ec:[0.9,1.1], feed_ph:[5.5,6.0], root_ec:[0.9,1.1], root_ph:[5.6,6.5], drain_ec:[0.9,1.2], drain_ph:[6.0,6.6], drain_ratio:[25,40] },
                                        flowering: { feed_ec:[1.0,1.1], feed_ph:[5.5,6.0], root_ec:[1.0,1.2], root_ph:[5.6,6.5], drain_ec:[1.0,1.3], drain_ph:[6.0,6.6], drain_ratio:[25,40] },
                                        fruit_enlargement: { feed_ec:[1.0,1.2], feed_ph:[5.5,6.0], root_ec:[1.1,1.3], root_ph:[5.6,6.6], drain_ec:[1.1,1.4], drain_ph:[6.0,6.7], drain_ratio:[25,40] },
                                        harvest: { feed_ec:[1.1,1.2], feed_ph:[5.6,6.1], root_ec:[1.1,1.3], root_ph:[5.6,6.6], drain_ec:[1.2,1.5], drain_ph:[6.0,6.7], drain_ratio:[25,40] },
                                        late_harvest: { feed_ec:[1.0,1.1], feed_ph:[5.7,6.2], root_ec:[1.0,1.2], root_ph:[5.6,6.7], drain_ec:[1.1,1.4], drain_ph:[6.1,6.8], drain_ratio:[25,40] }
                                    },
                                    tomato: {
                                        transplant: { feed_ec:[1.2,1.6], feed_ph:[5.5,6.0], root_ec:[1.2,1.8], root_ph:[5.8,6.5], drain_ec:[1.2,2.0], drain_ph:[6.0,6.7], drain_ratio:[15,30] },
                                        early_growth: { feed_ec:[1.6,2.0], feed_ph:[5.5,6.0], root_ec:[1.8,2.2], root_ph:[6.0,6.6], drain_ec:[2.0,2.6], drain_ph:[6.1,6.8], drain_ratio:[20,35] },
                                        flowering: { feed_ec:[2.0,2.3], feed_ph:[5.5,6.0], root_ec:[2.0,2.4], root_ph:[6.0,6.6], drain_ec:[2.2,2.8], drain_ph:[6.1,6.8], drain_ratio:[20,35] },
                                        fruit_enlargement: { feed_ec:[2.3,2.5], feed_ph:[5.5,6.0], root_ec:[2.3,2.6], root_ph:[6.0,6.6], drain_ec:[2.4,3.0], drain_ph:[6.1,6.8], drain_ratio:[20,35] },
                                        harvest: { feed_ec:[2.4,2.7], feed_ph:[5.6,6.2], root_ec:[2.4,2.8], root_ph:[6.0,6.7], drain_ec:[2.6,3.2], drain_ph:[6.2,6.9], drain_ratio:[20,35] },
                                        late_harvest: { feed_ec:[2.0,2.3], feed_ph:[5.8,6.5], root_ec:[2.0,2.5], root_ph:[6.0,6.8], drain_ec:[2.2,3.0], drain_ph:[6.2,7.0], drain_ratio:[20,35] }
                                    },
                                    melon: {
                                        transplant: { feed_ec:[1.4,1.6], feed_ph:[5.5,6.0], root_ec:[1.4,1.8], root_ph:[5.8,6.5], drain_ec:[1.5,2.0], drain_ph:[6.0,6.8], drain_ratio:[20,35] },
                                        early_growth: { feed_ec:[1.5,1.7], feed_ph:[5.5,6.0], root_ec:[1.6,2.0], root_ph:[5.8,6.5], drain_ec:[1.8,2.3], drain_ph:[6.0,6.8], drain_ratio:[20,35] },
                                        flowering: { feed_ec:[1.5,1.8], feed_ph:[5.5,6.0], root_ec:[1.8,2.2], root_ph:[5.8,6.6], drain_ec:[2.0,2.6], drain_ph:[6.0,6.8], drain_ratio:[20,35] },
                                        fruit_enlargement: { feed_ec:[1.8,2.1], feed_ph:[5.5,6.1], root_ec:[2.0,2.5], root_ph:[5.8,6.6], drain_ec:[2.2,3.0], drain_ph:[6.0,6.9], drain_ratio:[20,35] },
                                        harvest: { feed_ec:[2.0,2.3], feed_ph:[5.6,6.2], root_ec:[2.2,2.8], root_ph:[5.8,6.7], drain_ec:[2.5,3.3], drain_ph:[6.1,7.0], drain_ratio:[15,30] }
                                    },
                                    cucumber: {
                                        transplant: { feed_ec:[1.3,1.6], feed_ph:[5.6,6.0], root_ec:[1.3,1.8], root_ph:[5.8,6.5], drain_ec:[1.5,2.2], drain_ph:[6.0,6.8], drain_ratio:[15,30] },
                                        early_growth: { feed_ec:[1.5,1.8], feed_ph:[5.6,6.0], root_ec:[1.7,2.1], root_ph:[5.8,6.5], drain_ec:[1.9,2.6], drain_ph:[6.0,6.8], drain_ratio:[20,35] },
                                        flowering: { feed_ec:[1.7,2.0], feed_ph:[5.6,6.1], root_ec:[1.9,2.3], root_ph:[5.8,6.6], drain_ec:[2.1,2.8], drain_ph:[6.0,6.9], drain_ratio:[20,35] },
                                        fruit_enlargement: { feed_ec:[1.8,2.1], feed_ph:[5.7,6.2], root_ec:[2.0,2.4], root_ph:[5.8,6.6], drain_ec:[2.2,3.0], drain_ph:[6.1,6.9], drain_ratio:[20,35] },
                                        harvest: { feed_ec:[1.8,2.2], feed_ph:[5.8,6.3], root_ec:[2.0,2.6], root_ph:[5.9,6.7], drain_ec:[2.3,3.2], drain_ph:[6.2,7.0], drain_ratio:[20,35] },
                                        late_harvest: { feed_ec:[1.6,2.0], feed_ph:[5.9,6.4], root_ec:[1.8,2.4], root_ph:[6.0,6.8], drain_ec:[2.0,3.0], drain_ph:[6.2,7.0], drain_ratio:[20,35] }
                                    },
                                    lettuce: {
                                        sensitive: true, max_feed_ec_step: 0.15,
                                        transplant: { feed_ec:[0.8,1.1], feed_ph:[5.6,6.1], root_ec:[0.8,1.2], root_ph:[5.8,6.5], drain_ec:[0.9,1.4], drain_ph:[6.0,6.8], drain_ratio:[10,25] },
                                        early_growth: { feed_ec:[1.0,1.3], feed_ph:[5.6,6.2], root_ec:[1.0,1.4], root_ph:[5.8,6.6], drain_ec:[1.1,1.6], drain_ph:[6.0,6.9], drain_ratio:[10,25] },
                                        harvest: { feed_ec:[1.0,1.4], feed_ph:[5.7,6.3], root_ec:[1.1,1.6], root_ph:[5.9,6.7], drain_ec:[1.2,1.8], drain_ph:[6.1,7.0], drain_ratio:[10,25] }
                                    },
                                    paprika: {
                                        transplant: { feed_ec:[2.6,3.1], feed_ph:[5.7,6.1], root_ec:[2.8,3.3], root_ph:[5.8,6.5], drain_ec:[3.0,3.8], drain_ph:[6.0,6.8], drain_ratio:[20,35] },
                                        early_growth: { feed_ec:[2.8,3.3], feed_ph:[5.7,6.1], root_ec:[3.0,3.5], root_ph:[5.8,6.5], drain_ec:[3.2,4.0], drain_ph:[6.0,6.8], drain_ratio:[20,35] },
                                        flowering: { feed_ec:[2.6,3.0], feed_ph:[5.8,6.2], root_ec:[2.7,3.2], root_ph:[5.8,6.6], drain_ec:[3.0,3.8], drain_ph:[6.0,6.9], drain_ratio:[20,35] },
                                        fruit_enlargement: { feed_ec:[2.2,2.6], feed_ph:[5.8,6.3], root_ec:[2.4,2.9], root_ph:[5.9,6.7], drain_ec:[2.7,3.5], drain_ph:[6.1,7.0], drain_ratio:[20,35] },
                                        harvest: { feed_ec:[2.0,2.4], feed_ph:[5.8,6.4], root_ec:[2.2,2.8], root_ph:[5.9,6.8], drain_ec:[2.6,3.4], drain_ph:[6.1,7.1], drain_ratio:[20,35] },
                                        late_harvest: { feed_ec:[2.0,2.3], feed_ph:[5.9,6.5], root_ec:[2.1,2.6], root_ph:[6.0,6.9], drain_ec:[2.4,3.2], drain_ph:[6.2,7.2], drain_ratio:[20,35] }
                                    },
                                    eggplant: {
                                        transplant: { feed_ec:[1.4,1.7], feed_ph:[5.5,6.0], root_ec:[1.6,2.0], root_ph:[5.8,6.5], drain_ec:[1.8,2.6], drain_ph:[6.0,6.8], drain_ratio:[15,30] },
                                        early_growth: { feed_ec:[1.7,2.1], feed_ph:[5.5,6.1], root_ec:[2.0,2.6], root_ph:[5.8,6.6], drain_ec:[2.3,3.2], drain_ph:[6.0,6.9], drain_ratio:[20,35] },
                                        flowering: { feed_ec:[2.0,2.4], feed_ph:[5.6,6.2], root_ec:[2.3,2.9], root_ph:[5.8,6.7], drain_ec:[2.6,3.6], drain_ph:[6.1,7.0], drain_ratio:[20,35] },
                                        fruit_enlargement: { feed_ec:[2.2,2.6], feed_ph:[5.7,6.3], root_ec:[2.5,3.2], root_ph:[5.9,6.8], drain_ec:[2.8,4.0], drain_ph:[6.1,7.1], drain_ratio:[20,35] },
                                        harvest: { feed_ec:[2.2,2.8], feed_ph:[5.8,6.4], root_ec:[2.5,3.4], root_ph:[6.0,6.9], drain_ec:[3.0,4.2], drain_ph:[6.2,7.2], drain_ratio:[20,35] },
                                        late_harvest: { feed_ec:[2.0,2.4], feed_ph:[5.9,6.5], root_ec:[2.2,3.0], root_ph:[6.0,7.0], drain_ec:[2.6,3.8], drain_ph:[6.2,7.3], drain_ratio:[20,35] }
                                    },
                                    leafy: {
                                        sensitive: true, max_feed_ec_step: 0.15,
                                        transplant: { feed_ec:[0.9,1.2], feed_ph:[5.6,6.1], root_ec:[1.0,1.4], root_ph:[5.8,6.6], drain_ec:[1.1,1.6], drain_ph:[6.0,6.9], drain_ratio:[10,25] },
                                        early_growth: { feed_ec:[1.1,1.5], feed_ph:[5.6,6.2], root_ec:[1.2,1.8], root_ph:[5.8,6.7], drain_ec:[1.3,2.0], drain_ph:[6.0,7.0], drain_ratio:[10,25] },
                                        harvest: { feed_ec:[1.1,1.6], feed_ph:[5.7,6.3], root_ec:[1.3,2.0], root_ph:[5.9,6.8], drain_ec:[1.4,2.2], drain_ph:[6.1,7.1], drain_ratio:[10,25] }
                                    }
                                };
                                
                                // [2] 진단 함수
                                function showAnalysisResult() {
                                    try {
                                        // 2-1) 데이터 수집
                                        const feed_ec = parseFloat(document.getElementById('input-in-ec')?.value) || 0;
                                        const feed_ph = parseFloat(document.getElementById('input-in-ph')?.value) || 0;
                                        const root_ec = parseFloat(document.getElementById('input-root-ec')?.value) || 0;
                                        const root_ph = parseFloat(document.getElementById('input-root-ph')?.value) || 0;
                                        const drain_ec = parseFloat(document.getElementById('input-drain-ec')?.value) || 0;
                                        const drain_ph = parseFloat(document.getElementById('input-drain-ph')?.value) || 0;
                                        const drain_ratio = 25; // 기본값 (추후 입력 필드 추가 가능)
                                        
                                        const cropId = document.getElementById('nutrient-crop-select')?.value || 'strawberry';
                                        const stageInput = document.getElementById('nutrient-stage-select')?.value || 'planting';
                                        
                                        // HTML select value → DB 키 매핑
                                        const stageMap = {
                                            'planting': 'transplant',
                                            'vegetative': 'early_growth',
                                            'flowering': 'flowering',
                                            'fruiting': 'fruit_enlargement',
                                            'harvest': 'harvest',
                                            'late': 'late_harvest'
                                        };
                                        const stageId = stageMap[stageInput] || stageInput;
                                        
                                        const temp = parseFloat(document.getElementById('input-temp')?.value) || 25;
                                        const hum = parseFloat(document.getElementById('input-hum')?.value) || 65;
                                        
                                        console.log('📊 입력 데이터:', { cropId, stageInput, stageId, feed_ec, feed_ph, root_ec, root_ph, drain_ec, drain_ph, temp, hum });
                                        
                                        // 2-2) DB 로드
                                        const cropDB = SUBSTRATE_DB[cropId];
                                        if (!cropDB) {
                                            throw new Error(`작물 "${cropId}" DB를 찾을 수 없습니다.`);
                                        }
                                        
                                        const setpoint = cropDB[stageId];
                                        if (!setpoint) {
                                            throw new Error(`"${cropId}" 작물의 "${stageId}" 단계 DB를 찾을 수 없습니다. (입력: ${stageInput})`);
                                        }
                                        
                                        const sensitive = cropDB.sensitive || false;
                                        const warn_delta = sensitive ? 0.2 : 0.3;
                                        
                                        console.log('🎯 목표 범위:', setpoint);
                                        
                                        // 2-3) Deltas 계산
                                        const d_root_ec = root_ec > 0 && feed_ec > 0 ? root_ec - feed_ec : 0;
                                        const d_drain_ec = drain_ec > 0 && feed_ec > 0 ? drain_ec - feed_ec : 0;
                                        const d_root_ph = root_ph > 0 && feed_ph > 0 ? root_ph - feed_ph : 0;
                                        const d_drain_ph = drain_ph > 0 && feed_ph > 0 ? drain_ph - feed_ph : 0;
                                        
                                        console.log('📐 델타 계산:', { d_root_ec, d_drain_ec, d_root_ph, d_drain_ph });
                                        
                                        // 2-4) 진단 및 조치
                                        const diagnosis = [];
                                        const actions = [];
                                        
                                        // A) 염류 축적 (SALT_ACCUMULATION)
                                        if ((drain_ec > setpoint.drain_ec[1]) || 
                                            (root_ec > setpoint.root_ec[1]) || 
                                            (d_drain_ec >= warn_delta)) {
                                            
                                            diagnosis.push({
                                                code: 'SALT_ACCUMULATION',
                                                severity: 'HIGH',
                                                evidence: `배액 EC ${drain_ec.toFixed(2)} (목표: ${setpoint.drain_ec[0]}~${setpoint.drain_ec[1]}), 근권 EC ${root_ec.toFixed(2)} (목표: ${setpoint.root_ec[0]}~${setpoint.root_ec[1]})`
                                            });
                                            
                                            // 조치 1순위: 배액률
                                            if (drain_ratio < setpoint.drain_ratio[0]) {
                                                actions.push({
                                                    priority: 1,
                                                    action: '배액률 증가',
                                                    delta: `+10%p (목표: ${setpoint.drain_ratio[0]}~${setpoint.drain_ratio[1]}%)`,
                                                    why: '염류 세척을 위해 배액량을 늘려 근권 EC를 낮춥니다.',
                                                    icon: '💧'
                                                });
                                            }
                                            
                                            // 조치 1순위: 관수 패턴
                                            actions.push({
                                                priority: 1,
                                                action: '관수 패턴 개선',
                                                delta: '펄스 횟수 증가 + 1회 관수량 감소',
                                                why: '균일한 염류 세척과 근권 산소 공급을 위해 소량 다회 급액으로 전환합니다.',
                                                icon: '🔄'
                                            });
                                            
                                            // 조치 2순위: EC 감소
                                            const ec_step = cropDB.max_feed_ec_step || 0.2;
                                            actions.push({
                                                priority: 2,
                                                action: '급액 EC 감소',
                                                delta: `-${ec_step.toFixed(1)} dS/m (현재: ${feed_ec.toFixed(2)} → 목표: ${(feed_ec - ec_step).toFixed(2)})`,
                                                why: '급액 농도를 낮춰 추가 염류 축적을 방지합니다.',
                                                icon: '⬇️'
                                            });
                                            
                                            // 민감 작물 + 심각한 축적
                                            if (sensitive && root_ec > setpoint.root_ec[1] + 0.3) {
                                                actions.push({
                                                    priority: 2,
                                                    action: '저EC 플러싱 (옵션)',
                                                    delta: `급액 EC 0.5 dS/m로 1~2회 관수`,
                                                    why: `⚠️ ${cropId} 염류 민감 작물이며 근권 EC가 매우 높습니다. 저농도 플러싱으로 빠른 세척 가능 (주의: 영양 손실 위험)`,
                                                    icon: '🚨'
                                                });
                                            }
                                        }
                                        
                                        // B) 과세척/저농도 (OVERLEACH_OR_UNDERFEED)
                                        if ((drain_ec < setpoint.drain_ec[0] && drain_ratio > setpoint.drain_ratio[1]) || 
                                            (d_drain_ec <= -warn_delta)) {
                                            
                                            diagnosis.push({
                                                code: 'OVERLEACH_OR_UNDERFEED',
                                                severity: 'MED',
                                                evidence: `배액 EC ${drain_ec.toFixed(2)} (목표: ${setpoint.drain_ec[0]}~${setpoint.drain_ec[1]}), 배액률 ${drain_ratio}% (목표: ${setpoint.drain_ratio[0]}~${setpoint.drain_ratio[1]}%)`
                                            });
                                            
                                            // 조치 1순위: 배액률 감소
                                            actions.push({
                                                priority: 1,
                                                action: '배액률 감소',
                                                delta: `-10%p (목표: ${setpoint.drain_ratio[0]}~${setpoint.drain_ratio[1]}%)`,
                                                why: '과도한 배액으로 양분이 유실되고 있습니다. 배액률을 낮춰 양분 이용률을 높입니다.',
                                                icon: '💧'
                                            });
                                            
                                            // 조치 2순위: EC 증가
                                            const ec_step = cropDB.max_feed_ec_step || 0.2;
                                            actions.push({
                                                priority: 2,
                                                action: '급액 EC 증가',
                                                delta: `+${ec_step.toFixed(1)} dS/m (현재: ${feed_ec.toFixed(2)} → 목표: ${(feed_ec + ec_step).toFixed(2)})`,
                                                why: '급액 농도를 높여 근권 및 배액 EC를 목표 범위로 회복합니다.',
                                                icon: '⬆️'
                                            });
                                        }
                                        
                                        // C) pH 상승 (PH_DRIFT_UP)
                                        if ((drain_ph > setpoint.drain_ph[1]) || 
                                            (root_ph > setpoint.root_ph[1]) || 
                                            (d_drain_ph >= 0.3)) {
                                            
                                            diagnosis.push({
                                                code: 'PH_DRIFT_UP',
                                                severity: 'HIGH',
                                                evidence: `배액 pH ${drain_ph.toFixed(1)} (목표: ${setpoint.drain_ph[0]}~${setpoint.drain_ph[1]}), 근권 pH ${root_ph.toFixed(1)} (목표: ${setpoint.root_ph[0]}~${setpoint.root_ph[1]})`
                                            });
                                            
                                            // 조치 3순위: pH 감소
                                            actions.push({
                                                priority: 3,
                                                action: '급액 pH 감소',
                                                delta: `-0.2 (현재: ${feed_ph.toFixed(1)} → 목표: ${(feed_ph - 0.2).toFixed(1)})`,
                                                why: '근권 pH 상승으로 미량원소(Fe, Mn, Zn) 흡수가 저해될 수 있습니다. 급액 pH를 낮춰 조정합니다.',
                                                icon: '⬇️'
                                            });
                                            
                                            // 민감 작물 경보
                                            if (sensitive) {
                                                actions.push({
                                                    priority: 3,
                                                    action: '미량원소 결핍 모니터링',
                                                    delta: '신엽 황화, 엽맥간 황화 확인',
                                                    why: `⚠️ ${cropId}는 pH 상승 시 Fe 결핍(황화) 위험이 높습니다. 엽면 Fe 처리 또는 킬레이트 Fe 엽면살포 준비하세요.`,
                                                    icon: '🚨'
                                                });
                                            }
                                            
                                            // 원수 체크
                                            actions.push({
                                                priority: 3,
                                                action: '원수 알칼리도 확인',
                                                delta: '원수 pH 및 HCO₃⁻ 농도 측정',
                                                why: '근권 pH 상승이 지속되면 원수의 높은 알칼리도(중탄산)가 원인일 수 있습니다. 원수 검사 및 산 주입량 조정이 필요합니다.',
                                                icon: '🔬'
                                            });
                                        }
                                        
                                        // D) pH 하강 (PH_DRIFT_DOWN)
                                        if ((drain_ph < setpoint.drain_ph[0]) || 
                                            (root_ph < setpoint.root_ph[0]) || 
                                            (d_drain_ph <= -0.3)) {
                                            
                                            diagnosis.push({
                                                code: 'PH_DRIFT_DOWN',
                                                severity: 'MED',
                                                evidence: `배액 pH ${drain_ph.toFixed(1)} (목표: ${setpoint.drain_ph[0]}~${setpoint.drain_ph[1]}), 근권 pH ${root_ph.toFixed(1)} (목표: ${setpoint.root_ph[0]}~${setpoint.root_ph[1]})`
                                            });
                                            
                                            // 조치 3순위: pH 증가
                                            actions.push({
                                                priority: 3,
                                                action: '급액 pH 증가',
                                                delta: `+0.2 (현재: ${feed_ph.toFixed(1)} → 목표: ${(feed_ph + 0.2).toFixed(1)})`,
                                                why: '근권 pH 하강으로 Ca, Mg 흡수가 저해되고 뿌리 손상 위험이 있습니다. 급액 pH를 높여 조정합니다.',
                                                icon: '⬆️'
                                            });
                                            
                                            // pH 급락 + EC 변동
                                            if (d_drain_ph < -0.5 && Math.abs(d_drain_ec) > 0.3) {
                                                actions.push({
                                                    priority: 3,
                                                    action: '뿌리 상태 점검',
                                                    delta: '뿌리 색깔, 냄새, 배지 수분 확인',
                                                    why: '⚠️ pH 급락과 EC 변동이 동시 발생하면 뿌리 부패, 저산소, 병원균 감염이 의심됩니다. 즉시 뿌리 상태를 점검하세요.',
                                                    icon: '🚨'
                                                });
                                            }
                                            
                                            // 산 주입 체크
                                            actions.push({
                                                priority: 3,
                                                action: '산 주입 설정 확인',
                                                delta: '질산/인산 주입 펌프 및 비율 점검',
                                                why: 'pH 하강이 지속되면 산 주입량이 과다하거나 배지 세정제 잔류가 원인일 수 있습니다.',
                                                icon: '🔬'
                                            });
                                        }
                                        
                                        // E) 정상 범위
                                        if (diagnosis.length === 0) {
                                            diagnosis.push({
                                                code: 'OPTIMAL',
                                                severity: 'OK',
                                                evidence: '모든 측정값이 목표 범위 내에 있습니다.'
                                            });
                                            
                                            actions.push({
                                                priority: 1,
                                                action: '현재 관리 유지',
                                                delta: '급액 EC/pH, 배액률 현 상태 유지',
                                                why: '✅ 양액 관리가 매우 양호합니다. 현재 설정을 유지하며 일일 모니터링을 계속하세요.',
                                                icon: '✅'
                                            });
                                        }
                                        
                                        // 2-5) VPD 계산 (환경 참고용)
                                        const svp = 0.6108 * Math.exp((17.27 * temp) / (temp + 237.3));
                                        const vpd = (svp * (1 - hum / 100)).toFixed(2);
                                        
                                        // 2-6) 신뢰도 계산
                                        let confidence = 0.9;
                                        const missing = [];
                                        if (!drain_ec || !drain_ph) { confidence -= 0.2; missing.push('배액 EC/pH'); }
                                        if (!root_ec || !root_ph) { confidence -= 0.1; missing.push('근권 EC/pH'); }
                                        
                                        // 2-7) 결과 표시
                                        const card = document.getElementById('nutrient-solution-card');
                                        const list = document.getElementById('nutrient-solution-list');
                                        
                                        if (!card || !list) {
                                            alert('❌ 결과 카드를 찾을 수 없습니다!');
                                            return;
                                        }
                                        
                                        // 카드 강제 표시
                                        card.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); padding: 25px; border-radius: 16px; margin-top: 20px; border: 3px solid #10b981; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);';
                                        card.classList.remove('hidden');
                                        
                                        // HTML 생성
                                        let html = '';
                                        
                                        // 헤더
                                        const cropName = { strawberry: '딸기', tomato: '토마토', melon: '멜론', cucumber: '오이', lettuce: '상추', paprika: '파프리카' }[cropId] || cropId;
                                        const stageName = { transplant: '정식기', early_growth: '초기생육기', flowering: '개화기', fruit_enlargement: '과실비대기', harvest: '수확기', late_harvest: '수확후기' }[stageId] || stageId;
                                        
                                        html += `<li style="background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border: 3px solid #3b82f6; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.4);">
                                            <strong style="color: #93c5fd; font-size: 1.4em; display: block; margin-bottom: 10px;">🔬 전문가 진단 결과</strong>
                                            <div style="color: #e0e7ff; font-size: 1.1em;">
                                                <strong>${cropName}</strong> - <strong>${stageName}</strong> | VPD ${vpd} kPa | 신뢰도 ${(confidence * 100).toFixed(0)}%
                                            </div>
                                        </li>`;
                                        
                                        // 목표 범위
                                        html += `<li style="background: rgba(30, 41, 59, 0.7); padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 5px solid #6366f1;">
                                            <strong style="color: #a5b4fc; font-size: 1.1em;">🎯 목표 범위</strong><br>
                                            <span style="color: #cbd5e1;">
                                                급액: EC ${setpoint.feed_ec[0]}~${setpoint.feed_ec[1]} dS/m, pH ${setpoint.feed_ph[0]}~${setpoint.feed_ph[1]}<br>
                                                근권: EC ${setpoint.root_ec[0]}~${setpoint.root_ec[1]} dS/m, pH ${setpoint.root_ph[0]}~${setpoint.root_ph[1]}<br>
                                                배액: EC ${setpoint.drain_ec[0]}~${setpoint.drain_ec[1]} dS/m, pH ${setpoint.drain_ph[0]}~${setpoint.drain_ph[1]}, 배액률 ${setpoint.drain_ratio[0]}~${setpoint.drain_ratio[1]}%
                                            </span>
                                        </li>`;
                                        
                                        // 진단
                                        diagnosis.forEach(d => {
                                            const color = { HIGH: '#ef4444', MED: '#f59e0b', OK: '#10b981' }[d.severity] || '#94a3b8';
                                            const icon = { SALT_ACCUMULATION: '🚨', OVERLEACH_OR_UNDERFEED: '⚠️', PH_DRIFT_UP: '📈', PH_DRIFT_DOWN: '📉', OPTIMAL: '✅' }[d.code] || '📊';
                                            html += `<li style="background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; margin-bottom: 12px; border-left: 5px solid ${color};">
                                                <strong style="color: ${color}; font-size: 1.15em;">${icon} ${d.code.replace(/_/g, ' ')}</strong><br>
                                                <span style="color: #e2e8f0; font-size: 0.95em;">${d.evidence}</span>
                                            </li>`;
                                        });
                                        
                                        // 조치 사항 (우선순위 정렬)
                                        actions.sort((a, b) => a.priority - b.priority);
                                        
                                        html += `<li style="background: linear-gradient(135deg, #065f46 0%, #047857 100%); padding: 18px; border-radius: 12px; margin: 20px 0 12px 0; border: 3px solid #10b981; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);">
                                            <strong style="color: #a7f3d0; font-size: 1.25em;">💡 조치 사항 (우선순위)</strong>
                                        </li>`;
                                        
                                        actions.forEach((a, idx) => {
                                            const priorityColor = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6' }[a.priority] || '#94a3b8';
                                            const priorityBadge = `<span style="background: ${priorityColor}; color: white; padding: 3px 8px; border-radius: 6px; font-size: 0.85em; font-weight: bold; margin-right: 8px;">우선순위 ${a.priority}</span>`;
                                            
                                            html += `<li style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 5px solid ${priorityColor};">
                                                ${priorityBadge}
                                                <strong style="color: #10b981; font-size: 1.1em;">${a.icon} ${a.action}</strong><br>
                                                <span style="color: #fbbf24; font-size: 0.95em; display: block; margin: 8px 0;">▸ ${a.delta}</span>
                                                <span style="color: #cbd5e1; font-size: 0.9em; line-height: 1.5;">${a.why}</span>
                                            </li>`;
                                        });
                                        
                                        // 누락 데이터 경고
                                        if (missing.length > 0) {
                                            html += `<li style="background: rgba(251, 191, 36, 0.15); padding: 15px; border-radius: 10px; margin-top: 15px; border: 2px solid #fbbf24;">
                                                <strong style="color: #fbbf24; font-size: 1.1em;">⚠️ 누락된 측정값</strong><br>
                                                <span style="color: #fde68a; font-size: 0.95em;">${missing.join(', ')} 데이터가 없습니다. 측정 후 다시 분석하면 더 정확한 진단을 받을 수 있습니다.</span>
                                            </li>`;
                                        }
                                        
                                        // 삽입
                                        list.innerHTML = html;
                                        list.style.display = 'block';
                                        
                                        // 스크롤
                                        setTimeout(() => {
                                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }, 150);
                                        
                                        console.log('✅ 전문가 진단 완료!', { diagnosis, actions, confidence });
                                        
                                    } catch (error) {
                                        console.error('❌ 분석 오류:', error);
                                        alert(`분석 중 오류가 발생했습니다: ${error.message}`);
                                    }
                                }
                                
                                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                // 생리 기반 스마트온실 환경 진단·제어 통합 알고리즘
                                // (딸기·토마토·상추·오이·파프리카·가지·엽채류·멜론)
                                // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                function showBasicAnalysisResult() {
                                    try {
                                        console.log('🌿 생리 기반 진단 시작');
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 1. 데이터 수집
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        const airTemp = parseFloat(document.getElementById('input-temp')?.value) || 0;
                                        const rh = parseFloat(document.getElementById('input-hum')?.value) || 0;
                                        const ppfd = parseFloat(document.getElementById('input-light')?.value) || 0;
                                        const co2 = parseFloat(document.getElementById('input-co2')?.value) || 0;
                                        const leafTemp = parseFloat(document.getElementById('input-leaf-temp')?.value) || 0;
                                        const cropId = document.getElementById('select-crop')?.value || 'strawberry';
                                        const photoperiod = 0; // 광주기 (선택 입력, 현재는 미입력)
                                        
                                        // 입력 검증
                                        if (!airTemp || !rh) {
                                            alert('⚠️ 대기 온도와 습도는 필수 입력입니다!');
                                            return;
                                        }
                                        
                                        // 엽온 없을 시 경고
                                        const hasLeafTemp = leafTemp > 0;
                                        if (!hasLeafTemp) {
                                            console.warn('⚠️ 엽온 미입력: 진단 정확도 저하');
                                        }
                                        
                                        console.log('📊 입력:', { airTemp, rh, ppfd, co2, leafTemp, cropId });
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 2. 작물별 생리 기준 프로파일 DB
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        const cropProfiles = {
                                            strawberry: {
                                                name: '딸기',
                                                vpd_min: 0.6, vpd_max: 1.2,
                                                dli_min: 10, dli_opt: [20, 25],
                                                co2_target: [800, 1000],
                                                condensation_margin: 1.0, // °C
                                                sensitivity: {
                                                    ca_transport: '매우높음',
                                                    botrytis: '매우높음',
                                                    condensation: '매우높음'
                                                }
                                            },
                                            tomato: {
                                                name: '토마토',
                                                vpd_min: 0.8, vpd_max: 1.5,
                                                dli_min: 20, dli_opt: [25, 30],
                                                co2_target: [800, 1200],
                                                condensation_margin: 1.0,
                                                sensitivity: {
                                                    carbon_limitation: '높음',
                                                    vpd_range: '넓음'
                                                }
                                            },
                                            lettuce: {
                                                name: '상추',
                                                vpd_min: 0.4, vpd_max: 0.9,
                                                dli_min: 10, dli_opt: [12, 17],
                                                co2_target: [700, 1000],
                                                condensation_margin: 0.5,
                                                sensitivity: {
                                                    tip_burn: '매우높음',
                                                    over_dry: '매우높음'
                                                }
                                            },
                                            cucumber: {
                                                name: '오이',
                                                vpd_min: 0.7, vpd_max: 1.3,
                                                dli_min: 15, dli_opt: [20, 25],
                                                co2_target: [800, 1200],
                                                condensation_margin: 1.0,
                                                sensitivity: {
                                                    humidity_stability: '중요',
                                                    disease: '높음'
                                                }
                                            },
                                            paprika: {
                                                name: '파프리카',
                                                vpd_min: 0.8, vpd_max: 1.4,
                                                dli_min: 20, dli_opt: [25, 30],
                                                co2_target: [800, 1200],
                                                condensation_margin: 1.0,
                                                sensitivity: {
                                                    low_temp_condensation: '높음',
                                                    night_stability: '중요'
                                                }
                                            },
                                            eggplant: {
                                                name: '가지',
                                                vpd_min: 0.8, vpd_max: 1.4,
                                                dli_min: 18, dli_opt: [22, 28],
                                                co2_target: [800, 1200],
                                                condensation_margin: 1.0,
                                                sensitivity: {
                                                    high_temp_crop: true,
                                                    high_humidity_disease: '급증'
                                                }
                                            },
                                            leafy: {
                                                name: '엽채류',
                                                vpd_min: 0.4, vpd_max: 1.0,
                                                dli_min: 10, dli_opt: [12, 18],
                                                co2_target: [700, 1000],
                                                condensation_margin: 0.5,
                                                sensitivity: {
                                                    tip_burn: '높음'
                                                }
                                            },
                                            melon: {
                                                name: '멜론',
                                                vpd_min: 0.8, vpd_max: 1.5,
                                                dli_min: 20, dli_opt: [25, 30],
                                                co2_target: [800, 1200],
                                                condensation_margin: 1.0,
                                                sensitivity: {
                                                    high_temp_high_light: true,
                                                    low_vpd_sugar_drop: '급격'
                                                }
                                            }
                                        };
                                        
                                        const profile = cropProfiles[cropId] || cropProfiles['strawberry'];
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 3. 공통 물리·생리 계산
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        
                                        // 3.1 포화수증기압 계산 (Magnus-Tetens 공식, kPa)
                                        const svp_air = 0.6108 * Math.exp((17.27 * airTemp) / (airTemp + 237.3));
                                        const svp_leaf = hasLeafTemp ? 0.6108 * Math.exp((17.27 * leafTemp) / (leafTemp + 237.3)) : svp_air;
                                        
                                        // 3.2 실제 수증기압 (kPa)
                                        const vp_actual = svp_air * (rh / 100);
                                        
                                        // 3.3 VPD 계산
                                        const vpd_air = (svp_air - vp_actual).toFixed(2); // 공기 기준 (참고용)
                                        const vpd_leaf = hasLeafTemp ? (svp_leaf - vp_actual).toFixed(2) : vpd_air; // 엽 기준 (진단 기준)
                                        
                                        console.log(`💧 VPD: 공기 ${vpd_air} kPa, 엽 ${vpd_leaf} kPa`);
                                        
                                        // 3.4 이슬점 및 결로 판단
                                        const dewPoint = (237.3 * Math.log(vp_actual / 0.6108)) / (17.27 - Math.log(vp_actual / 0.6108));
                                        const condensationRisk = hasLeafTemp && (leafTemp <= (dewPoint + profile.condensation_margin));
                                        const highRH = rh >= 90;
                                        
                                        console.log(`🌡️ 이슬점: ${dewPoint.toFixed(1)}°C, 엽온: ${leafTemp || 'N/A'}°C, 결로위험: ${condensationRisk}`);
                                        
                                        // 3.5 DLI 계산 (선택)
                                        let dli = null;
                                        if (ppfd > 0 && photoperiod > 0) {
                                            dli = (ppfd * photoperiod * 3600 / 1000000).toFixed(1); // mol/m²/day
                                        }
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 4. 상태 진단 로직 (우선순위 순서 고정)
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        
                                        const diagnosis = [];
                                        const actions = [];
                                        let criticalState = null;
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 4.1 단계 1: 결로·병해 위험 판단 (절대 최우선)
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        if (condensationRisk || (highRH && parseFloat(vpd_leaf) < profile.vpd_min)) {
                                            criticalState = 'CONDENSATION_DISEASE_RISK';
                                            diagnosis.push({
                                                code: 'CONDENSATION_HIGH',
                                                severity: 'CRITICAL',
                                                icon: '🚨',
                                                title: '결로·병해 고위험 상태',
                                                message: `엽온 ${leafTemp}°C ≤ 이슬점 ${dewPoint.toFixed(1)}°C (여유: ${profile.condensation_margin}°C) 또는 고습(${rh}%) + 저VPD 상태`,
                                                evidence: `${profile.name}는 ${profile.sensitivity.botrytis || profile.sensitivity.condensation || '결로'} 민감 작물`
                                            });
                                            
                                            // 즉시 조치 (병 예방 최우선)
                                            actions.push({
                                                priority: 1,
                                                action: '난방 즉시 가동',
                                                target: '엽온 상승 (↑2~3°C)',
                                                why: '결로 제거 및 병원균 활동 억제',
                                                icon: '🔥'
                                            });
                                            
                                            actions.push({
                                                priority: 1,
                                                action: '제습 또는 환기',
                                                target: `습도 → ${profile.vpd_min < 0.6 ? '70' : '60'}% 이하`,
                                                why: 'VPD 상승 및 포자 비산 억제',
                                                icon: '💨'
                                            });
                                            
                                            actions.push({
                                                priority: 1,
                                                action: '가습 중단',
                                                target: '즉시',
                                                why: '습도 추가 상승 방지',
                                                icon: '🚫'
                                            });
                                            
                                            console.log('🚨 [CRITICAL] 결로 위험 → 생육 진단 중단');
                                        }
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 4.2 단계 2: VPD 기반 생리 상태 판단
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        if (!criticalState) {
                                            const vpd_value = parseFloat(vpd_leaf);
                                            
                                            if (vpd_value < profile.vpd_min) {
                                                // VPD 낮음 → 증산 부족
                                                const severity = vpd_value < (profile.vpd_min * 0.7) ? 'HIGH' : 'MEDIUM';
                                                diagnosis.push({
                                                    code: 'VPD_LOW',
                                                    severity: severity,
                                                    icon: severity === 'HIGH' ? '🚨' : '⚠️',
                                                    title: 'VPD 낮음 - 증산 부족 상태',
                                                    message: `VPD ${vpd_leaf} kPa < 목표 ${profile.vpd_min} kPa`,
                                                    evidence: `Ca 이동 제한, ${profile.sensitivity.tip_burn ? '팁번 위험, ' : ''}생육 병목 발생 중`
                                                });
                                                
                                                // 조치
                                                actions.push({
                                                    priority: 1,
                                                    action: '난방 가동',
                                                    target: `기온 ↑2~3°C (현재 ${airTemp}°C)`,
                                                    why: 'VPD 상승 (포화수증기압 증가)',
                                                    icon: '🔥'
                                                });
                                                
                                                actions.push({
                                                    priority: 1,
                                                    action: '제습 또는 환기',
                                                    target: `습도 → ${Math.max(50, rh - 10)}%`,
                                                    why: 'VPD 상승 (실제 수증기압 감소)',
                                                    icon: '💨'
                                                });
                                                
                                                if (profile.sensitivity.ca_transport === '매우높음') {
                                                    actions.push({
                                                        priority: 2,
                                                        action: `${profile.name} Ca 엽면살포`,
                                                        target: '주 2~3회',
                                                        why: '증산 부족 시 Ca 이동 경로 보조',
                                                        icon: '🍃'
                                                    });
                                                }
                                                
                                            } else if (vpd_value > profile.vpd_max) {
                                                // VPD 높음 → 과건조
                                                const severity = vpd_value > (profile.vpd_max * 1.3) ? 'HIGH' : 'MEDIUM';
                                                diagnosis.push({
                                                    code: 'VPD_HIGH',
                                                    severity: severity,
                                                    icon: severity === 'HIGH' ? '🚨' : '⚠️',
                                                    title: 'VPD 높음 - 과건조 상태',
                                                    message: `VPD ${vpd_leaf} kPa > 목표 ${profile.vpd_max} kPa`,
                                                    evidence: `기공 폐쇄, 광합성 제한, ${profile.sensitivity.over_dry === '매우높음' ? '즉시 조치 필요' : '수분 스트레스'}`
                                                });
                                                
                                                // 조치
                                                actions.push({
                                                    priority: 1,
                                                    action: '가습 가동',
                                                    target: `습도 → ${Math.min(85, rh + 15)}%`,
                                                    why: 'VPD 하강 (실제 수증기압 증가)',
                                                    icon: '💧'
                                                });
                                                
                                                if (ppfd > profile.dli_opt[1] * 50) { // 과다 광도 추정
                                                    actions.push({
                                                        priority: 1,
                                                        action: '차광 또는 냉방',
                                                        target: '일사량 감소 또는 기온 ↓2°C',
                                                        why: 'VPD 하강 (엽온/기온 저하)',
                                                        icon: '☁️'
                                                    });
                                                }
                                                
                                            } else {
                                                // VPD 적정
                                                diagnosis.push({
                                                    code: 'VPD_OPTIMAL',
                                                    severity: 'OK',
                                                    icon: '✅',
                                                    title: 'VPD 적정 - 생리 안정 상태',
                                                    message: `VPD ${vpd_leaf} kPa (목표: ${profile.vpd_min}~${profile.vpd_max} kPa)`,
                                                    evidence: '증산, 양분 이동, 기공 개도 정상 범위'
                                                });
                                            }
                                        }
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 4.3 단계 3: 탄소 제한 판단
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        if (!criticalState && parseFloat(vpd_leaf) >= profile.vpd_min && parseFloat(vpd_leaf) <= profile.vpd_max) {
                                            // VPD 정상일 때만 탄소 제한 평가
                                            
                                            // 광 부족 판단
                                            if (ppfd > 0 && ppfd < (profile.dli_min * 40)) { // PPFD 대략 환산
                                                diagnosis.push({
                                                    code: 'LIGHT_INSUFFICIENT',
                                                    severity: 'MEDIUM',
                                                    icon: '⚠️',
                                                    title: '광량 부족',
                                                    message: `PPFD ${ppfd} µmol/m²/s (최소 필요: ~${profile.dli_min * 40})`,
                                                    evidence: `DLI < ${profile.dli_min} mol/m²/day 추정, 구조적 생육 제한`
                                                });
                                                
                                                actions.push({
                                                    priority: 2,
                                                    action: '보광 가동',
                                                    target: `PPFD → ${profile.dli_opt[0] * 50} µmol/m²/s 이상`,
                                                    why: '광합성 속도 회복, 탄소 공급 확보',
                                                    icon: '💡'
                                                });
                                            }
                                            
                                            // CO₂ 부족 판단
                                            if (co2 > 0 && co2 < profile.co2_target[0]) {
                                                diagnosis.push({
                                                    code: 'CO2_INSUFFICIENT',
                                                    severity: 'MEDIUM',
                                                    icon: '⚠️',
                                                    title: 'CO₂ 부족',
                                                    message: `${co2} ppm < 목표 ${profile.co2_target[0]}~${profile.co2_target[1]} ppm`,
                                                    evidence: '광합성 주 제한 요인'
                                                });
                                                
                                                actions.push({
                                                    priority: 2,
                                                    action: 'CO₂ 공급',
                                                    target: `${profile.co2_target[0]}~${profile.co2_target[1]} ppm`,
                                                    why: '광합성 속도 증대 (특히 고광 시)',
                                                    icon: '🌱'
                                                });
                                            }
                                            
                                            // 모두 정상
                                            if (diagnosis.filter(d => d.severity !== 'OK').length === 0) {
                                                diagnosis.push({
                                                    code: 'ALL_OPTIMAL',
                                                    severity: 'OK',
                                                    icon: '✅',
                                                    title: '환경 최적 상태',
                                                    message: 'VPD, 광, CO₂ 모두 적정 범위',
                                                    evidence: `${profile.name} 생육에 이상적인 환경`
                                                });
                                                
                                                actions.push({
                                                    priority: 3,
                                                    action: '현재 환경 유지',
                                                    target: '설정값 고정',
                                                    why: '생리 안정 상태, 에너지 최적화 가능',
                                                    icon: '✅'
                                                });
                                            }
                                        }
                                        
                                        // 결과 표시
                                        const card = document.getElementById('nutrient-solution-card');
                                        const list = document.getElementById('nutrient-solution-list');
                                        
                                        if (!card || !list) {
                                            alert('❌ 결과 카드를 찾을 수 없습니다!');
                                            return;
                                        }
                                        
                                        // 카드 강제 표시
                                        card.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; background: linear-gradient(135deg, #064e3b 0%, #065f46 100%); padding: 25px; border-radius: 16px; margin-top: 20px; border: 3px solid #10b981; box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);';
                                        card.classList.remove('hidden');
                                        
                                        // HTML 생성
                                        let html = '';
                                        
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        // 5. 결과 HTML 생성
                                        // ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
                                        
                                        // 헤더
                                        const severityColor = criticalState ? '#ef4444' : (diagnosis.some(d => d.severity === 'HIGH' || d.severity === 'MEDIUM') ? '#f59e0b' : '#10b981');
                                        
                                        html += `<li style="background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%); padding: 22px; border-radius: 14px; margin-bottom: 18px; border: 3px solid ${severityColor}; box-shadow: 0 6px 24px rgba(${criticalState ? '239, 68, 68' : '16, 185, 129'}, 0.4);">
                                            <strong style="color: #bae6fd; font-size: 1.5em; display: block; margin-bottom: 12px;">🔬 생리 기반 환경 진단</strong>
                                            <div style="color: #e0f2fe; font-size: 1.05em; line-height: 1.7;">
                                                <strong>${profile.name}</strong> | VPD(엽) ${vpd_leaf} kPa ${hasLeafTemp ? '' : '(엽온 미입력)'}
                                                <br>기온 ${airTemp}°C | 습도 ${rh}% | 이슬점 ${dewPoint.toFixed(1)}°C
                                                ${ppfd > 0 ? `<br>광도 ${ppfd} µmol/m²/s` : ''} ${co2 > 0 ? `| CO₂ ${co2} ppm` : ''}
                                            </div>
                                        </li>`;
                                        
                                        // 진단 결과
                                        diagnosis.forEach(d => {
                                            const color = {
                                                'CRITICAL': '#ef4444',
                                                'HIGH': '#f97316',
                                                'MEDIUM': '#f59e0b',
                                                'OK': '#10b981'
                                            }[d.severity] || '#94a3b8';
                                            
                                            html += `<li style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 12px; margin-bottom: 14px; border-left: 6px solid ${color};">
                                                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                                    <span style="font-size: 1.8em; margin-right: 12px;">${d.icon}</span>
                                                    <strong style="color: ${color}; font-size: 1.3em;">${d.title}</strong>
                                                </div>
                                                <div style="margin-left: 45px;">
                                                    <div style="color: #e2e8f0; font-size: 1.1em; margin-bottom: 8px; font-weight: 500;">${d.message}</div>
                                                    <div style="color: #cbd5e1; font-size: 0.95em; line-height: 1.6;">${d.evidence}</div>
                                                </div>
                                            </li>`;
                                        });
                                        
                                        // 조치 사항 (우선순위 정렬)
                                        if (actions.length > 0) {
                                            actions.sort((a, b) => a.priority - b.priority);
                                            
                                            html += `<li style="background: linear-gradient(135deg, #065f46 0%, #047857 100%); padding: 20px; border-radius: 14px; margin: 24px 0 16px 0; border: 3px solid #10b981; box-shadow: 0 6px 24px rgba(16, 185, 129, 0.35);">
                                                <strong style="color: #a7f3d0; font-size: 1.35em;">💡 실행 우선순위 조치 사항</strong>
                                            </li>`;
                                            
                                            actions.forEach(a => {
                                                const priorityColor = { 1: '#ef4444', 2: '#f59e0b', 3: '#3b82f6' }[a.priority] || '#94a3b8';
                                                const priorityLabel = { 1: '최우선', 2: '2순위', 3: '3순위' }[a.priority] || '참고';
                                                
                                                html += `<li style="background: rgba(0,0,0,0.6); padding: 18px; border-radius: 11px; margin-bottom: 12px; border-left: 6px solid ${priorityColor};">
                                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                                        <div style="display: flex; align-items: center;">
                                                            <span style="font-size: 1.6em; margin-right: 10px;">${a.icon}</span>
                                                            <strong style="color: #f0fdfa; font-size: 1.15em;">${a.action}</strong>
                                                        </div>
                                                        <span style="background: ${priorityColor}; color: white; padding: 4px 12px; border-radius: 8px; font-size: 0.85em; font-weight: bold;">${priorityLabel}</span>
                                                    </div>
                                                    <div style="margin-left: 42px;">
                                                        <div style="color: #fbbf24; font-size: 1em; margin-bottom: 6px;">▸ ${a.target}</div>
                                                        <div style="color: #cbd5e1; font-size: 0.92em; line-height: 1.6;">${a.why}</div>
                                                    </div>
                                                </li>`;
                                            });
                                        }
                                        
                                        // 종합 상태
                                        const hasCritical = diagnosis.some(d => d.severity === 'CRITICAL');
                                        const hasHigh = diagnosis.some(d => d.severity === 'HIGH');
                                        const allOK = diagnosis.every(d => d.severity === 'OK');
                                        
                                        let summaryIcon = '✅';
                                        let summaryText = `${profile.name} 생육 환경이 최적 상태입니다!`;
                                        let summaryColor = '#10b981';
                                        
                                        if (hasCritical) {
                                            summaryIcon = '🚨';
                                            summaryText = '긴급 조치 필요! 병해 또는 생리장해 고위험 상태입니다.';
                                            summaryColor = '#ef4444';
                                        } else if (hasHigh) {
                                            summaryIcon = '⚠️';
                                            summaryText = '즉시 조치 권장: 생육 병목 또는 스트레스 상태입니다.';
                                            summaryColor = '#f59e0b';
                                        }
                                        
                                        html += `<li style="background: linear-gradient(135deg, rgba(${allOK ? '5, 150, 105' : (hasCritical ? '239, 68, 68' : '245, 158, 11')}, 0.15) 0%, rgba(0,0,0,0.3) 100%); padding: 24px; border-radius: 14px; margin-top: 24px; border: 3px solid ${summaryColor};">
                                            <div style="text-align: center;">
                                                <div style="font-size: 3.5em; margin-bottom: 14px;">${summaryIcon}</div>
                                                <strong style="color: ${summaryColor}; font-size: 1.4em; line-height: 1.5;">${summaryText}</strong>
                                            </div>
                                        </li>`;
                                        
                                        // 엽온 미입력 경고
                                        if (!hasLeafTemp) {
                                            html += `<li style="background: rgba(251, 191, 36, 0.15); padding: 18px; border-radius: 11px; margin-top: 20px; border: 2px solid #fbbf24;">
                                                <strong style="color: #fbbf24; font-size: 1.15em;">⚠️ 엽온 미입력</strong><br>
                                                <span style="color: #fde68a; font-size: 0.95em; line-height: 1.6;">
                                                    엽온은 이 알고리즘의 필수 전제입니다. 엽온 없이는 정확한 VPD와 결로 판단이 불가능합니다.<br>
                                                    엽온을 측정하여 입력하면 <strong>훨씬 정확한 생리 진단</strong>을 받을 수 있습니다.
                                                </span>
                                            </li>`;
                                        }
                                        
                                        // 프리미엄 안내
                                        html += `<li style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(168, 85, 247, 0.12) 100%); padding: 22px; border-radius: 13px; margin-top: 22px; border: 2px dashed #a78bfa;">
                                            <div style="text-align: center; color: #d8b4fe;">
                                                <div style="font-size: 2.2em; margin-bottom: 12px;">💎</div>
                                                <strong style="font-size: 1.2em; display: block; margin-bottom: 10px; color: #c4b5fd;">프리미엄 대쉬보드로 전환하면</strong>
                                                <div style="font-size: 0.98em; line-height: 1.7;">
                                                    <strong style="color: #a78bfa;">양액 EC/pH 통합 분석</strong>, 염류 축적 진단, 영양 밸런스 최적화,<br>
                                                    근권 환경 진단 등 <strong style="color: #c4b5fd;">전문가 수준의 통합 솔루션</strong>을 받을 수 있습니다!
                                                </div>
                                            </div>
                                        </li>`;
                                        
                                        // 삽입
                                        list.innerHTML = html;
                                        list.style.display = 'block';
                                        
                                        // 스크롤
                                        setTimeout(() => {
                                            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }, 150);
                                        
                                        console.log('✅ 생리 기반 진단 완료!', {
                                            crop: profile.name,
                                            vpd_leaf,
                                            diagnosis: diagnosis.map(d => d.code),
                                            actions: actions.length,
                                            critical: !!criticalState
                                        });
                                        
                                    } catch (error) {
                                        console.error('❌ 진단 오류:', error);
                                        alert(`분석 중 오류가 발생했습니다: ${error.message}\n\n개발자 콘솔(F12)을 확인해주세요.`);
                                    }
                                }
                                </script>
                            </form>

                            <!-- Nutrient Solution Results -->
                            <div 
                                id="nutrient-solution-card" 
                                class="nutrient-solution-card glass"
                                style="display: block; visibility: visible; opacity: 1; margin-top: 20px;">
                                <div class="solution-header">
                                    <h4>🔬 양액 분석 결과</h4>
                                    <div class="solution-status">
                                        <span class="status-badge" id="nutrient-status-badge">분석 대기</span>
                                        <span class="target-info" id="nutrient-target-info">목표값을 확인하세요</span>
                                    </div>
                                </div>
                                <ul class="solution-list" id="nutrient-solution-list" style="display: block;">
                                    <li class="no-solution">데이터를 입력하고 "통합 분석 및 데이터 반영" 버튼을 클릭하세요.</li>
                                </ul>
                            </div>


                        </div>
                    </div>

                    <!-- Harvest Info Registration Section -->
                    <div class="yield-input-section glass full-width">
                        <div class="yield-header">
                            <div class="header-left">
                                <i data-lucide="map-pin" class="header-icon"></i>
                                <div>
                                    <h3>수확량 등록 및 시세 조회</h3>
                                    <p class="section-desc">수확량을 지도에 등록하고 실시간 예상 수익을 확인하세요.</p>
                                </div>
                            </div>
                        </div>

                        <div class="yield-input-container">
                            <div class="yield-input-group">
                                <label for="market-crop-select">
                                    <i data-lucide="sprout"></i>
                                    작물 선택
                                </label>
                                <select id="market-crop-select" class="yield-select">
                                    <option value="strawberry">딸기</option>
                                    <option value="tomato">토마토</option>
                                    <option value="lettuce">상추</option>
                                    <option value="cucumber">오이</option>
                                    <option value="paprika">파프리카</option>
                                    <option value="eggplant">가지</option>
                                    <option value="leafy">엽채류</option>
                                    <option value="melon">멜론</option>
                                </select>
                            </div>

                            <div class="yield-input-group">
                                <label for="yield-amount">
                                    <i data-lucide="package"></i>
                                    예상 수확량
                                </label>
                                <div class="input-with-unit">
                                    <input type="number" id="yield-amount" placeholder="100" min="0" step="1">
                                    <span class="unit">kg</span>
                                </div>
                            </div>

                            <!-- Register Button -->
                            <button id="register-map-btn" class="analyze-btn" onclick="showMarketPriceNow(); return false;">
                                <i data-lucide="search"></i>
                                시세 조회
                            </button>
                            
                            <script>
                            function showMarketPriceNow() {
                                console.log('🔥🔥🔥 시세 조회 버튼 클릭됨!');
                                
                                // 1. 데이터 수집
                                const crop = document.getElementById('market-crop-select')?.value || 'strawberry';
                                const amount = parseFloat(document.getElementById('yield-amount')?.value) || 0;
                                
                                console.log('📊 데이터:', { crop, amount });
                                
                                if (amount <= 0) {
                                    alert('⚠️ 수확량을 입력해주세요!');
                                    return;
                                }
                                
                                // 2. 기본 가격 DB
                                const prices = {
                                    strawberry: { wholesale: 35000, retail: 48000, name: '딸기' },
                                    tomato: { wholesale: 18000, retail: 25000, name: '토마토' },
                                    lettuce: { wholesale: 8000, retail: 12000, name: '상추' },
                                    cucumber: { wholesale: 15000, retail: 22000, name: '오이' },
                                    paprika: { wholesale: 28000, retail: 38000, name: '파프리카' },
                                    eggplant: { wholesale: 12000, retail: 18000, name: '가지' },
                                    leafy: { wholesale: 5000, retail: 9000, name: '엽채류' },
                                    melon: { wholesale: 45000, retail: 60000, name: '멜론' }
                                };
                                
                                const price = prices[crop] || prices['strawberry'];
                                
                                // 2-1. 실시간 시장 시세 분석 섹션 업데이트 (도매/소매 가격)
                                console.log('📊 시장 시세 분석 업데이트 시작...');
                                
                                // 도매 가격 (가락시장)
                                const wholesaleMaxEl = document.getElementById('wholesale-max');
                                const wholesaleAvgEl = document.getElementById('wholesale-avg');
                                const wholesaleMinEl = document.getElementById('wholesale-min');
                                
                                if (wholesaleMaxEl) {
                                    wholesaleMaxEl.textContent = Math.round(price.wholesale * 1.2).toLocaleString() + '원';
                                    console.log('✅ 도매 최고가:', wholesaleMaxEl.textContent);
                                }
                                if (wholesaleAvgEl) {
                                    wholesaleAvgEl.textContent = price.wholesale.toLocaleString() + '원';
                                    console.log('✅ 도매 평균가:', wholesaleAvgEl.textContent);
                                }
                                if (wholesaleMinEl) {
                                    wholesaleMinEl.textContent = Math.round(price.wholesale * 0.8).toLocaleString() + '원';
                                    console.log('✅ 도매 최저가:', wholesaleMinEl.textContent);
                                }
                                
                                // 소매 가격 (네이버 스마트스토어)
                                const retailMaxEl = document.getElementById('retail-max');
                                const retailAvgEl = document.getElementById('retail-avg');
                                const retailMinEl = document.getElementById('retail-min');
                                
                                if (retailMaxEl) {
                                    retailMaxEl.textContent = Math.round(price.retail * 1.2).toLocaleString() + '원';
                                    console.log('✅ 소매 최고가:', retailMaxEl.textContent);
                                }
                                if (retailAvgEl) {
                                    retailAvgEl.textContent = price.retail.toLocaleString() + '원';
                                    console.log('✅ 소매 평균가:', retailAvgEl.textContent);
                                }
                                if (retailMinEl) {
                                    retailMinEl.textContent = Math.round(price.retail * 0.8).toLocaleString() + '원';
                                    console.log('✅ 소매 최저가:', retailMinEl.textContent);
                                }
                                
                                console.log('✅ 시장 시세 분석 섹션 업데이트 완료!');
                                
                                // 3. 수익 계산
                                const wholesaleIncome = Math.round(amount * price.wholesale);
                                const retailIncome = Math.round(amount * price.retail);
                                
                                console.log('💰 예상 수입 계산 결과:', { wholesaleIncome, retailIncome });
                                
                                // 4. 화면에 표시
                                const wholesaleEl = document.getElementById('wholesale-revenue');
                                const retailEl = document.getElementById('retail-revenue');
                                const predictionCard = document.getElementById('revenue-predictions');
                                
                                if (wholesaleEl) {
                                    wholesaleEl.textContent = wholesaleIncome.toLocaleString() + '원';
                                    console.log('✅ 도매 수입 표시:', wholesaleEl.textContent);
                                }
                                
                                if (retailEl) {
                                    retailEl.textContent = retailIncome.toLocaleString() + '원';
                                    console.log('✅ 소매 수입 표시:', retailEl.textContent);
                                }
                                
                                if (predictionCard) {
                                    predictionCard.classList.remove('hidden');
                                    predictionCard.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important;';
                                    console.log('✅ 시세 카드 표시 완료!');
                                }
                                
                                // 5. 차트 컨테이너 표시
                                const chartContainer = document.querySelector('.market-chart-container');
                                if (chartContainer) {
                                    chartContainer.style.display = 'block';
                                    chartContainer.style.visibility = 'visible';
                                    chartContainer.style.opacity = '1';
                                    console.log('✅ 차트 컨테이너 표시 완료!');
                                }
                                
                                // 6. 차트 업데이트
                                console.log('📈 시장 시세 차트 업데이트 시작...');
                                setTimeout(() => {
                                    updateMarketChart(crop, 'week');
                                }, 100);
                                
                                // 7. 기간 탭 버튼 이벤트 연결
                                const periodButtons = document.querySelectorAll('.period-tabs button');
                                periodButtons.forEach(btn => {
                                    btn.onclick = function() {
                                        // 활성화 상태 변경
                                        periodButtons.forEach(b => b.classList.remove('active'));
                                        this.classList.add('active');
                                        
                                        // 차트 업데이트
                                        const period = this.getAttribute('data-period');
                                        console.log('📊 기간 변경:', period);
                                        updateMarketChart(crop, period);
                                    };
                                });
                                
                                // 완료 메시지
                                setTimeout(() => {
                                    alert(`✅ 시세 조회 완료!\n\n${price.name} ${amount}kg\n\n📦 예상 수입:\n도매: ${wholesaleIncome.toLocaleString()}원\n소매: ${retailIncome.toLocaleString()}원\n\n📊 시장 시세 분석도 업데이트되었습니다!`);
                                }, 200);
                            }
                            
                            // 차트 인스턴스 저장
                            let marketChartInstance = null;
                            
                            // 기간별 더미 데이터 생성 함수
                            function generateMarketHistory(basePrice, period) {
                                const labels = [];
                                const data = [];
                                let days = 7;
                                
                                if (period === 'week') days = 7;
                                else if (period === 'month') days = 30;
                                else if (period === 'year') days = 365;
                                
                                for (let i = 0; i < days; i++) {
                                    const date = new Date();
                                    date.setDate(date.getDate() - (days - 1 - i));
                                    
                                    if (period === 'year') {
                                        // 1년: 월별 표시
                                        if (i % 30 === 0) {
                                            labels.push(date.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }));
                                        }
                                    } else if (period === 'month') {
                                        // 1개월: 일별 표시 (3일마다)
                                        if (i % 3 === 0) {
                                            labels.push(date.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }));
                                        }
                                    } else {
                                        // 1주일: 매일 표시
                                        labels.push(date.toLocaleDateString('ko-KR', { month: 'numeric', day: 'numeric' }));
                                    }
                                    
                                    // 가격 변동 (±20%)
                                    data.push(basePrice * (1 + (Math.random() - 0.5) * 0.4));
                                }
                                
                                return { labels, data };
                            }
                            
                            // 차트 업데이트 함수
                            function updateMarketChart(cropId, period) {
                                console.log('🎨 차트 그리기 시작:', { cropId, period });
                                
                                const prices = {
                                    strawberry: { wholesale: 35000, retail: 48000, name: '딸기' },
                                    tomato: { wholesale: 18000, retail: 25000, name: '토마토' },
                                    lettuce: { wholesale: 8000, retail: 12000, name: '상추' },
                                    cucumber: { wholesale: 15000, retail: 22000, name: '오이' },
                                    paprika: { wholesale: 28000, retail: 38000, name: '파프리카' },
                                    eggplant: { wholesale: 12000, retail: 18000, name: '가지' },
                                    leafy: { wholesale: 5000, retail: 9000, name: '엽채류' },
                                    melon: { wholesale: 45000, retail: 60000, name: '멜론' }
                                };
                                
                                const price = prices[cropId] || prices['strawberry'];
                                const history = generateMarketHistory(price.wholesale, period);
                                
                                const ctx = document.getElementById('marketChart');
                                if (!ctx) {
                                    console.error('❌ marketChart 캔버스를 찾을 수 없습니다.');
                                    return;
                                }
                                
                                // 이전 차트 파괴
                                if (marketChartInstance) {
                                    marketChartInstance.destroy();
                                }
                                
                                // 새 차트 생성
                                marketChartInstance = new Chart(ctx.getContext('2d'), {
                                    type: 'line',
                                    data: {
                                        labels: history.labels,
                                        datasets: [{
                                            label: `${price.name} 도매 평균가 (가락시장)`,
                                            data: history.data,
                                            borderColor: '#10b981',
                                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                            borderWidth: 3,
                                            fill: true,
                                            tension: 0.4,
                                            pointRadius: 4,
                                            pointBackgroundColor: '#10b981',
                                            pointBorderColor: '#fff',
                                            pointBorderWidth: 2
                                        }]
                                    },
                                    options: {
                                        responsive: true,
                                        maintainAspectRatio: false,
                                        plugins: {
                                            legend: {
                                                display: true,
                                                labels: {
                                                    color: '#fff',
                                                    font: { size: 14, weight: 'bold' }
                                                }
                                            },
                                            tooltip: {
                                                backgroundColor: 'rgba(30, 41, 59, 0.95)',
                                                titleColor: '#fff',
                                                bodyColor: '#94a3b8',
                                                borderColor: '#10b981',
                                                borderWidth: 1,
                                                padding: 12,
                                                displayColors: false,
                                                callbacks: {
                                                    label: function(context) {
                                                        return '가격: ' + Math.round(context.parsed.y).toLocaleString() + '원';
                                                    }
                                                }
                                            }
                                        },
                                        scales: {
                                            y: {
                                                beginAtZero: false,
                                                grid: {
                                                    color: 'rgba(255, 255, 255, 0.05)',
                                                    borderColor: 'rgba(255, 255, 255, 0.1)'
                                                },
                                                ticks: {
                                                    color: '#94a3b8',
                                                    font: { size: 12 },
                                                    callback: (value) => value.toLocaleString() + '원'
                                                }
                                            },
                                            x: {
                                                grid: {
                                                    display: false
                                                },
                                                ticks: {
                                                    color: '#94a3b8',
                                                    font: { size: 11 },
                                                    maxRotation: 45,
                                                    minRotation: 0
                                                }
                                            }
                                        },
                                        interaction: {
                                            intersect: false,
                                            mode: 'index'
                                        }
                                    }
                                });
                                
                                console.log('✅ 차트 업데이트 완료!');
                            }
                            </script>
                        </div>

                        <!-- Revenue Result (Initially Hidden or Updated via JS) -->
                        <div class="revenue-predictions hidden" id="revenue-predictions">
                            <div class="revenue-card wholesale-revenue">
                                <div class="revenue-label">
                                    <i data-lucide="store"></i>
                                    도매 예상 수입
                                </div>
                                <div class="revenue-value" id="wholesale-revenue">--</div>
                            </div>
                            <div class="revenue-card retail-revenue">
                                <div class="revenue-label">
                                    <i data-lucide="shopping-cart"></i>
                                    소매 예상 수입
                                </div>
                                <div class="revenue-value" id="retail-revenue">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Price Analysis Section [NEW] -->
                    <div class="market-section glass full-width">
                        <div class="section-header">
                            <div class="header-left">
                                <i data-lucide="trending-up" class="header-icon"></i>
                                <div>
                                    <h3>실시간 시장 시세 분석</h3>
                                    <p class="section-desc">현재 작물의 도/소매 가격 동향 및 기간별 시세 추이를 확인합니다.</p>
                                </div>
                            </div>
                            <div class="market-controls">
                                <div class="period-tabs">
                                    <button class="active" data-period="week">1주일</button>
                                    <button data-period="month">1개월</button>
                                    <button data-period="year">1년</button>
                                </div>
                            </div>
                        </div>

                        <div class="market-grid">
                            <div class="price-cards">
                                <div class="price-card wholesale">
                                    <div class="pc-header">가락시장 (도매)</div>
                                    <div class="pc-body">
                                        <div class="price-item">
                                            <span>최고가</span>
                                            <b id="wholesale-max">--</b>
                                        </div>
                                        <div class="price-item main">
                                            <span>평균가</span>
                                            <b id="wholesale-avg">--</b>
                                        </div>
                                        <div class="price-item">
                                            <span>최저가</span>
                                            <b id="wholesale-min">--</b>
                                        </div>
                                    </div>
                                </div>
                                <div class="price-card retail">
                                    <div class="pc-header">네이버 스마트스토어 (소매)</div>
                                    <div class="pc-body">
                                        <div class="price-item">
                                            <span>최고가</span>
                                            <b id="retail-max">--</b>
                                        </div>
                                        <div class="price-item main">
                                            <span>평균가</span>
                                            <b id="retail-avg">--</b>
                                        </div>
                                        <div class="price-item">
                                            <span>최저가</span>
                                            <b id="retail-min">--</b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="market-chart-container">
                                <canvas id="marketChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chart Area (External Environment Data) -->
                    <div class="chart-container glass hidden" id="outdoor-chart-container">
                        <div class="chart-header">
                            <h3>외부 환경 데이터 분석 (온도 및 습도 추이)</h3>
                            <div class="chart-actions">
                                <button class="active">24시간</button>
                                <button>7일</button>
                                <button>30일</button>
                            </div>
                        </div>
                        <canvas id="mainChart"></canvas>
                    </div>

                    <!-- Right Panel: Remote Controls Quick View -->


            </div>
    </div>
    </section>

    <!-- AI Solution Page (Hidden by default) -->
    <section id="ai-solution-page" class="page">
        <div class="page-header">
            <h1>AI 작물 분석 솔루션</h1>
            <p>딥러닝 Vision AI가 작물 이미지를 분석하여 병해충 진단 및 처방을 제공합니다.</p>
        </div>

        <div class="ai-grid">
            <!-- [New] AI Image Diagnosis Section -->
            <div class="glass ai-diagnosis-container" style="grid-column: 1 / -1;">
                <div class="diagnosis-header">
                    <h2>📸 AI 병해충 이미지 진단</h2>
                    <span class="badge premium">PREMIUM</span>
                </div>

                <div class="upload-area" id="drop-zone">
                    <input type="file" id="crop-image-input" accept="image/*" hidden>
                    <div class="upload-placeholder" id="upload-placeholder">
                        <i data-lucide="camera" style="font-size: 48px; color: #10b981; margin-bottom: 15px;"></i>
                        <p>터치하여 사진을 촬영하거나<br>갤러리에서 선택하세요</p>
                        <button class="upload-btn">사진 업로드</button>
                    </div>
                    <div class="image-preview hidden" id="image-preview-area">
                        <img id="preview-img" src="" alt="Crop Preview">
                        <button class="remove-img-btn" id="remove-img-btn"><i data-lucide="x"></i></button>
                    </div>
                </div>

                <div class="analysis-controls hidden" id="analysis-controls">
                    <div class="crop-type-select">
                        <label>작물 종류 (자동 감지됨)</label>
                        <select id="diagnosis-crop-type">
                            <option value="strawberry">딸기</option>
                            <option value="tomato">토마토</option>
                            <option value="paprika">파프리카</option>
                            <option value="cucumber">오이</option>
                            <option value="lettuce">상추</option>
                        </select>
                    </div>
                    <button class="primary-btn full-width" id="start-analysis-btn">
                        <i data-lucide="scan-line"></i> AI 정밀 진단 시작
                    </button>
                </div>

                <!-- Analysis Loading -->
                <div class="analysis-loading hidden" id="analysis-loading">
                    <div class="scanner-animation"></div>
                    <p id="loading-text">이미지 분석 중...</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="analysis-progress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Analysis Result -->
                <div class="analysis-result hidden" id="analysis-result">
                    <div class="result-header">
                        <div class="diagnosis-score">
                            <span class="label">진단 결과</span>
                            <h3 id="result-title">흰가루병 (Powdery Mildew)</h3>
                        </div>
                        <div class="confidence-badge" id="result-confidence">
                            정확도 98.2%
                        </div>
                    </div>

                    <div class="result-details">
                        <div class="detail-item">
                            <span class="icon">🔍</span>
                            <div class="info">
                                <strong>증상 (Symptom)</strong>
                                <p id="result-symptom">잎 표면에 밀가루를 뿌린 듯한 백색 반점이 발생하며 광합성을 저해합니다.</p>
                            </div>
                        </div>
                        <div class="detail-item danger">
                            <span class="icon">🚨</span>
                            <div class="info">
                                <strong>위험도 (Severity)</strong>
                                <p id="result-severity">심각 (조기 방제 필요)</p>
                            </div>
                        </div>
                    </div>

                    <div class="solution-box">
                        <h4>💡 AI 추천 해결 방안 (공공데이터 연동)</h4>
                        <ul class="solution-steps" id="result-solutions">
                            <!-- Dynamic Content -->
                        </ul>
                        <div class="chemical-recommendation">
                            <strong>💊 추천 약제 (농촌진흥청 기준)</strong>
                            <p id="result-chemicals">적용 약제: 폴리옥신비, 페나리몰 유제</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Existing Content (Moved down) -->

            <div class="glass ai-analysis">
                <h3>예상 수확시기 분석</h3>
                <div class="prediction-value">D-12 <span>(2026.01.23)</span></div>
                <p>현재 성장 속도는 평년 대비 5% 빠릅니다.</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 85%;"></div>
                </div>
                <span class="progress-text">현재 성장도: 85%</span>
            </div>
        </div>
    </section>

    <!-- Admin Page (Hidden by default) -->
    <section id="admin-page" class="page">
        <div class="page-header">
            <h1>관리자 모드</h1>
            <p>전체 농장의 수확량 정보를 지도에서 확인하세요</p>
        </div>

        <div class="admin-content">
            <div class="map-container glass">
                <div class="map-header">
                    <h3>농장 위치 지도</h3>
                    <div class="map-legend" style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.85em;">
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #3b82f6;"></span>
                            서울/경기
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #8b5cf6;"></span>
                            강원
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #10b981;"></span>
                            충청
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #f59e0b;"></span>
                            전라
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #ef4444;"></span>
                            경상
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #06b6d4;"></span>
                            제주
                        </span>
                    </div>
                </div>
                <div id="google-map"></div>
            </div>

            <div class="farm-list glass">
                <h3>등록된 농장 목록</h3>
                <div id="farm-cards-container">
                    <p class="no-data">등록된 농장이 없습니다.</p>
                </div>
            </div>

            <!-- [NEW] 공지사항 작성 섹션 -->
            <div class="notice-admin glass">
                <h3><i data-lucide="megaphone"></i> 공지사항 관리</h3>
                <div class="notice-form">
                    <input type="text" id="notice-title" placeholder="공지사항 제목" maxlength="50">
                    <textarea id="notice-content" placeholder="공지사항 내용을 입력하세요 (최대 5줄)" rows="5"
                        maxlength="500"></textarea>
                    <div class="notice-actions">
                        <button class="notice-save-btn" id="save-notice-btn">
                            <i data-lucide="save"></i> 공지 등록
                        </button>
                        <button class="notice-clear-btn" id="clear-notice-btn">
                            <i data-lucide="trash-2"></i> 공지 삭제
                        </button>
                    </div>
                </div>
                <div class="notice-preview">
                    <p class="preview-label">현재 등록된 공지:</p>
                    <div id="notice-preview-content">공지사항이 없습니다.</div>
                </div>
            </div>
        </div>
    </section>

    <style>
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .ai-card h2 {
            margin: 1.5rem 0 1rem;
            font-size: 1.25rem;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-list li {
            display: flex;
            gap: 1rem;
            align-items: start;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            width: fit-content;
        }

        .ai-status.healthy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary-color);
        }

        .ai-status.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-color);
        }

        .ai-status.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .ai-analysis h3 {
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            height: 12px;
            border-radius: 6px;
            margin: 1.5rem 0 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0;
            transition: width 1s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
    </style>
    </div>
    </main>
    </div>
    <script src="firebase_config.js?v=fix3"></script>
    <script src="auth.js?v=fix3"></script>
    <script src="app.js?v=fix3"></script>
    <script>
        // Start Lucide
        lucide.createIcons();

        // [AUTO LOGIN] Enforce Premium Login as per User Request
        // 이 코드는 사용자의 '프리미엄 로그인' 요청을 처리하기 위해 추가되었습니다.
        if (!localStorage.getItem('smartfarm_user') || JSON.parse(localStorage.getItem('smartfarm_user')).role !== 'premium') {
            const premiumUser = {
                id: 'premium_vip',
                name: 'VIP 농부',
                role: 'premium',
                farmName: '골드 클래스 농장'
            };
            localStorage.setItem('smartfarm_user', JSON.stringify(premiumUser));
            console.log('✅ 프리미엄 계정으로 자동 로그인 설정됨');
        }

        // [System] Guaranteed Analysis Engine (Embedded)
        document.addEventListener('DOMContentLoaded', () => {
            // [New] Dashboard Mode Switcher (Basic vs Premium)
            const navItems = document.querySelectorAll('.nav-item[data-page="dashboard"]');
            const premiumSection = document.querySelector('.premium-only');
            const mainTitle = document.querySelector('.monitor-header h2');
            const formTitle = document.querySelector('.form-section h5');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    // Check Mode
                    const mode = item.getAttribute('data-mode');

                    // [New] Premium Access Control
                    if (mode === 'premium') {
                        // Check if user is logged in (using localStorage from auth.js)
                        const user = JSON.parse(localStorage.getItem('smartfarm_user'));
                        // [Unlocked] 유료, 구독 시스템 해제 (누구나 접근 가능)
                        // const isPaidUser = user && (user.role === 'admin' || user.role === 'premium');
                        // if (!isPaidUser) {
                        //     e.preventDefault();
                        //     alert('🚫 프리미엄 멤버십 전용 기능입니다.\n\n로그인 후 이용하시거나 유료 서비스를 활성화해주세요.');
                        //     return;
                        // }
                    }

                    // [New] Reset Dashboard View on Menu Click
                    // 메뉴 이동 시 분석 결과를 초기화하여 '기본 화면' 상태로 리셋
                    const solutionList = document.querySelector('.solution-card-list');
                    const nutrientInfo = document.querySelector('.nutrient-target-info');
                    const nutrientBadge = document.querySelector('.nutrient-status-badge');

                    if (solutionList) {
                        solutionList.innerHTML = `
                            <li style="color: #94a3b8; text-align: center; padding: 30px 10px; font-size: 0.95em;">
                                <div style="margin-bottom: 10px; font-size: 2em; opacity: 0.5;">📊</div>
                                데이터를 입력하고 
                                <span style="color:#10b981; font-weight:bold;">[통합 분석 및 데이터 반영]</span> 
                                버튼을 눌러주세요.
                            </li>
                        `;
                    }
                    if (nutrientInfo) nutrientInfo.innerHTML = '';
                    if (nutrientBadge) nutrientBadge.style.display = 'none';

                    // [NEW] 모든 입력 필드 초기화 (폼 리셋)
                    const form = document.getElementById('manual-data-form');
                    if (form) form.reset();

                    // [NEW] 양액 분석 결과 카드도 초기화
                    const nutrientCard = document.getElementById('nutrient-solution-card');
                    if (nutrientCard) {
                        nutrientCard.classList.add('hidden');
                        const nutrientList = document.getElementById('nutrient-solution-list');
                        if (nutrientList) {
                            nutrientList.innerHTML = '<li class="no-solution">데이터를 입력하고 분석을 실행하세요.</li>';
                        }
                    }

                    // [NEW] 수확량 예측 초기화
                    const yieldAmount = document.getElementById('yield-amount');
                    if (yieldAmount) yieldAmount.value = '';
                    const wholesaleRev = document.getElementById('wholesale-revenue');
                    const retailRev = document.getElementById('retail-revenue');
                    if (wholesaleRev) wholesaleRev.textContent = '--';
                    if (retailRev) retailRev.textContent = '--';

                    // 1. Activate Menu
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // 2. Switch Mode UI
                    const premiumSection = document.querySelector('.premium-only');
                    const premiumBanner = document.getElementById('premium-banner');
                    const basicSelectors = document.querySelector('.crop-selector-group'); // Basic selectors
                    const envSection = document.querySelector('.form-section'); // Environment section

                    if (mode === 'premium') {
                        // Premium Mode: Show Nutrient Section, Hide Basic Selectors (to match screenshot)
                        console.log('💎 프리미엄 모드 활성화 (index.html)');

                        // [FIX] .hidden 클래스 제거 후 인라인 스타일도 제거 (CSS !important 회피)
                        if (premiumSection) {
                            premiumSection.classList.remove('hidden');
                            premiumSection.style.display = ''; // 빈 값으로 CSS 기본값 사용
                            console.log('✅ 양액 섹션 표시:', premiumSection);
                        }

                        // 모든 premium-only 요소 표시
                        document.querySelectorAll('.premium-only').forEach(el => {
                            el.classList.remove('hidden');
                            el.style.display = '';
                            console.log('✅ premium-only 요소 표시');
                        });

                        if (mainTitle) mainTitle.textContent = '프리미엄 정밀 관제 (Premium)';

                        // Hide Basic Selectors to avoid duplication (Premium uses its own crop selector)
                        if (basicSelectors) {
                            basicSelectors.style.display = 'none';
                        }

                        // Hide Banner
                        if (premiumBanner) {
                            premiumBanner.style.display = 'none';
                        }
                    } else {
                        // Basic Mode: Show Basic Selectors, Hide Nutrient Section
                        console.log('🌿 베이직 모드 활성화 (index.html)');

                        // [FIX] 모든 premium-only 요소 숨김
                        document.querySelectorAll('.premium-only').forEach(el => {
                            el.classList.add('hidden');
                            console.log('✅ premium-only 요소 숨김');
                        });

                        if (mainTitle) mainTitle.textContent = '스마트 팜 통합 관제 (Basic)';

                        // Show Basic Selectors
                        if (basicSelectors) {
                            basicSelectors.style.display = 'flex';
                        }

                        // Show Banner
                        if (premiumBanner) {
                            premiumBanner.style.display = 'flex';
                        }
                    }
                });
            });

            // [CLEAN] 모든 인라인 분석 코드 제거됨
            // app.js의 initManualEntry() 함수가 모든 분석을 처리합니다.
            // (작물 선택 → 양액표준 선택 → 환경정보 입력 → 버튼 클릭 → 결과 출력)

            console.log("✅ 분석 로직은 app.js에서 처리됩니다 (initManualEntry)");

            /*
            // [제거된 복잡한 인라인 코드]
            // 모든 복잡한 분석 로직은 app.js의 initManualEntry()가 처리합니다.
            // (제거됨)
            */

            // [New] Unlock Premium Membership Feature
            const unlockBtn = document.getElementById('unlock-premium-btn');
            if (unlockBtn) {
                unlockBtn.addEventListener('click', () => {
                    // 1. Check Login
                    const userStr = localStorage.getItem('smartfarm_user');

                    if (!userStr) {
                        // If not logged in, simulate login or ask to login
                        const doLogin = confirm('로그인이 필요한 서비스입니다.\n\n[테스트 모드]\n임시 계정(user/premium)으로 즉시 로그인하시겠습니까?');
                        if (doLogin) {
                            const mockUser = { id: 'test_user', name: '김농부', role: 'premium', farmName: '희망 농장' };
                            localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                            alert('🎉 환영합니다! 프리미엄 등급으로 로그인되었습니다.\n\n이제 Premium Dashboard에 접근할 수 있습니다.');
                            window.location.reload();
                        }
                        return;
                    }

                    // 2. Process Payment (Simulation)
                    const user = JSON.parse(userStr);
                    if (user.role === 'premium' || user.role === 'admin') {
                        alert('이미 프리미엄 서비스를 이용 중입니다.');
                        return;
                    }

                    const confirmed = confirm('💎 프리미엄 멤버십 (월 9,900원)\n\n정밀 환경 제어, 양액 통합 분석, RTS 알고리즘 등 모든 고급 기능을 이용하시겠습니까?');

                    if (confirmed) {
                        // 3. Update Role
                        user.role = 'premium';
                        localStorage.setItem('smartfarm_user', JSON.stringify(user));

                        alert('결제가 완료되었습니다! 💳\n\n이제 [Premium Dashboard]의 모든 기능을 제한 없이 이용하실 수 있습니다.');
                        window.location.reload(); // Reload to reflect changes
                    }
                });
            }
        });
        // [Hotfix] Override Premium Unlock Logic & Auto Redirect
        // 기존 이벤트 리스너를 제거하고 새로운 로직을 적용하기 위해 요소 복제 및 교체
        const oldUnlockBtn = document.getElementById('unlock-premium-btn');
        if (oldUnlockBtn) {
            const newUnlockBtn = oldUnlockBtn.cloneNode(true);
            oldUnlockBtn.parentNode.replaceChild(newUnlockBtn, oldUnlockBtn);

            newUnlockBtn.addEventListener('click', () => {
                const userStr = localStorage.getItem('smartfarm_user');

                // 1. Not Logged In
                if (!userStr) {
                    const doLogin = confirm('로그인이 필요한 서비스입니다.\n\n[테스트 모드]\n임시 계정(user/premium)으로 즉시 로그인하시겠습니까?');
                    if (doLogin) {
                        const mockUser = { id: 'test_user', name: '김농부', role: 'premium', farmName: '희망 농장' };
                        localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                        localStorage.setItem('auto_redirect_premium', 'true');
                        alert('🎉 환영합니다! 프리미엄 등급으로 로그인되었습니다.\n\n[Premium Dashboard]로 이동합니다. 🚀');
                        window.location.reload();
                    }
                    return;
                }

                // 2. Already Premium
                const user = JSON.parse(userStr);
                if (user.role === 'premium' || user.role === 'admin') {
                    const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                    if (premiumNav) {
                        alert('이미 프리미엄 서비스를 이용 중이십니다.\n\n[Premium Dashboard]로 바로 이동합니다! 🚀');
                        premiumNav.click();
                    }
                    return;
                }

                // 3. Upgrade Payment
                const confirmed = confirm('💎 프리미엄 멤버십 (월 9,900원)\n\n정밀 환경 제어, 양액 통합 분석, RTS 알고리즘  고급 기능을 이용하시겠습니까?');
                if (confirmed) {
                    user.role = 'premium';
                    localStorage.setItem('smartfarm_user', JSON.stringify(user));
                    localSto('auto_redirect_premium', 'true');
                    alert('결제가 완료되었습니다! 💳\n\n모든 제한이 해제되었습니다.\n[Premium Dashboard]로 이동합니다.');
                    window.location.reload();
                }
            });
        }

        // [Auto Redirect System]
        if (localStorage.getItem('auto_redirect_premium') === 'true') {
            localStorage.removeItem('auto_redirect_premium'); // Clear flag
            setTimeout(() => {
                const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                if (premiumNav) {
                    console.log('🚀 Auto Redirecting to Premium Dashboard...');
                    premiumNav.click();
                }
            }, 500);
        }
    </script>
    <!-- [Payment Modal System] -->
    <style>
        /* Payment Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .payment-modal {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            padding: 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: modalFadeIn 0.3s ease-out;
            color: white;
            font-family: 'Pretendard', sans-serif;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-header {
            padding: 25px;
            background: linear-gradient(to right, #6366f1, #4f46e5);
            text-align: center;
        }

        .payment-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-body {
            padding: 30px 25px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-card:hover,
        .plan-card.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        .plan-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #a5b4fc;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .feature-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .payment-footer {
            padding: 20px 25px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .pay-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.6);
        }

        .processing-view {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- PortOne SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <div id="paymentModalOverlay" class="modal-overlay">
        <div class="payment-modal">
            <!-- Step 1: Selection -->
            <div id="paymentStep1">
                <div class="payment-header">
                    <h3>💎 Premium 멤버십</h3>
                    <p style="margin:5px 0 0 0; opacity:0.8; font-size:0.9em;">정밀 농업을 위한 최고의 선택</p>
                </div>
                <div class="payment-body">
                    <div class="plan-card selected">
                        <div>
                            <div style="font-weight:bold; font-size:1.1em; color:white;">Month Plan</div>
                            <div style="font-size:0.85em; color:#94a3b8; margin-top:4px;">매월 자동 결제</div>
                        </div>
                        <div class="plan-price" style="color:#fcd34d;">₩4,900 /월 <span
                                style="font-size:0.6em; text-decoration:line-through; color:#64748b;">(₩9,900)</span>
                        </div>
                    </div>
                    <ul class="feature-list">
                        <li>✅ <strong>RTS 기반</strong> 통합 정밀 분석 알고리즘</li>
                        <li>✅ 작물별/생육단계별 <strong>맞춤 처방</strong></li>
                        <li>✅ <strong>무제한</strong> 데이터 저장 및 리포트</li>
                        <li>✅ 우선 기술 지원 (VIP Support)</li>
                    </ul>
                </div>
                <div class="payment-footer">
                    <button class="pay-btn" id="confirmPaymentBtn">구독 시작하기</button>
                    <button style="background:none; border:none; color:#64748b; margin-top:10px; cursor:pointer;"
                        onclick="document.getElementById('paymentModalOverlay').style.display='none'; const basicNav = document.querySelector('.nav-item[data-mode=\'basic\']'); if(basicNav) basicNav.click();">닫기</button>
                </div>
            </div>

            <!-- Step 2: Processing -->
            <div id="paymentStep2" class="processing-view">
                <div class="spinner"></div>
                <h4 style="margin:0; font-size:1.2em;">결제 처리 중...</h4>
                <p style="color:#94a3b8; font-size:0.9em;">잠시만 기다려주세요.</p>
            </div>

            <!-- Step 3: Success -->
            <div id="paymentStep3" class="processing-view">
                <div style="font-size:3em; margin-bottom:15px;">🎉</div>
                <h4 style="margin:0; font-size:1.2em; color:#10b981;">구독 완료!</h4>
                <p style="color:#94a3b8; font-size:0.9em; text-align:center;">프리미엄 멤버십이 활성화되었습니다.<br>대시보드로 이동합니다.</p>
            </div>
        </div>
    </div>
    <script>
        // [Final Override] Payment Modal Logic
        // 이전의 모든 이벤트 리스너를 무시하고 모달 로직을 최우선으로 적용합니다.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                if (btn) {
                    // Remove previous listeners by cloning one last time
                    const finalBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalBtn, btn);

                    finalBtn.addEventListener('click', () => {
                        const userStr = localStorage.getItem('smartfarm_user');

                        // 1. Login Check
                        if (!userStr) {
                            if (confirm('로그인이 필요한 서비스입니다.\n\n[테스트 모드]\n임시 계정(user/premium)으로 로그인하시겠습니까?')) {
                                const mockUser = { id: 'test_user', name: '김농부', role: 'premium', farmName: '희망 농장' };
                                localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                                localStorage.setItem('auto_redirect_premium', 'true');
                                alert('🎉 환영합니다! 프리미엄 등급으로 로그인되었습니다.');
                                window.location.reload();
                            }
                            return;
                        }

                        // 2. Already Premium Check
                        const user = JSON.parse(userStr);
                        if (user.role === 'premium' || user.role === 'admin') {
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) {
                                alert('이미 프리미엄 멤버십을 이용 중입니다. 💎\n[Premium Dashboard]로 이동합니다.');
                                premiumNav.click();
                            }
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset UI state
                            document.getElementById('paymentStep1').style.display = 'block';
                            document.getElementById('paymentStep2').style.display = 'none';
                            document.getElementById('paymentStep3').style.display = 'none';

                            // Payment Action
                            const payBtn = document.getElementById('confirmPaymentBtn');
                            payBtn.onclick = () => {
                                // Switch to Processing
                                document.getElementById('paymentStep1').style.display = 'none';
                                document.getElementById('paymentStep2').style.display = 'flex';

                                // Simulate API Call (2s)
                                setTimeout(() => {
                                    // Success Layout
                                    document.getElementById('paymentStep2').style.display = 'none';
                                    document.getElementById('paymentStep3').style.display = 'flex';

                                    // Execute Upgrade
                                    user.role = 'premium';
                                    localStorage.setItem('smartfarm_user', JSON.stringify(user)); localStorage.setItem('auto_redirect_premium', 'true');

                                    // Redirect
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                }, 2000);
                            };
                        } else {
                            // Modal not found fallback
                            if (confirm('결제 모듈 오류. 강제 업그레이드 하시겠습니까?')) {
                                user.role = 'premium';
                                localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                window.location.reload();
                            }
                        }
                    });
                }
            }, 200); // Delay to ensure DOM is ready and previous scripts ran
        });
    </script>
    <script>
        // [Real Payment Override] PortOne Integration (Test Mode)
        // 실제 결제 모듈(아임포트)을 연동하여 PG사 결제창을 호출합니다.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                const paymentBtn = document.getElementById('confirmPaymentBtn');

                // 4,900원 가격 반영 확인 및 강제 수정 (혹시 실패했을 경우 대비)
                const priceEls = document.querySelectorAll('.plan-price');
                priceEls.forEach(el => {
                    if (!el.innerHTML.includes('4,900')) {
                        el.innerHTML = '₩4,900 /월 <span style="font-size:0.6em; text-decoration:line-through; color:#64748b;">(₩9,900)</span>';
                    }
                });
                if (paymentBtn && !paymentBtn.innerText.includes('4,900')) {
                    paymentBtn.innerText = '구독 시작하기 (4,900원)';
                }

                if (btn) {
                    // Remove previous listeners (Clone & Replace)
                    const finalRealBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalRealBtn, btn);

                    finalRealBtn.addEventListener('click', () => {
                        const userStr = localStorage.getItem('smartfarm_user');

                        // 1. Login Check
                        if (!userStr) {
                            if (confirm('로그인이 필요한 서비스입니다.\n\n[테스트 모드]\n임시 계정(user/premium)으로 로그인하시겠습니까?')) {
                                const mockUser = { id: 'test_user', name: '김농부', role: 'premium', farmName: '희망 농장' };
                                localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                                localStorage.setItem('auto_redirect_premium', 'true');
                                alert('🎉 환영합니다! 프리미엄 등급으로 로그인되었습니다.');
                                window.location.reload();
                            }
                            return;
                        }

                        // 2. Already Premium Check
                        const user = JSON.parse(userStr);
                        if (user.role === 'premium' || user.role === 'admin') {
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) {
                                alert('이미 프리미엄 멤버십을 이용 중입니다. 💎\n[Premium Dashboard]로 이동합니다.');
                                premiumNav.click();
                            }
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset UI
                            document.getElementById('paymentStep1').style.display = 'block';
                            document.getElementById('paymentStep2').style.display = 'none';
                            document.getElementById('paymentStep3').style.display = 'none';

                            // 4. Real Payment Action (PortOne)
                            const realPayBtn = document.getElementById('confirmPaymentBtn');
                            realPayBtn.onclick = () => {
                                // Hide Plan
                                document.getElementById('paymentStep1').style.display = 'none';

                                // Check SDK
                                if (!window.IMP) {
                                    alert('결제 모듈이 로드되지 않았습니다. 새로고침 해주세요.');
                                    window.location.reload();
                                    return;
                                }

                                // Init PortOne
                                const IMP = window.IMP;
                                IMP.init('imp14397622'); // Public Test Code for KG, Kakao

                                // Request Pay
                                IMP.request_pay({
                                    pg: 'html5_inicis', // KG Inicis
                                    pay_method: 'card',
                                    merchant_uid: 'mid_' + new Date().getTime(),
                                    name: '스마트팜 Premium 월간 구독 (4,900원)',
                                    amount: 4900,
                                    buyer_email: 'test@farm.com',
                                    buyer_name: user.name,
                                    buyer_tel: '010-1234-5678',
                                }, function (rsp) {
                                    if (rsp.success) {
                                        // Success Layout
                                        document.getElementById('paymentStep2').style.display = 'flex';

                                        setTimeout(() => {
                                            // Upgrade
                                            user.role = 'premium';
                                            localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                            localStorage.setItem('auto_redirect_premium', 'true');


                                            document.getElementById('paymentStep2').style.display = 'none';
                                            document.getElementById('paymentStep3').style.display = 'flex';

                                            // Redirect
                                            setTimeout(() => { window.location.reload(); }, 1500);
                                        }, 1000);
                                    } else {
                                        // Fail
                                        alert('결제 실패: ' + rsp.error_msg);
                                        document.getElementById('paymentStep1').style.display = 'block';
                                    }
                                });
                            };
                        }
                    });
                }
            }, 500); // Override all previous logic
        });
    </script>
    <script>
        // [Hotfix] Force Logout Handler
        // 로그아웃 버튼이 제대로 동작하지 않는 문제를 해결하기 위해 이벤트를 강제로 재할당합니다.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    console.log("Found logout button, attaching force handler.");

                    // Remove existing listeners by cloning
                    const newLogoutBtn = logoutBtn.cloneNode(true);
                    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

                    newLogoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log("Logout clicked.");

                        // 1. Firebase SignOut
                        if (typeof firebase !== 'undefined') {
                            firebase.auth().signOut().then(() => {
                                console.log("Firebase signed out successfully.");
                                clearLocalAndRedirect();
                            }).catch((err) => {
                                console.error("Firebase signout failed:", err);
                                clearLocalAndRedirect();
                            });
                        } else {
                            // 2. Local Only
                            clearLocalAndRedirect();
                        }
                    });
                }
            }, 800); // Wait for other scripts to initialize
        });

        function clearLocalAndRedirect() {
            sessionStorage.clear();
            localStorage.removeItem('currentUser');
            // 'users'는 지우지 않음 (로컬 가입 데이터 유지)
            window.location.href = 'login.html';
        }
    </script>
    <script>
        // [Final Payment Logic] 
        // 이전의 결제 스크립트들이 잘못된 키(smartfarm_user)를 사용하는 문제를 해결하기 위해
        // 가장 마지막에 실행되어 올바른 로직(currentUser, Firestore 연동)으로 덮어씌웁니다.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                if (btn) {
                    console.log("Applying Final Payment Logic...");
                    const finalBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalBtn, btn);

                    finalBtn.addEventListener('click', () => {
                        // 1. Get User (Standard Key from auth.js)
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');

                        if (!userStr) {
                            if (confirm('로그인이 필요한 서비스입니다.\n로그인 페이지로 이동하시겠습니까?')) {
                                window.location.href = 'login.html';
                            }
                            return;
                        }

                        const user = JSON.parse(userStr);

                        // 2. Already Premium Check
                        if (user.role === 'premium' || user.role === 'admin') {
                            alert('이미 프리미엄 멤버십을 이용 중입니다. 💎');
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) premiumNav.click();
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset Steps
                            const step1 = document.getElementById('paymentStep1');
                            const step2 = document.getElementById('paymentStep2');
                            const step3 = document.getElementById('paymentStep3');
                            if (step1) step1.style.display = 'block';
                            if (step2) step2.style.display = 'none';
                            if (step3) step3.style.display = 'none';

                            // 4. Handle Payment
                            const payBtn = document.getElementById('confirmPaymentBtn');
                            if (payBtn) {
                                // Ensure price text
                                if (!payBtn.innerText.includes('4,900')) payBtn.innerText = '구독 시작하기 (4,900원)';

                                payBtn.onclick = () => {
                                    if (step1) step1.style.display = 'none';

                                    if (!window.IMP) {
                                        alert('결제 모듈 로드 실패. 새로고침 해주세요.');
                                        return;
                                    }

                                    const IMP = window.IMP;
                                    IMP.init('imp14397622');

                                    IMP.request_pay({
                                        pg: 'html5_inicis',
                                        pay_method: 'card',
                                        merchant_uid: 'mid_' + new Date().getTime(),
                                        name: '스마트팜 Premium (4,900원)',
                                        amount: 4900,
                                        buyer_email: user.email,
                                        buyer_name: user.name,
                                    }, function (rsp) {
                                        if (rsp.success) {
                                            if (step2) step2.style.display = 'flex'; // Processing...

                                            // Upgrade Logic
                                            setTimeout(() => {
                                                user.role = 'premium';
                                                localStorage.setItem('currentUser', JSON.stringify(user));
                                                if (sessionStorage.getItem('currentUser')) {
                                                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                                                }
                                                // Auto Redirect Flag
                                                localStorage.setItem('auto_redirect_premium', 'true');

                                                // ★ Firestore Update ★
                                                if (typeof firebase !== 'undefined' && firebase.firestore && user.uid) {
                                                    firebase.firestore().collection('users').doc(user.uid).update({
                                                        role: 'premium'
                                                    }).then(() => console.log("DB Updated"));
                                                }

                                                if (step2) step2.style.display = 'none';
                                                if (step3) step3.style.display = 'flex'; // Success

                                                setTimeout(() => { window.location.reload(); }, 1500);
                                            }, 1000);
                                        } else {
                                            alert('결제 실패: ' + rsp.error_msg);
                                            if (step1) step1.style.display = 'block';
                                        }
                                    });
                                };
                            }
                        }
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <script>
        // [New] Premium Nav Click -> Auto Trigger Payment
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                const unlockBtn = document.getElementById('unlock-premium-btn');

                if (premiumNav && unlockBtn) {
                    console.log("Attaching Premium Nav Auto-Trigger");
                    av.addEventListener('click', (e) => {
                        // Check User Role
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                        if (userStr) {
                            const user = JSON.parse(userStr);
                            // If Basic user clicks Premium, trigger the payment modal
                            if (user.role !== 'premium' && user.role !== 'admin') {
                                console.log("Basic User detected on Premium Tab -> Triggering Payment Modal");
                                setTimeout(() => {
                                    unlockBtn.click();
                                }, 300); // Small delay to let tab switch visually update first
                            }
                        }
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <script>
        // [New] Basic Nav Click -> Reset View
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const basicNav = document.querySelector('.nav-item[data-mode="basic"]');
                if (basicNav) {
                    console.log("Attaching Basic Nav View Reset Listener");
                    basicNav.addEventListener('click', (e) => {
                        console.log("Resetting to Basic View...");
                        // Hide Premium Fields
                        document.querySelectorAll('.premium-only').forEach(el => el.classList.add('hidden'));
                        // Relock Cards
                        document.querySelectorAll('.premium-locked').forEach(el => el.classList.remove('unlocked'));
                        // Reset Form Styles
                        document.querySelectorAll('.entry-form').forEach(el => el.classList.remove('pactive'));

                        // Show Banner if user is Basic
                        const premiumBanner = document.getElementById('premium-banner');
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                        let isPremium = false;
                        if (userStr) {
                            const user = JSON.parse(userStr);
                            if (user.role === 'premium' || user.role === 'admin') isPremium = true;
                        }

                        if (premiumBanner && !isPremium) {
                            premiumBanner.classList.remove('hidden');
                        }

                        // Scroll to Top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item active nav-item" data-page="dashboard" data-mode="basic">
            <i data-lucide="layout-dashboard"></i>
            <span>Basic</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item" data-page="dashboard" data-mode="premium">
            <i data-lucide="crown"></i>
            <span>Premium</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item hidden" data-page="admin" id="admin-nav-mobile">
            <i data-lucide="map"></i>
            <span>Map</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="logout()">
            <i data-lucide="log-out"></i>
            <span>Logout</span>
        </a>
    </nav>
</body>

</html>