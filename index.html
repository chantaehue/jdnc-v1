<!DOCTYPE html>
<html lang="ko">

<head>
    <script>
        // [Security] Auth Guard
        // Check local storage immediately. If no user, redirect to login.
        (function () {
            const user = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
            if (!user) {
                window.location.replace('login.html');
            }
        })();
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Latest Deployment: 2026-01-13 23:31:00 -->
    <title>JDNC Farm Tech - í†µí•© ì˜¨ì‹¤ ëª¨ë‹ˆí„°ë§ ì†”ë£¨ì…˜</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Firebase SDK (Compat v9) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <!-- Leaflet Map (Free Alternative to Google Maps) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css?v=fix4">
    <!-- [Critical Fix] Limit mobile.css to mobile devices only -->
    <link rel="stylesheet" href="mobile.css?v=fix4" media="(max-width: 768px)">
</head>

<body>
    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i data-lucide="leaf"></i>
                <span>JDNC<br>Farm Tech</span>
            </div>
            <nav>
                <a href="#" class="nav-item active" data-page="dashboard" data-mode="basic"
                    onclick="openPage('dashboard'); return false;">
                    <i data-lucide="layout-dashboard"></i>
                    <span>ë² ì´ì§ ì˜¨ì‹¤</span>
                </a>
                <a href="#" class="nav-item" data-page="dashboard" data-mode="premium"
                    onclick="openPage('dashboard'); return false;">
                    <i data-lucide="crown"></i>
                    <span>ì–‘ì•¡ ì¬ë°° ì˜¨ì‹¤<br>(ìŠ¤ë§ˆíŠ¸íŒœ)</span>
                </a>
                <a href="#" class="nav-item" data-page="control"
                    onclick="alert('ğŸš§ ì›ê²© ì œì–´ ì‹œìŠ¤í…œ ì—…ê·¸ë ˆì´ë“œ ì¤‘ì…ë‹ˆë‹¤.'); return false;">
                    <i data-lucide="toggle-right"></i>
                    <span>ì›ê²© ì œì–´</span>
                </a>

                <a href="#" class="nav-item" data-page="ai-solution" onclick="openPage('ai-solution'); return false;">
                    <i data-lucide="sparkles"></i>
                    <span>AI ì‘ë¬¼ ë¶„ì„ ì†”ë£¨ì…˜</span>
                </a>
                <!-- [Security] Admin Only Menu - Hidden by default, shown via JS for admin users -->
                <a href="#" class="nav-item hidden" data-page="admin" id="admin-nav-item"
                    onclick="openAdminPage(); return false;">
                    <i data-lucide="map-pin"></i>
                    <span>ê´€ë¦¬ì ëª¨ë“œ</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="user-profile">
                    <div class="avatar"></div>
                    <div class="user-info">
                        <p class="name" id="user-name">ì‚¬ìš©ì</p>
                        <p class="role" id="user-farm">ë‚´ ìŠ¤ë§ˆíŠ¸íŒœ</p>
                        <p id="db-connection-status" style="font-size:0.7em; color:#94a3b8; margin-top:2px;">âšª Local
                            Mode</p>
                    </div>
                </div>
                <button class="logout-btn" id="logout-btn" title="ë¡œê·¸ì•„ì›ƒ">
                    <i data-lucide="log-out"></i>
                    <span>ë¡œê·¸ì•„ì›ƒ</span>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content" id="main-content-area">
            <header class="top-bar">
                <div class="search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
                </div>
                <div class="top-actions">
                    <div class="weather-info">
                        <i data-lucide="sun"></i>
                        <span>24Â°C ë§‘ìŒ</span>
                    </div>
                    <button class="icon-btn">
                        <i data-lucide="bell"></i>
                        <span class="badge"></span>
                    </button>
                    <button class="icon-btn">
                        <i data-lucide="settings"></i>
                    </button>
                </div>
            </header>

            <div id="content-area" class="content-area">
                <!-- Dashboard Page -->
                <section id="dashboard-page" class="page active">
                    <div class="page-header">
                        <h1>ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ</h1>
                        <p>í˜„ì¬ ì˜¨ì‹¤ì˜ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•©ë‹ˆë‹¤.</p>
                    </div>

                    <!-- [NEW] ê³µì§€ì‚¬í•­ í‘œì‹œ ì˜ì—­ -->
                    <div id="dashboard-notice" class="dashboard-notice glass hidden">
                        <div class="notice-header">
                            <i data-lucide="bell"></i>
                            <span class="notice-title-display">ê³µì§€ì‚¬í•­</span>
                            <button class="notice-close-btn" id="close-notice-btn">
                                <i data-lucide="x"></i>
                            </button>
                        </div>
                        <div class="notice-body" id="notice-body-content">
                            <!-- ê³µì§€ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                    </div>

                    <div class="grid-container">
                        <!-- Outdoor Status Card (NEW) -->
                        <div class="stat-card glass outdoor-card">
                            <div class="card-header">
                                <span class="badge-outdoor">EXTERNAL</span>
                                <h3>ì™¸ë¶€ í™˜ê²½ (ì‹¤ì‹œê°„)</h3>
                            </div>
                            <div class="outdoor-grid">
                                <div class="outdoor-item">
                                    <i data-lucide="thermometer-sun"></i>
                                    <div class="outdoor-info">
                                        <p>ì‹¤ì™¸ ì˜¨ë„</p>
                                        <span id="out-temp">--</span>Â°C
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="droplets"></i>
                                    <div class="outdoor-info">
                                        <p>ì‹¤ì™¸ ìŠµë„</p>
                                        <span id="out-hum">--</span>%
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="wind"></i>
                                    <div class="outdoor-info">
                                        <p>í’ì†</p>
                                        <span id="out-wind">--</span> km/h
                                    </div>
                                </div>
                                <div class="outdoor-item">
                                    <i data-lucide="cloud-rain"></i>
                                    <div class="outdoor-info">
                                        <p>ê°•ìˆ˜ í™•ë¥ </p>
                                        <span id="out-rain">--</span>%
                                    </div>
                                </div>
                            </div>
                            <div class="location-info">
                                <i data-lucide="map-pin"></i>
                                <span id="current-location">ì„œìš¸ (ê¸°ë³¸ê°’)</span>
                            </div>
                            <div class="outdoor-actions">
                                <button class="location-btn" id="get-my-location-btn">
                                    <i data-lucide="navigation"></i>
                                    ë‚´ ìœ„ì¹˜ ë‚ ì”¨
                                </button>
                                <!-- Data Analysis Button Removed as requested -->
                            </div>
                        </div>

                        <!-- Manual Data Entry Section (Moved to first position) -->
                        <div class="manual-entry glass">
                            <div class="entry-header">
                                <div>
                                    <h3>ì˜¨ì‹¤ ë‚´ë¶€ ì •ë³´ ì…ë ¥</h3>
                                    <p class="section-desc">í˜„ì¬ ì˜¨ì‹¤ì˜ ì‹¤ì¸¡ ë°ì´í„°ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì‹œìŠ¤í…œì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.</p>
                                </div>
                                <div class="crop-selector-group">
                                    <div class="selector-item">
                                        <label for="select-crop">ëŒ€ìƒ ì‘ë¬¼</label>
                                        <select id="select-crop">
                                            <option value="strawberry">ë”¸ê¸°</option>
                                            <option value="tomato">í† ë§ˆí† </option>
                                            <option value="lettuce">ìƒì¶”</option>
                                            <option value="cucumber">ì˜¤ì´</option>
                                            <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                                            <option value="eggplant">ê°€ì§€</option>
                                            <option value="leafy">ì—½ì±„ë¥˜</option>
                                            <option value="melon">ë©œë¡ </option>
                                        </select>
                                    </div>
                                    <div class="selector-item">
                                        <label for="select-standard">ì–‘ì•¡ í‘œì¤€ ê¸°ì¤€</label>
                                        <select id="select-standard">
                                            <option value="domestic">êµ­ë‚´ í‘œì¤€ (K-Farm)</option>
                                            <option value="international">êµ­ì œ í‘œì¤€ (Wageningen)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <form id="manual-data-form" class="entry-form-advanced">
                                <!-- Group 1: Environment -->
                                <div class="form-section">
                                    <h5>í™˜ê²½ ì •ë³´</h5>
                                    <div class="section-inputs">
                                        <div class="input-group">
                                            <label>ëŒ€ê¸° ì˜¨ë„ (Â°C)</label>
                                            <input type="number" id="input-temp" step="0.1" placeholder="25.4">
                                        </div>
                                        <div class="input-group">
                                            <label>ìŠµë„ (%)</label>
                                            <input type="number" id="input-hum" step="1" placeholder="60">
                                        </div>
                                        <div class="input-group">
                                            <label>ê´‘ë„ (lux)</label>
                                            <input type="number" id="input-light" step="100" placeholder="15000">
                                        </div>
                                        <div class="input-group">
                                            <label>CO2 (ppm)</label>
                                            <input type="number" id="input-co2" step="10" placeholder="400">
                                        </div>
                                        <div class="input-group">
                                            <label>ì—½ì˜¨ë„ (Â°C)</label>
                                            <input type="number" id="input-leaf-temp" step="0.1" placeholder="24.3">
                                        </div>
                                    </div>
                                </div>

                                <!-- Group 2: Nutrient (Premium) -->
                                <div class="form-section premium-only hidden">
                                    <div class="nutrient-header">
                                        <h5>ì–‘ì•¡ ì •ë³´ (ê³µê¸‰ / ê·¼ê¶Œ / ë°°ì•¡)</h5>
                                        <div class="nutrient-selectors">
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-crop-select">ì‘ë¬¼</label>
                                                <select id="nutrient-crop-select">
                                                    <option value="strawberry">ë”¸ê¸°</option>
                                                    <option value="tomato">í† ë§ˆí† </option>
                                                    <option value="lettuce">ìƒì¶”</option>
                                                    <option value="cucumber">ì˜¤ì´</option>
                                                    <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                                                    <option value="eggplant">ê°€ì§€</option>
                                                    <option value="leafy">ì—½ì±„ë¥˜</option>
                                                    <option value="melon">ë©œë¡ </option>
                                                </select>
                                            </div>
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-stage-select">ìƒìœ¡ ë‹¨ê³„</label>
                                                <select id="nutrient-stage-select">
                                                    <option value="planting">ì •ì‹ê¸° (Planting)</option>
                                                    <option value="vegetative">ì˜ì–‘ ìƒì¥ê¸° (Vegetative)</option>
                                                    <option value="flowering">ê°œí™”ê¸° (Flowering)</option>
                                                    <option value="fruiting">ê³¼ì‹¤ ë¹„ëŒ€ê¸° (Fruiting)</option>
                                                    <option value="harvest">ìˆ˜í™•ê¸° (Harvest)</option>
                                                    <option value="late">ìˆ˜í™• í›„ê¸° (Late)</option>
                                                </select>
                                            </div>
                                            <div class="nutrient-selector-item">
                                                <label for="nutrient-standard-select">í‘œì¤€</label>
                                                <select id="nutrient-standard-select">
                                                    <option value="yamazaki">ì•¼ë§ˆìí‚¤ (Yamazaki)</option>
                                                    <option value="japan_enshi">ì¼ë³¸ì›ì‹œ (Japan Enshi)</option>
                                                    <option value="netherlands">ë„¤ëœë€ë“œ (PBG)</option>
                                                    <option value="korea_rda">ë†ì§„ì²­ (Korea RDA)</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="section-inputs-nutrient">
                                        <div class="nutrient-sub-group">
                                            <p>ê³µê¸‰ (In)</p>
                                            <input type="number" id="input-in-ec" step="0.1" placeholder="EC 1.8">
                                            <input type="number" id="input-in-ph" step="0.1" placeholder="pH 5.8">
                                        </div>
                                        <div class="nutrient-sub-group">
                                            <p>ê·¼ê¶Œ (Root)</p>
                                            <input type="number" id="input-root-ec" step="0.1" placeholder="EC 2.2">
                                            <input type="number" id="input-root-ph" step="0.1" placeholder="pH 6.2">
                                            <input type="number" id="input-root-temp" step="0.1"
                                                placeholder="Temp 20.5">
                                            <input type="number" id="input-root-hum" step="1" placeholder="Hum 70">
                                        </div>
                                        <div class="nutrient-sub-group">
                                            <p>ë°°ì•¡ (Drain)</p>
                                            <input type="number" id="input-drain-ec" step="0.1" placeholder="EC 2.0">
                                            <input type="number" id="input-drain-ph" step="0.1" placeholder="pH 6.5">
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" id="analysis-submit-btn" class="submit-btn full-width">í†µí•© ë¶„ì„ ë° ë°ì´í„°
                                    ë°˜ì˜</button>
                            </form>

                            <!-- Nutrient Solution Results -->
                            <div id="nutrient-solution-card" class="nutrient-solution-card glass hidden">
                                <div class="solution-header">
                                    <h4>ì–‘ì•¡ ë¶„ì„ ê²°ê³¼</h4>
                                    <div class="solution-status">
                                        <span class="status-badge" id="nutrient-status-badge">ë¶„ì„ ëŒ€ê¸°</span>
                                        <span class="target-info" id="nutrient-target-info">ëª©í‘œê°’ì„ í™•ì¸í•˜ì„¸ìš”</span>
                                    </div>
                                </div>
                                <ul class="solution-list" id="nutrient-solution-list">
                                    <li class="no-solution">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</li>
                                </ul>
                            </div>


                        </div>
                    </div>

                    <!-- Harvest Info Registration Section -->
                    <div class="yield-input-section glass full-width">
                        <div class="yield-header">
                            <div class="header-left">
                                <i data-lucide="map-pin" class="header-icon"></i>
                                <div>
                                    <h3>ìˆ˜í™•ëŸ‰ ë“±ë¡ ë° ì‹œì„¸ ì¡°íšŒ</h3>
                                    <p class="section-desc">ìˆ˜í™•ëŸ‰ì„ ì§€ë„ì— ë“±ë¡í•˜ê³  ì‹¤ì‹œê°„ ì˜ˆìƒ ìˆ˜ìµì„ í™•ì¸í•˜ì„¸ìš”.</p>
                                </div>
                            </div>
                        </div>

                        <div class="yield-input-container">
                            <div class="yield-input-group">
                                <label for="market-crop-select">
                                    <i data-lucide="sprout"></i>
                                    ì‘ë¬¼ ì„ íƒ
                                </label>
                                <select id="market-crop-select" class="yield-select">
                                    <option value="strawberry">ë”¸ê¸°</option>
                                    <option value="tomato">í† ë§ˆí† </option>
                                    <option value="lettuce">ìƒì¶”</option>
                                    <option value="cucumber">ì˜¤ì´</option>
                                    <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                                    <option value="eggplant">ê°€ì§€</option>
                                    <option value="leafy">ì—½ì±„ë¥˜</option>
                                    <option value="melon">ë©œë¡ </option>
                                </select>
                            </div>

                            <div class="yield-input-group">
                                <label for="yield-amount">
                                    <i data-lucide="package"></i>
                                    ì˜ˆìƒ ìˆ˜í™•ëŸ‰
                                </label>
                                <div class="input-with-unit">
                                    <input type="number" id="yield-amount" placeholder="100" min="0" step="1">
                                    <span class="unit">kg</span>
                                </div>
                            </div>

                            <!-- Register Button -->
                            <button id="register-map-btn" class="analyze-btn">
                                <i data-lucide="search"></i>
                                ì‹œì„¸ ì¡°íšŒ
                            </button>
                        </div>

                        <!-- Revenue Result (Initially Hidden or Updated via JS) -->
                        <div class="revenue-predictions hidden" id="revenue-predictions">
                            <div class="revenue-card wholesale-revenue">
                                <div class="revenue-label">
                                    <i data-lucide="store"></i>
                                    ë„ë§¤ ì˜ˆìƒ ìˆ˜ì…
                                </div>
                                <div class="revenue-value" id="wholesale-revenue">--</div>
                            </div>
                            <div class="revenue-card retail-revenue">
                                <div class="revenue-label">
                                    <i data-lucide="shopping-cart"></i>
                                    ì†Œë§¤ ì˜ˆìƒ ìˆ˜ì…
                                </div>
                                <div class="revenue-value" id="retail-revenue">--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Price Analysis Section [NEW] -->
                    <div class="market-section glass full-width">
                        <div class="section-header">
                            <div class="header-left">
                                <i data-lucide="trending-up" class="header-icon"></i>
                                <div>
                                    <h3>ì‹¤ì‹œê°„ ì‹œì¥ ì‹œì„¸ ë¶„ì„</h3>
                                    <p class="section-desc">í˜„ì¬ ì‘ë¬¼ì˜ ë„/ì†Œë§¤ ê°€ê²© ë™í–¥ ë° ê¸°ê°„ë³„ ì‹œì„¸ ì¶”ì´ë¥¼ í™•ì¸í•©ë‹ˆë‹¤.</p>
                                </div>
                            </div>
                            <div class="market-controls">
                                <div class="period-tabs">
                                    <button class="active" data-period="week">1ì£¼ì¼</button>
                                    <button data-period="month">1ê°œì›”</button>
                                    <button data-period="year">1ë…„</button>
                                </div>
                            </div>
                        </div>

                        <div class="market-grid">
                            <div class="price-cards">
                                <div class="price-card wholesale">
                                    <div class="pc-header">ê°€ë½ì‹œì¥ (ë„ë§¤)</div>
                                    <div class="pc-body">
                                        <div class="price-item">
                                            <span>ìµœê³ ê°€</span>
                                            <b id="wholesale-max">--</b>
                                        </div>
                                        <div class="price-item main">
                                            <span>í‰ê· ê°€</span>
                                            <b id="wholesale-avg">--</b>
                                        </div>
                                        <div class="price-item">
                                            <span>ìµœì €ê°€</span>
                                            <b id="wholesale-min">--</b>
                                        </div>
                                    </div>
                                </div>
                                <div class="price-card retail">
                                    <div class="pc-header">ë„¤ì´ë²„ ìŠ¤ë§ˆíŠ¸ìŠ¤í† ì–´ (ì†Œë§¤)</div>
                                    <div class="pc-body">
                                        <div class="price-item">
                                            <span>ìµœê³ ê°€</span>
                                            <b id="retail-max">--</b>
                                        </div>
                                        <div class="price-item main">
                                            <span>í‰ê· ê°€</span>
                                            <b id="retail-avg">--</b>
                                        </div>
                                        <div class="price-item">
                                            <span>ìµœì €ê°€</span>
                                            <b id="retail-min">--</b>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="market-chart-container">
                                <canvas id="marketChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Main Chart Area (External Environment Data) -->
                    <div class="chart-container glass hidden" id="outdoor-chart-container">
                        <div class="chart-header">
                            <h3>ì™¸ë¶€ í™˜ê²½ ë°ì´í„° ë¶„ì„ (ì˜¨ë„ ë° ìŠµë„ ì¶”ì´)</h3>
                            <div class="chart-actions">
                                <button class="active">24ì‹œê°„</button>
                                <button>7ì¼</button>
                                <button>30ì¼</button>
                            </div>
                        </div>
                        <canvas id="mainChart"></canvas>
                    </div>

                    <!-- Right Panel: Remote Controls Quick View -->


            </div>
    </div>
    </section>

    <!-- AI Solution Page (Hidden by default) -->
    <section id="ai-solution-page" class="page">
        <div class="page-header">
            <h1>AI ì‘ë¬¼ ë¶„ì„ ì†”ë£¨ì…˜</h1>
            <p>ë”¥ëŸ¬ë‹ Vision AIê°€ ì‘ë¬¼ ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•˜ì—¬ ë³‘í•´ì¶© ì§„ë‹¨ ë° ì²˜ë°©ì„ ì œê³µí•©ë‹ˆë‹¤.</p>
        </div>

        <div class="ai-grid">
            <!-- [New] AI Image Diagnosis Section -->
            <div class="glass ai-diagnosis-container" style="grid-column: 1 / -1;">
                <div class="diagnosis-header">
                    <h2>ğŸ“¸ AI ë³‘í•´ì¶© ì´ë¯¸ì§€ ì§„ë‹¨</h2>
                    <span class="badge premium">PREMIUM</span>
                </div>

                <div class="upload-area" id="drop-zone">
                    <input type="file" id="crop-image-input" accept="image/*" hidden>
                    <div class="upload-placeholder" id="upload-placeholder">
                        <i data-lucide="camera" style="font-size: 48px; color: #10b981; margin-bottom: 15px;"></i>
                        <p>í„°ì¹˜í•˜ì—¬ ì‚¬ì§„ì„ ì´¬ì˜í•˜ê±°ë‚˜<br>ê°¤ëŸ¬ë¦¬ì—ì„œ ì„ íƒí•˜ì„¸ìš”</p>
                        <button class="upload-btn">ì‚¬ì§„ ì—…ë¡œë“œ</button>
                    </div>
                    <div class="image-preview hidden" id="image-preview-area">
                        <img id="preview-img" src="" alt="Crop Preview">
                        <button class="remove-img-btn" id="remove-img-btn"><i data-lucide="x"></i></button>
                    </div>
                </div>

                <div class="analysis-controls hidden" id="analysis-controls">
                    <div class="crop-type-select">
                        <label>ì‘ë¬¼ ì¢…ë¥˜ (ìë™ ê°ì§€ë¨)</label>
                        <select id="diagnosis-crop-type">
                            <option value="strawberry">ë”¸ê¸°</option>
                            <option value="tomato">í† ë§ˆí† </option>
                            <option value="paprika">íŒŒí”„ë¦¬ì¹´</option>
                            <option value="cucumber">ì˜¤ì´</option>
                            <option value="lettuce">ìƒì¶”</option>
                        </select>
                    </div>
                    <button class="primary-btn full-width" id="start-analysis-btn">
                        <i data-lucide="scan-line"></i> AI ì •ë°€ ì§„ë‹¨ ì‹œì‘
                    </button>
                </div>

                <!-- Analysis Loading -->
                <div class="analysis-loading hidden" id="analysis-loading">
                    <div class="scanner-animation"></div>
                    <p id="loading-text">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="analysis-progress" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Analysis Result -->
                <div class="analysis-result hidden" id="analysis-result">
                    <div class="result-header">
                        <div class="diagnosis-score">
                            <span class="label">ì§„ë‹¨ ê²°ê³¼</span>
                            <h3 id="result-title">í°ê°€ë£¨ë³‘ (Powdery Mildew)</h3>
                        </div>
                        <div class="confidence-badge" id="result-confidence">
                            ì •í™•ë„ 98.2%
                        </div>
                    </div>

                    <div class="result-details">
                        <div class="detail-item">
                            <span class="icon">ğŸ”</span>
                            <div class="info">
                                <strong>ì¦ìƒ (Symptom)</strong>
                                <p id="result-symptom">ì í‘œë©´ì— ë°€ê°€ë£¨ë¥¼ ë¿Œë¦° ë“¯í•œ ë°±ìƒ‰ ë°˜ì ì´ ë°œìƒí•˜ë©° ê´‘í•©ì„±ì„ ì €í•´í•©ë‹ˆë‹¤.</p>
                            </div>
                        </div>
                        <div class="detail-item danger">
                            <span class="icon">ğŸš¨</span>
                            <div class="info">
                                <strong>ìœ„í—˜ë„ (Severity)</strong>
                                <p id="result-severity">ì‹¬ê° (ì¡°ê¸° ë°©ì œ í•„ìš”)</p>
                            </div>
                        </div>
                    </div>

                    <div class="solution-box">
                        <h4>ğŸ’¡ AI ì¶”ì²œ í•´ê²° ë°©ì•ˆ (ê³µê³µë°ì´í„° ì—°ë™)</h4>
                        <ul class="solution-steps" id="result-solutions">
                            <!-- Dynamic Content -->
                        </ul>
                        <div class="chemical-recommendation">
                            <strong>ğŸ’Š ì¶”ì²œ ì•½ì œ (ë†ì´Œì§„í¥ì²­ ê¸°ì¤€)</strong>
                            <p id="result-chemicals">ì ìš© ì•½ì œ: í´ë¦¬ì˜¥ì‹ ë¹„, í˜ë‚˜ë¦¬ëª° ìœ ì œ</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Existing Content (Moved down) -->

            <div class="glass ai-analysis">
                <h3>ì˜ˆìƒ ìˆ˜í™•ì‹œê¸° ë¶„ì„</h3>
                <div class="prediction-value">D-12 <span>(2026.01.23)</span></div>
                <p>í˜„ì¬ ì„±ì¥ ì†ë„ëŠ” í‰ë…„ ëŒ€ë¹„ 5% ë¹ ë¦…ë‹ˆë‹¤.</p>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: 85%;"></div>
                </div>
                <span class="progress-text">í˜„ì¬ ì„±ì¥ë„: 85%</span>
            </div>
        </div>
    </section>

    <!-- Admin Page (Hidden by default) -->
    <section id="admin-page" class="page">
        <div class="page-header">
            <h1>ê´€ë¦¬ì ëª¨ë“œ</h1>
            <p>ì „ì²´ ë†ì¥ì˜ ìˆ˜í™•ëŸ‰ ì •ë³´ë¥¼ ì§€ë„ì—ì„œ í™•ì¸í•˜ì„¸ìš”</p>
        </div>

        <div class="admin-content">
            <div class="map-container glass">
                <div class="map-header">
                    <h3>ë†ì¥ ìœ„ì¹˜ ì§€ë„</h3>
                    <div class="map-legend" style="display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.85em;">
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #3b82f6;"></span>
                            ì„œìš¸/ê²½ê¸°
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #8b5cf6;"></span>
                            ê°•ì›
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #10b981;"></span>
                            ì¶©ì²­
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #f59e0b;"></span>
                            ì „ë¼
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #ef4444;"></span>
                            ê²½ìƒ
                        </span>
                        <span class="legend-item">
                            <span class="legend-dot" style="background: #06b6d4;"></span>
                            ì œì£¼
                        </span>
                    </div>
                </div>
                <div id="google-map"></div>
            </div>

            <div class="farm-list glass">
                <h3>ë“±ë¡ëœ ë†ì¥ ëª©ë¡</h3>
                <div id="farm-cards-container">
                    <p class="no-data">ë“±ë¡ëœ ë†ì¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>

            <!-- [NEW] ê³µì§€ì‚¬í•­ ì‘ì„± ì„¹ì…˜ -->
            <div class="notice-admin glass">
                <h3><i data-lucide="megaphone"></i> ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
                <div class="notice-form">
                    <input type="text" id="notice-title" placeholder="ê³µì§€ì‚¬í•­ ì œëª©" maxlength="50">
                    <textarea id="notice-content" placeholder="ê³µì§€ì‚¬í•­ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 5ì¤„)" rows="5"
                        maxlength="500"></textarea>
                    <div class="notice-actions">
                        <button class="notice-save-btn" id="save-notice-btn">
                            <i data-lucide="save"></i> ê³µì§€ ë“±ë¡
                        </button>
                        <button class="notice-clear-btn" id="clear-notice-btn">
                            <i data-lucide="trash-2"></i> ê³µì§€ ì‚­ì œ
                        </button>
                    </div>
                </div>
                <div class="notice-preview">
                    <p class="preview-label">í˜„ì¬ ë“±ë¡ëœ ê³µì§€:</p>
                    <div id="notice-preview-content">ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                </div>
            </div>
        </div>
    </section>

    <style>
        .page {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .ai-card h2 {
            margin: 1.5rem 0 1rem;
            font-size: 1.25rem;
        }

        .recommendation-list {
            list-style: none;
        }

        .recommendation-list li {
            display: flex;
            gap: 1rem;
            align-items: start;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            width: fit-content;
        }

        .ai-status.healthy {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary-color);
        }

        .ai-status.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-color);
        }

        .ai-status.danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .ai-analysis h3 {
            margin-bottom: 1rem;
            color: var(--text-muted);
        }

        .prediction-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }

        .progress-bar-container {
            background: rgba(255, 255, 255, 0.1);
            height: 12px;
            border-radius: 6px;
            margin: 1.5rem 0 0.5rem;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            width: 0;
            transition: width 1s ease;
        }

        .progress-text {
            font-size: 0.875rem;
            color: var(--text-muted);
        }
    </style>
    </div>
    </main>
    </div>
    <script src="firebase_config.js?v=fix3"></script>
    <script src="auth.js?v=fix3"></script>
    <script src="app.js?v=fix3"></script>
    <script>
        // Start Lucide
        lucide.createIcons();

        // [AUTO LOGIN] Enforce Premium Login as per User Request
        // ì´ ì½”ë“œëŠ” ì‚¬ìš©ìì˜ 'í”„ë¦¬ë¯¸ì—„ ë¡œê·¸ì¸' ìš”ì²­ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.
        if (!localStorage.getItem('smartfarm_user') || JSON.parse(localStorage.getItem('smartfarm_user')).role !== 'premium') {
            const premiumUser = {
                id: 'premium_vip',
                name: 'VIP ë†ë¶€',
                role: 'premium',
                farmName: 'ê³¨ë“œ í´ë˜ìŠ¤ ë†ì¥'
            };
            localStorage.setItem('smartfarm_user', JSON.stringify(premiumUser));
            console.log('âœ… í”„ë¦¬ë¯¸ì—„ ê³„ì •ìœ¼ë¡œ ìë™ ë¡œê·¸ì¸ ì„¤ì •ë¨');
        }

        // [System] Guaranteed Analysis Engine (Embedded)
        document.addEventListener('DOMContentLoaded', () => {
            // [New] Dashboard Mode Switcher (Basic vs Premium)
            const navItems = document.querySelectorAll('.nav-item[data-page="dashboard"]');
            const premiumSection = document.querySelector('.premium-only');
            const mainTitle = document.querySelector('.monitor-header h2');
            const formTitle = document.querySelector('.form-section h5');

            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    // Check Mode
                    const mode = item.getAttribute('data-mode');

                    // [New] Premium Access Control
                    if (mode === 'premium') {
                        // Check if user is logged in (using localStorage from auth.js)
                        const user = JSON.parse(localStorage.getItem('smartfarm_user'));
                        // [Unlocked] ìœ ë£Œ, êµ¬ë… ì‹œìŠ¤í…œ í•´ì œ (ëˆ„êµ¬ë‚˜ ì ‘ê·¼ ê°€ëŠ¥)
                        // const isPaidUser = user && (user.role === 'admin' || user.role === 'premium');
                        // if (!isPaidUser) {
                        //     e.preventDefault();
                        //     alert('ğŸš« í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤.\n\në¡œê·¸ì¸ í›„ ì´ìš©í•˜ì‹œê±°ë‚˜ ìœ ë£Œ ì„œë¹„ìŠ¤ë¥¼ í™œì„±í™”í•´ì£¼ì„¸ìš”.');
                        //     return;
                        // }
                    }

                    // [New] Reset Dashboard View on Menu Click
                    // ë©”ë‰´ ì´ë™ ì‹œ ë¶„ì„ ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì—¬ 'ê¸°ë³¸ í™”ë©´' ìƒíƒœë¡œ ë¦¬ì…‹
                    const solutionList = document.querySelector('.solution-card-list');
                    const nutrientInfo = document.querySelector('.nutrient-target-info');
                    const nutrientBadge = document.querySelector('.nutrient-status-badge');

                    if (solutionList) {
                        solutionList.innerHTML = `
                            <li style="color: #94a3b8; text-align: center; padding: 30px 10px; font-size: 0.95em;">
                                <div style="margin-bottom: 10px; font-size: 2em; opacity: 0.5;">ğŸ“Š</div>
                                ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  
                                <span style="color:#10b981; font-weight:bold;">[í†µí•© ë¶„ì„ ë° ë°ì´í„° ë°˜ì˜]</span> 
                                ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
                            </li>
                        `;
                    }
                    if (nutrientInfo) nutrientInfo.innerHTML = '';
                    if (nutrientBadge) nutrientBadge.style.display = 'none';

                    // [NEW] ëª¨ë“  ì…ë ¥ í•„ë“œ ì´ˆê¸°í™” (í¼ ë¦¬ì…‹)
                    const form = document.getElementById('manual-data-form');
                    if (form) form.reset();

                    // [NEW] ì–‘ì•¡ ë¶„ì„ ê²°ê³¼ ì¹´ë“œë„ ì´ˆê¸°í™”
                    const nutrientCard = document.getElementById('nutrient-solution-card');
                    if (nutrientCard) {
                        nutrientCard.classList.add('hidden');
                        const nutrientList = document.getElementById('nutrient-solution-list');
                        if (nutrientList) {
                            nutrientList.innerHTML = '<li class="no-solution">ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê³  ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”.</li>';
                        }
                    }

                    // [NEW] ìˆ˜í™•ëŸ‰ ì˜ˆì¸¡ ì´ˆê¸°í™”
                    const yieldAmount = document.getElementById('yield-amount');
                    if (yieldAmount) yieldAmount.value = '';
                    const wholesaleRev = document.getElementById('wholesale-revenue');
                    const retailRev = document.getElementById('retail-revenue');
                    if (wholesaleRev) wholesaleRev.textContent = '--';
                    if (retailRev) retailRev.textContent = '--';

                    // 1. Activate Menu
                    document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
                    item.classList.add('active');

                    // 2. Switch Mode UI
                    const premiumSection = document.querySelector('.premium-only');
                    const premiumBanner = document.getElementById('premium-banner');
                    const basicSelectors = document.querySelector('.crop-selector-group'); // Basic selectors
                    const envSection = document.querySelector('.form-section'); // Environment section

                    if (mode === 'premium') {
                        // Premium Mode: Show Nutrient Section, Hide Basic Selectors (to match screenshot)
                        console.log('ğŸ’ í”„ë¦¬ë¯¸ì—„ ëª¨ë“œ í™œì„±í™” (index.html)');

                        // [FIX] .hidden í´ë˜ìŠ¤ ì œê±° í›„ ì¸ë¼ì¸ ìŠ¤íƒ€ì¼ë„ ì œê±° (CSS !important íšŒí”¼)
                        if (premiumSection) {
                            premiumSection.classList.remove('hidden');
                            premiumSection.style.display = ''; // ë¹ˆ ê°’ìœ¼ë¡œ CSS ê¸°ë³¸ê°’ ì‚¬ìš©
                            console.log('âœ… ì–‘ì•¡ ì„¹ì…˜ í‘œì‹œ:', premiumSection);
                        }

                        // ëª¨ë“  premium-only ìš”ì†Œ í‘œì‹œ
                        document.querySelectorAll('.premium-only').forEach(el => {
                            el.classList.remove('hidden');
                            el.style.display = '';
                            console.log('âœ… premium-only ìš”ì†Œ í‘œì‹œ');
                        });

                        if (mainTitle) mainTitle.textContent = 'í”„ë¦¬ë¯¸ì—„ ì •ë°€ ê´€ì œ (Premium)';

                        // Hide Basic Selectors to avoid duplication (Premium uses its own crop selector)
                        if (basicSelectors) {
                            basicSelectors.style.display = 'none';
                        }

                        // Hide Banner
                        if (premiumBanner) {
                            premiumBanner.style.display = 'none';
                        }
                    } else {
                        // Basic Mode: Show Basic Selectors, Hide Nutrient Section
                        console.log('ğŸŒ¿ ë² ì´ì§ ëª¨ë“œ í™œì„±í™” (index.html)');

                        // [FIX] ëª¨ë“  premium-only ìš”ì†Œ ìˆ¨ê¹€
                        document.querySelectorAll('.premium-only').forEach(el => {
                            el.classList.add('hidden');
                            console.log('âœ… premium-only ìš”ì†Œ ìˆ¨ê¹€');
                        });

                        if (mainTitle) mainTitle.textContent = 'ìŠ¤ë§ˆíŠ¸ íŒœ í†µí•© ê´€ì œ (Basic)';

                        // Show Basic Selectors
                        if (basicSelectors) {
                            basicSelectors.style.display = 'flex';
                        }

                        // Show Banner
                        if (premiumBanner) {
                            premiumBanner.style.display = 'flex';
                        }
                    }
                });
            });

            // [CLEAN] ëª¨ë“  ì¸ë¼ì¸ ë¶„ì„ ì½”ë“œ ì œê±°ë¨
            // app.jsì˜ initManualEntry() í•¨ìˆ˜ê°€ ëª¨ë“  ë¶„ì„ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            // (ì‘ë¬¼ ì„ íƒ â†’ ì–‘ì•¡í‘œì¤€ ì„ íƒ â†’ í™˜ê²½ì •ë³´ ì…ë ¥ â†’ ë²„íŠ¼ í´ë¦­ â†’ ê²°ê³¼ ì¶œë ¥)

            console.log("âœ… ë¶„ì„ ë¡œì§ì€ app.jsì—ì„œ ì²˜ë¦¬ë©ë‹ˆë‹¤ (initManualEntry)");

            /*
            // [ì œê±°ëœ ë³µì¡í•œ ì¸ë¼ì¸ ì½”ë“œ]
            // ëª¨ë“  ë³µì¡í•œ ë¶„ì„ ë¡œì§ì€ app.jsì˜ initManualEntry()ê°€ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            // (ì œê±°ë¨)
            */

            // [New] Unlock Premium Membership Feature
            const unlockBtn = document.getElementById('unlock-premium-btn');
            if (unlockBtn) {
                unlockBtn.addEventListener('click', () => {
                    // 1. Check Login
                    const userStr = localStorage.getItem('smartfarm_user');

                    if (!userStr) {
                        // If not logged in, simulate login or ask to login
                        const doLogin = confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ì¦‰ì‹œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                        if (doLogin) {
                            const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                            localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                            alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì´ì œ Premium Dashboardì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                            window.location.reload();
                        }
                        return;
                    }

                    // 2. Process Payment (Simulation)
                    const user = JSON.parse(userStr);
                    if (user.role === 'premium' || user.role === 'admin') {
                        alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš© ì¤‘ì…ë‹ˆë‹¤.');
                        return;
                    }

                    const confirmed = confirm('ğŸ’ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ (ì›” 9,900ì›)\n\nì •ë°€ í™˜ê²½ ì œì–´, ì–‘ì•¡ í†µí•© ë¶„ì„, RTS ì•Œê³ ë¦¬ì¦˜ ë“± ëª¨ë“  ê³ ê¸‰ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');

                    if (confirmed) {
                        // 3. Update Role
                        user.role = 'premium';
                        localStorage.setItem('smartfarm_user', JSON.stringify(user));

                        alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’³\n\nì´ì œ [Premium Dashboard]ì˜ ëª¨ë“  ê¸°ëŠ¥ì„ ì œí•œ ì—†ì´ ì´ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                        window.location.reload(); // Reload to reflect changes
                    }
                });
            }
        });
        // [Hotfix] Override Premium Unlock Logic & Auto Redirect
        // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì œê±°í•˜ê³  ìƒˆë¡œìš´ ë¡œì§ì„ ì ìš©í•˜ê¸° ìœ„í•´ ìš”ì†Œ ë³µì œ ë° êµì²´
        const oldUnlockBtn = document.getElementById('unlock-premium-btn');
        if (oldUnlockBtn) {
            const newUnlockBtn = oldUnlockBtn.cloneNode(true);
            oldUnlockBtn.parentNode.replaceChild(newUnlockBtn, oldUnlockBtn);

            newUnlockBtn.addEventListener('click', () => {
                const userStr = localStorage.getItem('smartfarm_user');

                // 1. Not Logged In
                if (!userStr) {
                    const doLogin = confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ì¦‰ì‹œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                    if (doLogin) {
                        const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                        localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                        localStorage.setItem('auto_redirect_premium', 'true');
                        alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤. ğŸš€');
                        window.location.reload();
                    }
                    return;
                }

                // 2. Already Premium
                const user = JSON.parse(userStr);
                if (user.role === 'premium' || user.role === 'admin') {
                    const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                    if (premiumNav) {
                        alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ì„œë¹„ìŠ¤ë¥¼ ì´ìš© ì¤‘ì´ì‹­ë‹ˆë‹¤.\n\n[Premium Dashboard]ë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤! ğŸš€');
                        premiumNav.click();
                    }
                    return;
                }

                // 3. Upgrade Payment
                const confirmed = confirm('ğŸ’ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ (ì›” 9,900ì›)\n\nì •ë°€ í™˜ê²½ ì œì–´, ì–‘ì•¡ í†µí•© ë¶„ì„, RTS ì•Œê³ ë¦¬ì¦˜  ê³ ê¸‰ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (confirmed) {
                    user.role = 'premium';
                    localStorage.setItem('smartfarm_user', JSON.stringify(user));
                    localSto('auto_redirect_premium', 'true');
                    alert('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’³\n\nëª¨ë“  ì œí•œì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                    window.location.reload();
                }
            });
        }

        // [Auto Redirect System]
        if (localStorage.getItem('auto_redirect_premium') === 'true') {
            localStorage.removeItem('auto_redirect_premium'); // Clear flag
            setTimeout(() => {
                const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                if (premiumNav) {
                    console.log('ğŸš€ Auto Redirecting to Premium Dashboard...');
                    premiumNav.click();
                }
            }, 500);
        }
    </script>
    <!-- [Payment Modal System] -->
    <style>
        /* Payment Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .payment-modal {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid #334155;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            padding: 0;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            animation: modalFadeIn 0.3s ease-out;
            color: white;
            font-family: 'Pretendard', sans-serif;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .payment-header {
            padding: 25px;
            background: linear-gradient(to right, #6366f1, #4f46e5);
            text-align: center;
        }

        .payment-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .payment-body {
            padding: 30px 25px;
        }

        .plan-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .plan-card:hover,
        .plan-card.selected {
            background: rgba(99, 102, 241, 0.1);
            border-color: #6366f1;
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        .plan-price {
            font-size: 1.2em;
            font-weight: bold;
            color: #a5b4fc;
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 0.9em;
            color: #94a3b8;
        }

        .feature-list li {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .payment-footer {
            padding: 20px 25px;
            background: rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .pay-btn {
            background: #6366f1;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(99, 102, 241, 0.4);
        }

        .pay-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.6);
        }

        .processing-view {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px 0;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>

    <!-- PortOne SDK -->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <div id="paymentModalOverlay" class="modal-overlay">
        <div class="payment-modal">
            <!-- Step 1: Selection -->
            <div id="paymentStep1">
                <div class="payment-header">
                    <h3>ğŸ’ Premium ë©¤ë²„ì‹­</h3>
                    <p style="margin:5px 0 0 0; opacity:0.8; font-size:0.9em;">ì •ë°€ ë†ì—…ì„ ìœ„í•œ ìµœê³ ì˜ ì„ íƒ</p>
                </div>
                <div class="payment-body">
                    <div class="plan-card selected">
                        <div>
                            <div style="font-weight:bold; font-size:1.1em; color:white;">Month Plan</div>
                            <div style="font-size:0.85em; color:#94a3b8; margin-top:4px;">ë§¤ì›” ìë™ ê²°ì œ</div>
                        </div>
                        <div class="plan-price" style="color:#fcd34d;">â‚©4,900 /ì›” <span
                                style="font-size:0.6em; text-decoration:line-through; color:#64748b;">(â‚©9,900)</span>
                        </div>
                    </div>
                    <ul class="feature-list">
                        <li>âœ… <strong>RTS ê¸°ë°˜</strong> í†µí•© ì •ë°€ ë¶„ì„ ì•Œê³ ë¦¬ì¦˜</li>
                        <li>âœ… ì‘ë¬¼ë³„/ìƒìœ¡ë‹¨ê³„ë³„ <strong>ë§ì¶¤ ì²˜ë°©</strong></li>
                        <li>âœ… <strong>ë¬´ì œí•œ</strong> ë°ì´í„° ì €ì¥ ë° ë¦¬í¬íŠ¸</li>
                        <li>âœ… ìš°ì„  ê¸°ìˆ  ì§€ì› (VIP Support)</li>
                    </ul>
                </div>
                <div class="payment-footer">
                    <button class="pay-btn" id="confirmPaymentBtn">êµ¬ë… ì‹œì‘í•˜ê¸°</button>
                    <button style="background:none; border:none; color:#64748b; margin-top:10px; cursor:pointer;"
                        onclick="document.getElementById('paymentModalOverlay').style.display='none'; const basicNav = document.querySelector('.nav-item[data-mode=\'basic\']'); if(basicNav) basicNav.click();">ë‹«ê¸°</button>
                </div>
            </div>

            <!-- Step 2: Processing -->
            <div id="paymentStep2" class="processing-view">
                <div class="spinner"></div>
                <h4 style="margin:0; font-size:1.2em;">ê²°ì œ ì²˜ë¦¬ ì¤‘...</h4>
                <p style="color:#94a3b8; font-size:0.9em;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>

            <!-- Step 3: Success -->
            <div id="paymentStep3" class="processing-view">
                <div style="font-size:3em; margin-bottom:15px;">ğŸ‰</div>
                <h4 style="margin:0; font-size:1.2em; color:#10b981;">êµ¬ë… ì™„ë£Œ!</h4>
                <p style="color:#94a3b8; font-size:0.9em; text-align:center;">í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>
    <script>
        // [Final Override] Payment Modal Logic
        // ì´ì „ì˜ ëª¨ë“  ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë¬´ì‹œí•˜ê³  ëª¨ë‹¬ ë¡œì§ì„ ìµœìš°ì„ ìœ¼ë¡œ ì ìš©í•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                if (btn) {
                    // Remove previous listeners by cloning one last time
                    const finalBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalBtn, btn);

                    finalBtn.addEventListener('click', () => {
                        const userStr = localStorage.getItem('smartfarm_user');

                        // 1. Login Check
                        if (!userStr) {
                            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                                localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                                localStorage.setItem('auto_redirect_premium', 'true');
                                alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            }
                            return;
                        }

                        // 2. Already Premium Check
                        const user = JSON.parse(userStr);
                        if (user.role === 'premium' || user.role === 'admin') {
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) {
                                alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ğŸ’\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                                premiumNav.click();
                            }
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset UI state
                            document.getElementById('paymentStep1').style.display = 'block';
                            document.getElementById('paymentStep2').style.display = 'none';
                            document.getElementById('paymentStep3').style.display = 'none';

                            // Payment Action
                            const payBtn = document.getElementById('confirmPaymentBtn');
                            payBtn.onclick = () => {
                                // Switch to Processing
                                document.getElementById('paymentStep1').style.display = 'none';
                                document.getElementById('paymentStep2').style.display = 'flex';

                                // Simulate API Call (2s)
                                setTimeout(() => {
                                    // Success Layout
                                    document.getElementById('paymentStep2').style.display = 'none';
                                    document.getElementById('paymentStep3').style.display = 'flex';

                                    // Execute Upgrade
                                    user.role = 'premium';
                                    localStorage.setItem('smartfarm_user', JSON.stringify(user)); localStorage.setItem('auto_redirect_premium', 'true');

                                    // Redirect
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                }, 2000);
                            };
                        } else {
                            // Modal not found fallback
                            if (confirm('ê²°ì œ ëª¨ë“ˆ ì˜¤ë¥˜. ê°•ì œ ì—…ê·¸ë ˆì´ë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                user.role = 'premium';
                                localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                window.location.reload();
                            }
                        }
                    });
                }
            }, 200); // Delay to ensure DOM is ready and previous scripts ran
        });
    </script>
    <script>
        // [Real Payment Override] PortOne Integration (Test Mode)
        // ì‹¤ì œ ê²°ì œ ëª¨ë“ˆ(ì•„ì„í¬íŠ¸)ì„ ì—°ë™í•˜ì—¬ PGì‚¬ ê²°ì œì°½ì„ í˜¸ì¶œí•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                const paymentBtn = document.getElementById('confirmPaymentBtn');

                // 4,900ì› ê°€ê²© ë°˜ì˜ í™•ì¸ ë° ê°•ì œ ìˆ˜ì • (í˜¹ì‹œ ì‹¤íŒ¨í–ˆì„ ê²½ìš° ëŒ€ë¹„)
                const priceEls = document.querySelectorAll('.plan-price');
                priceEls.forEach(el => {
                    if (!el.innerHTML.includes('4,900')) {
                        el.innerHTML = 'â‚©4,900 /ì›” <span style="font-size:0.6em; text-decoration:line-through; color:#64748b;">(â‚©9,900)</span>';
                    }
                });
                if (paymentBtn && !paymentBtn.innerText.includes('4,900')) {
                    paymentBtn.innerText = 'êµ¬ë… ì‹œì‘í•˜ê¸° (4,900ì›)';
                }

                if (btn) {
                    // Remove previous listeners (Clone & Replace)
                    const finalRealBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalRealBtn, btn);

                    finalRealBtn.addEventListener('click', () => {
                        const userStr = localStorage.getItem('smartfarm_user');

                        // 1. Login Check
                        if (!userStr) {
                            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\n\n[í…ŒìŠ¤íŠ¸ ëª¨ë“œ]\nì„ì‹œ ê³„ì •(user/premium)ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                const mockUser = { id: 'test_user', name: 'ê¹€ë†ë¶€', role: 'premium', farmName: 'í¬ë§ ë†ì¥' };
                                localStorage.setItem('smartfarm_user', JSON.stringify(mockUser));
                                localStorage.setItem('auto_redirect_premium', 'true');
                                alert('ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤! í”„ë¦¬ë¯¸ì—„ ë“±ê¸‰ìœ¼ë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                                window.location.reload();
                            }
                            return;
                        }

                        // 2. Already Premium Check
                        const user = JSON.parse(userStr);
                        if (user.role === 'premium' || user.role === 'admin') {
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) {
                                alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ğŸ’\n[Premium Dashboard]ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
                                premiumNav.click();
                            }
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset UI
                            document.getElementById('paymentStep1').style.display = 'block';
                            document.getElementById('paymentStep2').style.display = 'none';
                            document.getElementById('paymentStep3').style.display = 'none';

                            // 4. Real Payment Action (PortOne)
                            const realPayBtn = document.getElementById('confirmPaymentBtn');
                            realPayBtn.onclick = () => {
                                // Hide Plan
                                document.getElementById('paymentStep1').style.display = 'none';

                                // Check SDK
                                if (!window.IMP) {
                                    alert('ê²°ì œ ëª¨ë“ˆì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                                    window.location.reload();
                                    return;
                                }

                                // Init PortOne
                                const IMP = window.IMP;
                                IMP.init('imp14397622'); // Public Test Code for KG, Kakao

                                // Request Pay
                                IMP.request_pay({
                                    pg: 'html5_inicis', // KG Inicis
                                    pay_method: 'card',
                                    merchant_uid: 'mid_' + new Date().getTime(),
                                    name: 'ìŠ¤ë§ˆíŠ¸íŒœ Premium ì›”ê°„ êµ¬ë… (4,900ì›)',
                                    amount: 4900,
                                    buyer_email: 'test@farm.com',
                                    buyer_name: user.name,
                                    buyer_tel: '010-1234-5678',
                                }, function (rsp) {
                                    if (rsp.success) {
                                        // Success Layout
                                        document.getElementById('paymentStep2').style.display = 'flex';

                                        setTimeout(() => {
                                            // Upgrade
                                            user.role = 'premium';
                                            localStorage.setItem('smartfarm_user', JSON.stringify(user));
                                            localStorage.setItem('auto_redirect_premium', 'true');


                                            document.getElementById('paymentStep2').style.display = 'none';
                                            document.getElementById('paymentStep3').style.display = 'flex';

                                            // Redirect
                                            setTimeout(() => { window.location.reload(); }, 1500);
                                        }, 1000);
                                    } else {
                                        // Fail
                                        alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
                                        document.getElementById('paymentStep1').style.display = 'block';
                                    }
                                });
                            };
                        }
                    });
                }
            }, 500); // Override all previous logic
        });
    </script>
    <script>
        // [Hotfix] Force Logout Handler
        // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì´ ì œëŒ€ë¡œ ë™ì‘í•˜ì§€ ì•ŠëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ì´ë²¤íŠ¸ë¥¼ ê°•ì œë¡œ ì¬í• ë‹¹í•©ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    console.log("Found logout button, attaching force handler.");

                    // Remove existing listeners by cloning
                    const newLogoutBtn = logoutBtn.cloneNode(true);
                    logoutBtn.parentNode.replaceChild(newLogoutBtn, logoutBtn);

                    newLogoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log("Logout clicked.");

                        // 1. Firebase SignOut
                        if (typeof firebase !== 'undefined') {
                            firebase.auth().signOut().then(() => {
                                console.log("Firebase signed out successfully.");
                                clearLocalAndRedirect();
                            }).catch((err) => {
                                console.error("Firebase signout failed:", err);
                                clearLocalAndRedirect();
                            });
                        } else {
                            // 2. Local Only
                            clearLocalAndRedirect();
                        }
                    });
                }
            }, 800); // Wait for other scripts to initialize
        });

        function clearLocalAndRedirect() {
            sessionStorage.clear();
            localStorage.removeItem('currentUser');
            // 'users'ëŠ” ì§€ìš°ì§€ ì•ŠìŒ (ë¡œì»¬ ê°€ì… ë°ì´í„° ìœ ì§€)
            window.location.href = 'login.html';
        }
    </script>
    <script>
        // [Final Payment Logic] 
        // ì´ì „ì˜ ê²°ì œ ìŠ¤í¬ë¦½íŠ¸ë“¤ì´ ì˜ëª»ëœ í‚¤(smartfarm_user)ë¥¼ ì‚¬ìš©í•˜ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
        // ê°€ì¥ ë§ˆì§€ë§‰ì— ì‹¤í–‰ë˜ì–´ ì˜¬ë°”ë¥¸ ë¡œì§(currentUser, Firestore ì—°ë™)ìœ¼ë¡œ ë®ì–´ì”Œì›ë‹ˆë‹¤.
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const btn = document.getElementById('unlock-premium-btn');
                if (btn) {
                    console.log("Applying Final Payment Logic...");
                    const finalBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(finalBtn, btn);

                    finalBtn.addEventListener('click', () => {
                        // 1. Get User (Standard Key from auth.js)
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');

                        if (!userStr) {
                            if (confirm('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.\në¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                window.location.href = 'login.html';
                            }
                            return;
                        }

                        const user = JSON.parse(userStr);

                        // 2. Already Premium Check
                        if (user.role === 'premium' || user.role === 'admin') {
                            alert('ì´ë¯¸ í”„ë¦¬ë¯¸ì—„ ë©¤ë²„ì‹­ì„ ì´ìš© ì¤‘ì…ë‹ˆë‹¤. ğŸ’');
                            const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                            if (premiumNav) premiumNav.click();
                            return;
                        }

                        // 3. Open Payment Modal
                        const modal = document.getElementById('paymentModalOverlay');
                        if (modal) {
                            modal.style.display = 'flex';

                            // Reset Steps
                            const step1 = document.getElementById('paymentStep1');
                            const step2 = document.getElementById('paymentStep2');
                            const step3 = document.getElementById('paymentStep3');
                            if (step1) step1.style.display = 'block';
                            if (step2) step2.style.display = 'none';
                            if (step3) step3.style.display = 'none';

                            // 4. Handle Payment
                            const payBtn = document.getElementById('confirmPaymentBtn');
                            if (payBtn) {
                                // Ensure price text
                                if (!payBtn.innerText.includes('4,900')) payBtn.innerText = 'êµ¬ë… ì‹œì‘í•˜ê¸° (4,900ì›)';

                                payBtn.onclick = () => {
                                    if (step1) step1.style.display = 'none';

                                    if (!window.IMP) {
                                        alert('ê²°ì œ ëª¨ë“ˆ ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.');
                                        return;
                                    }

                                    const IMP = window.IMP;
                                    IMP.init('imp14397622');

                                    IMP.request_pay({
                                        pg: 'html5_inicis',
                                        pay_method: 'card',
                                        merchant_uid: 'mid_' + new Date().getTime(),
                                        name: 'ìŠ¤ë§ˆíŠ¸íŒœ Premium (4,900ì›)',
                                        amount: 4900,
                                        buyer_email: user.email,
                                        buyer_name: user.name,
                                    }, function (rsp) {
                                        if (rsp.success) {
                                            if (step2) step2.style.display = 'flex'; // Processing...

                                            // Upgrade Logic
                                            setTimeout(() => {
                                                user.role = 'premium';
                                                localStorage.setItem('currentUser', JSON.stringify(user));
                                                if (sessionStorage.getItem('currentUser')) {
                                                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                                                }
                                                // Auto Redirect Flag
                                                localStorage.setItem('auto_redirect_premium', 'true');

                                                // â˜… Firestore Update â˜…
                                                if (typeof firebase !== 'undefined' && firebase.firestore && user.uid) {
                                                    firebase.firestore().collection('users').doc(user.uid).update({
                                                        role: 'premium'
                                                    }).then(() => console.log("DB Updated"));
                                                }

                                                if (step2) step2.style.display = 'none';
                                                if (step3) step3.style.display = 'flex'; // Success

                                                setTimeout(() => { window.location.reload(); }, 1500);
                                            }, 1000);
                                        } else {
                                            alert('ê²°ì œ ì‹¤íŒ¨: ' + rsp.error_msg);
                                            if (step1) step1.style.display = 'block';
                                        }
                                    });
                                };
                            }
                        }
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <script>
        // [New] Premium Nav Click -> Auto Trigger Payment
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const premiumNav = document.querySelector('.nav-item[data-mode="premium"]');
                const unlockBtn = document.getElementById('unlock-premium-btn');

                if (premiumNav && unlockBtn) {
                    console.log("Attaching Premium Nav Auto-Trigger");
                    av.addEventListener('click', (e) => {
                        // Check User Role
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                        if (userStr) {
                            const user = JSON.parse(userStr);
                            // If Basic user clicks Premium, trigger the payment modal
                            if (user.role !== 'premium' && user.role !== 'admin') {
                                console.log("Basic User detected on Premium Tab -> Triggering Payment Modal");
                                setTimeout(() => {
                                    unlockBtn.click();
                                }, 300); // Small delay to let tab switch visually update first
                            }
                        }
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <script>
        // [New] Basic Nav Click -> Reset View
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const basicNav = document.querySelector('.nav-item[data-mode="basic"]');
                if (basicNav) {
                    console.log("Attaching Basic Nav View Reset Listener");
                    basicNav.addEventListener('click', (e) => {
                        console.log("Resetting to Basic View...");
                        // Hide Premium Fields
                        document.querySelectorAll('.premium-only').forEach(el => el.classList.add('hidden'));
                        // Relock Cards
                        document.querySelectorAll('.premium-locked').forEach(el => el.classList.remove('unlocked'));
                        // Reset Form Styles
                        document.querySelectorAll('.entry-form').forEach(el => el.classList.remove('pactive'));

                        // Show Banner if user is Basic
                        const premiumBanner = document.getElementById('premium-banner');
                        let userStr = localStorage.getItem('currentUser') || sessionStorage.getItem('currentUser');
                        let isPremium = false;
                        if (userStr) {
                            const user = JSON.parse(userStr);
                            if (user.role === 'premium' || user.role === 'admin') isPremium = true;
                        }

                        if (premiumBanner && !isPremium) {
                            premiumBanner.classList.remove('hidden');
                        }

                        // Scroll to Top
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    });
                }
            }, 50); // Immediate execution
        });
    </script>
    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="#" class="bottom-nav-item active nav-item" data-page="dashboard" data-mode="basic">
            <i data-lucide="layout-dashboard"></i>
            <span>Basic</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item" data-page="dashboard" data-mode="premium">
            <i data-lucide="crown"></i>
            <span>Premium</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item" data-page="ai-solution">
            <i data-lucide="brain-circuit"></i>
            <span>AI</span>
        </a>
        <a href="#" class="bottom-nav-item nav-item hidden" data-page="admin" id="admin-nav-mobile">
            <i data-lucide="map"></i>
            <span>Map</span>
        </a>
        <a href="#" class="bottom-nav-item" onclick="logout()">
            <i data-lucide="log-out"></i>
            <span>Logout</span>
        </a>
    </nav>
</body>

</html>